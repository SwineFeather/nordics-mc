import{r as d,s as f,ay as Be,ax as ze,j as e,o as ve,b0 as Me,v as k,aJ as je,p as be,q as we,t as Ne,bc as He,aT as de,aA as Je,O as x,X as y,b1 as Ve,Z as I,$ as R,a0 as U,a1 as B,a2 as L,aI as Ce,b5 as Se,bk as Ye,aY as We,aZ as Ge,a_ as Xe,a$ as Ze,H as Qe,aF as S,Y as Ke}from"./index-BDwxLbfg.js";import{u as De}from"./usePlayerSearch-6-rZ-bFC.js";import{P as es}from"./playerTownService-Cn9WKRSh.js";const ss=()=>{const[b,r]=d.useState([]),[u,w]=d.useState(!0),[q,N]=d.useState(null);return d.useEffect(()=>{(async()=>{try{w(!0),N(null);const{data:o,error:l}=await f.from("towns").select("*").order("name");if(l)throw l;r(o||[])}catch(o){console.error("Error fetching towns:",o),N(o instanceof Error?o.message:"Failed to fetch towns")}finally{w(!1)}})()},[]),{towns:b,loading:u,error:q}},rs=["Mining","Farming","Trading","Manufacturing","Construction","Technology","Entertainment","Transportation","Healthcare","Education","Real Estate","Finance","Food & Beverage","Fashion","Automotive","Energy","Telecommunications","Media","Tourism","Consulting","Conglomerate","Holding Company","Landscaping"],ns=["Sole Proprietorship","Partnership","Corporation","LLC","Cooperative","Franchise","Enterprise","Group","Holding Company"],ce={"Sole Proprietorship":"One owner, unlimited liability.",Partnership:"Multiple owners, shared liability.",Corporation:"Legal entity, limited liability, complex structure.",LLC:"Limited liability, flexible structure.",Cooperative:"Owned by members for mutual benefit.",Franchise:"Business model using another's brand.",Enterprise:"Large-scale business operation.",Group:"Collection of related companies.","Holding Company":"Owns other companies' stocks to control them."},ls=["Overworld","Nether","End","Multiple Worlds"],ts=`
Company Creation Level Requirements:

- Level 5: Create your first company
- Level 10: Create your second company
- Level 20: Create your third company
- Level 25, 30, ... 100: Each additional company requires 5 more levels (capped at 100)
- Enterprise: Always requires at least level 15

- Admins are exempt from level requirements and can create unlimited companies
`,ps=({onCompanyCreated:b,initialData:r,isEditMode:u,onClose:w,onCompanyUpdated:q,open:N,onOpenChange:P})=>{var ye,_e,ge;const{user:o,profile:l}=Be(),{companies:T}=ze(),{towns:z}=ss(),[K,G]=d.useState(!!u),X=N!==void 0?N:K,M=P||G,[F,$]=d.useState(!1),[c,Z]=d.useState(null),[ie,ue]=d.useState(null),[D,me]=d.useState([]),[Le,ee]=d.useState(!1),[se,re]=d.useState(null),[H,ne]=d.useState((r==null?void 0:r.banner_url)||null),[le,pe]=d.useState(""),[ds,ke]=d.useState(null),[qe,he]=d.useState(!1),[n,J]=d.useState({name:(r==null?void 0:r.name)||"",tagline:(r==null?void 0:r.tagline)||"",description:(r==null?void 0:r.description)||"",website_url:(r==null?void 0:r.website_url)||"",email:(r==null?void 0:r.email)||"",discord_invite:(r==null?void 0:r.discord_invite)||"",business_type:(r==null?void 0:r.business_type)||"",industry:(r==null?void 0:r.industry)||"",headquarters_world:(r==null?void 0:r.headquarters_world)||"",headquarters_coords:(r==null?void 0:r.headquarters_coords)||"",parent_company_id:(r==null?void 0:r.parent_company_id)||"independent",town_id:(r==null?void 0:r.town_id)||"none",primary_color:(r==null?void 0:r.primary_color)||"#1E40AF",secondary_color:(r==null?void 0:r.secondary_color)||"#F59E0B",staff:(r==null?void 0:r.staff)||[]}),[O,Fe]=d.useState(null),[V,Ee]=d.useState(0),[cs,Te]=d.useState(5),[xe,Y]=d.useState(null),[$e,W]=d.useState(!0),[Pe,Oe]=d.useState(""),[Ae,Ie]=d.useState([]),fe=T.filter(s=>s.business_type==="Enterprise"||s.business_type==="Group"||s.business_type==="Holding Company"),te=async()=>{if(u&&(r!=null&&r.id)){const{data:s,error:a}=await f.from("company_staff").select("user_uuid, role").eq("company_id",r.id);if(!a&&s){const t=s.map(p=>p.user_uuid);let m={};if(t.length>0){const{data:p}=await f.from("profiles").select("id, full_name").in("id",t);p&&(m=Object.fromEntries(p.map(C=>[C.id,C.full_name])))}me(s.map(p=>({user_uuid:p.user_uuid,displayName:m[p.user_uuid]||"",role:p.role})))}else me([])}};d.useEffect(()=>{te()},[u,r==null?void 0:r.id]),d.useEffect(()=>{l!=null&&l.minecraft_username&&es.getPlayerTownData(l.minecraft_username).then(ke)},[l==null?void 0:l.minecraft_username]),d.useEffect(()=>{(async()=>{if(!o)return;const a=(l==null?void 0:l.role)==="admin";let t=null,m=[],p=[];if(l!=null&&l.minecraft_username){const j=l.minecraft_username.trim(),{data:g}=await f.from("players").select("level").ilike("name",j).single();m.push("minecraft_username"),p.push(`Tried minecraft_username: ${j} → ${g?JSON.stringify(g):"not found"}`),g&&typeof g.level=="number"&&(t=g.level)}if(t===null&&(l!=null&&l.full_name)){const j=l.full_name.trim(),{data:g}=await f.from("players").select("level").ilike("name",j).single();m.push("full_name"),p.push(`Tried full_name: ${j} → ${g?JSON.stringify(g):"not found"}`),g&&typeof g.level=="number"&&(t=g.level)}if(t===null){const{data:j}=await f.from("players").select("level").eq("uuid",o.id).single();m.push("uuid"),p.push(`Tried uuid: ${o.id} → ${j?JSON.stringify(j):"not found"}`),j&&typeof j.level=="number"&&(t=j.level)}Fe(t),Oe(p.join(`
`)),Ie(m);const C=T.filter(j=>j.owner_uuid===o.id).length;Ee(C),a&&(Y(null),W(!0))})()},[o,T,l==null?void 0:l.minecraft_username,l==null?void 0:l.full_name,l==null?void 0:l.role]),d.useEffect(()=>{if((l==null?void 0:l.role)==="admin"){Y(null),W(!0);return}let a=5;if(V===0?a=5:V===1?a=10:V===2?a=20:a=5+V*5,a>100&&(a=100),Te(a),n.business_type==="Enterprise"&&(O??1)<15){Y("You must be at least level 15 to create an Enterprise."),W(!1);return}if((O??1)<a){Y(`You need to be at least level ${a} to create your next company. (Current level: ${O??1})`),W(!1);return}Y(null),W(!0)},[n.business_type,O,V,l==null?void 0:l.role]),r&&l&&(r.owner_uuid===(o==null?void 0:o.id)||r.owner_minecraft_username&&(r.owner_minecraft_username.toLowerCase(),(ye=l.minecraft_username)==null||ye.toLowerCase())),D.some(s=>{var a;return s.user_uuid===(o==null?void 0:o.id)||s.minecraft_username&&s.minecraft_username.toLowerCase()===((a=l.minecraft_username)==null?void 0:a.toLowerCase())});const _=(s,a)=>{J(t=>({...t,[s]:a}))},Re=s=>{var t;const a=(t=s.target.files)==null?void 0:t[0];if(a){Z(a);const m=new FileReader;m.onload=p=>{var C;return ue((C=p.target)==null?void 0:C.result)},m.readAsDataURL(a)}},Ue=async s=>{if(s.preventDefault(),!o){S.error("You must be logged in to create a company");return}if(!n.name||!n.business_type||!n.industry){S.error("Please fill in all required fields");return}$(!0);try{const a=(l==null?void 0:l.role)==="admin";let t=null,m=[],p=[];if(l!=null&&l.minecraft_username){const i=l.minecraft_username.trim(),{data:h}=await f.from("players").select("level").ilike("name",i).single();m.push("minecraft_username"),p.push(`Tried minecraft_username: ${i} → ${h?JSON.stringify(h):"not found"}`),h&&typeof h.level=="number"&&(t=h.level)}if(t===null&&(l!=null&&l.full_name)){const i=l.full_name.trim(),{data:h}=await f.from("players").select("level").ilike("name",i).single();m.push("full_name"),p.push(`Tried full_name: ${i} → ${h?JSON.stringify(h):"not found"}`),h&&typeof h.level=="number"&&(t=h.level)}if(t===null){const{data:i}=await f.from("players").select("level").eq("uuid",o.id).single();m.push("uuid"),p.push(`Tried uuid: ${o.id} → ${i?JSON.stringify(i):"not found"}`),i&&typeof i.level=="number"&&(t=i.level)}if(t===null&&!a){S.error(`Could not verify your player level.
`+p.join(`
`)),$(!1);return}const C=t||1,g=T.filter(i=>i.owner_uuid===o.id).length;let E=5;if(g===0?E=5:g===1?E=10:g===2?E=20:E=5+g*5,E>100&&(E=100),!a&&n.business_type==="Enterprise"&&C<15){S.error("You must be at least level 15 to create an Enterprise."),$(!1);return}if(!a&&C<E){S.error(`You need to be at least level ${E} to create your next company. (Current level: ${C})`),$(!1);return}let ae=(r==null?void 0:r.logo_url)||null;if(c){const i=c.name.split(".").pop(),h=`${Date.now()}.${i}`,{data:A,error:v}=await f.storage.from("nation-town-images").upload(`companies/${h}`,c);if(v)throw v;const{data:{publicUrl:oe}}=f.storage.from("nation-town-images").getPublicUrl(`companies/${h}`);ae=oe}let Q=(r==null?void 0:r.banner_url)||null;if(se){const i=se.name.split(".").pop(),h=`banner_${Date.now()}.${i}`,{data:A,error:v}=await f.storage.from("nation-town-images").upload(`companies/${h}`,se);if(v)throw v;const{data:{publicUrl:oe}}=f.storage.from("nation-town-images").getPublicUrl(`companies/${h}`);Q=oe}else H&&H.startsWith("http")&&(Q=H);if(u&&(r!=null&&r.id)){const{error:i}=await f.from("companies").update({name:n.name,tagline:n.tagline,description:n.description,website_url:n.website_url||null,email:n.email||null,discord_invite:n.discord_invite||null,business_type:n.business_type,industry:n.industry,headquarters_world:n.headquarters_world||null,headquarters_coords:n.headquarters_coords||null,parent_company_id:n.parent_company_id==="independent"?null:n.parent_company_id||null,town_id:n.town_id==="none"?null:n.town_id||null,primary_color:n.primary_color,secondary_color:n.secondary_color,logo_url:ae,banner_url:Q,is_public:n.is_public,is_open:n.is_open}).eq("id",r.id);if(i)throw i;S.success("Company updated successfully!"),q&&q(),w&&w();return}if(!u){const{data:i,error:h}=await f.from("companies").insert({name:n.name,slug:n.name.toLowerCase().replace(/[^a-z0-9]/g,"-"),tagline:n.tagline,description:n.description,website_url:n.website_url||null,email:n.email||null,discord_invite:n.discord_invite||null,business_type:n.business_type,industry:n.industry,headquarters_world:n.headquarters_world||null,headquarters_coords:n.headquarters_coords||null,parent_company_id:n.parent_company_id==="independent"?null:n.parent_company_id||null,town_id:n.town_id==="none"?null:n.town_id||null,primary_color:n.primary_color,secondary_color:n.secondary_color,logo_url:ae,banner_url:Q,owner_uuid:o.id,company_type:n.parent_company_id&&n.parent_company_id!=="independent"?"subsidiary":"independent",is_public:n.is_public,is_open:n.is_open,status:"active"}).select().single();if(h)throw h;let A=n.staff.filter(v=>v.user_uuid).map(v=>({company_id:i.id,user_uuid:v.user_uuid,role:v.role.trim(),added_by:o.id}));if(A.some(v=>v.user_uuid===o.id)||A.unshift({company_id:i.id,user_uuid:o.id,role:"Owner",added_by:o.id}),A.length>0){const{error:v}=await f.from("company_staff").insert(A);v&&console.error("Error adding staff:",v)}S.success("Company created successfully!"),M(!1),J({name:"",tagline:"",description:"",website_url:"",email:"",discord_invite:"",business_type:"",industry:"",headquarters_world:"",headquarters_coords:"",parent_company_id:"independent",town_id:"none",primary_color:"#1E40AF",secondary_color:"#F59E0B",staff:[]}),Z(null),ue(null),re(null),ne(null),pe(""),b&&b()}}catch(a){console.error("Error creating company:",a),S.error("Failed to create company. Please try again.")}finally{$(!1)}};return e.jsxs(ve,{open:X,onOpenChange:M,children:[!u&&e.jsx(Me,{asChild:!0,children:e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(je,{className:"w-4 h-4"}),"Create New Company"]})}),e.jsxs(be,{className:"max-w-2xl max-h-[90vh] overflow-hidden",children:[e.jsxs(we,{children:[e.jsx(Ne,{children:u?"Edit Company":"Create New Company"}),e.jsx(He,{children:u?"Update your company details below. All fields are editable.":"Fill out the form below to create your new company. Required fields are marked with an asterisk (*)."}),e.jsx("div",{className:"mt-2",children:qe?e.jsxs("div",{className:"p-3 rounded-md bg-blue-50 border border-blue-200 flex items-start gap-2 text-sm text-blue-900 relative",children:[e.jsx(de,{className:"w-5 h-5 mt-0.5 text-blue-500 shrink-0"}),e.jsx("span",{style:{whiteSpace:"pre-line"},children:ts}),e.jsx("button",{type:"button",className:"absolute top-2 right-2 text-xs text-blue-700 hover:underline",onClick:()=>he(!1),"aria-expanded":"true",children:"Hide details"})]}):e.jsxs("button",{type:"button",className:"flex items-center gap-2 text-blue-700 hover:underline text-sm bg-blue-50 rounded px-2 py-1 border border-blue-100",onClick:()=>he(!0),"aria-expanded":"false",children:[e.jsx(de,{className:"w-4 h-4 text-blue-500"}),"Company creation level requirements",e.jsx("span",{className:"ml-1 text-xs",children:"(Show details)"})]})})]}),e.jsxs("div",{className:"overflow-y-auto max-h-[calc(90vh-120px)] pr-2",children:[O===null&&e.jsxs("div",{className:"mb-4 p-2 rounded bg-yellow-100 text-yellow-900 border border-yellow-300 text-sm",children:[e.jsx("div",{children:"Could not find your Minecraft player data. Please make sure your account is linked."}),e.jsxs("div",{className:"mt-1 text-xs text-yellow-800",children:[e.jsx("b",{children:"Debug info:"}),e.jsx("br",{}),Pe.split(`
`).map((s,a)=>e.jsx("div",{children:s},a))]}),e.jsxs("div",{className:"mt-1 text-xs text-yellow-800",children:[e.jsx("b",{children:"Lookups tried:"})," ",Ae.join(", ")]}),e.jsx("div",{className:"mt-1 text-xs text-yellow-800",children:"If you believe this is an error, check your Minecraft account linking in your profile settings or contact support."})]}),e.jsxs("form",{onSubmit:Ue,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h3",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(Je,{className:"w-5 h-5"}),"Basic Information"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"name",children:"Company Name *"}),e.jsx(y,{id:"name",value:n.name,onChange:s=>_("name",s.target.value),placeholder:"Enter company name",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"tagline",children:"Tagline"}),e.jsx(y,{id:"tagline",value:n.tagline,onChange:s=>_("tagline",s.target.value),placeholder:"Brief description of your company"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"description",children:"Description"}),e.jsx(Ve,{id:"description",value:n.description,onChange:s=>_("description",s.target.value),placeholder:"Detailed description of your company (supports Markdown)",rows:4})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Business Details"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"industry",children:"Industry *"}),e.jsxs(I,{value:n.industry,onValueChange:s=>_("industry",s),children:[e.jsx(R,{className:n.industry?"":"border-red-300 focus:border-red-500",children:e.jsx(U,{placeholder:"Select industry"})}),e.jsx(B,{className:"z-[999999] !fixed",position:"popper",sideOffset:4,avoidCollisions:!0,side:"bottom",align:"start",children:rs.map(s=>e.jsx(L,{value:s,children:s},s))})]}),n.industry&&e.jsxs("p",{className:"text-xs text-green-600 dark:text-green-400 flex items-center gap-1",children:[e.jsx(Ce,{className:"w-3 h-3"}),"Selected: ",n.industry]}),!n.industry&&e.jsxs("p",{className:"text-xs text-red-600 dark:text-red-400 flex items-center gap-1",children:[e.jsx(Se,{className:"w-3 h-3"}),"Industry is required"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"business_type",children:"Business Type *"}),e.jsx("div",{className:"flex items-center gap-2 relative",children:e.jsxs(I,{id:"business_type",value:n.business_type,onValueChange:s=>_("business_type",s),required:!0,children:[e.jsx(R,{children:e.jsx(U,{placeholder:"Select business type"})}),e.jsx(Ye,{children:e.jsx(B,{className:"z-[99999]",children:ns.map(s=>e.jsx(L,{value:s,children:e.jsxs("span",{className:"flex items-center gap-2",children:[s,e.jsx(We,{children:e.jsxs(Ge,{children:[e.jsx(Xe,{asChild:!0,children:e.jsx("span",{tabIndex:-1,className:"focus:outline-none",children:e.jsx(de,{className:"w-3 h-3 text-muted-foreground cursor-help"})})}),e.jsx(Ze,{side:"right",className:"max-w-xs",children:ce[s]})]})})]})},s))})})]})}),xe&&e.jsx("div",{className:"text-xs text-red-600 mt-1",children:xe}),n.business_type&&ce[n.business_type]&&e.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:ce[n.business_type]}),!n.business_type&&e.jsxs("p",{className:"text-xs text-red-600 dark:text-red-400 flex items-center gap-1",children:[e.jsx(Se,{className:"w-3 h-3"}),"Business type is required"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"parent_company",children:"Parent Company (Optional)"}),e.jsxs(I,{value:n.parent_company_id,onValueChange:s=>_("parent_company_id",s),children:[e.jsx(R,{children:e.jsx(U,{placeholder:"Select parent company (optional)"})}),e.jsxs(B,{className:"z-[999999] !fixed",position:"popper",sideOffset:4,avoidCollisions:!0,side:"bottom",align:"start",children:[e.jsx(L,{value:"independent",children:"Independent Company"}),fe.map(s=>e.jsxs(L,{value:s.id,children:[s.name," (",s.business_type,")"]},s.id))]})]}),n.parent_company_id&&n.parent_company_id!=="independent"&&e.jsxs("p",{className:"text-xs text-blue-600 dark:text-blue-400 flex items-center gap-1",children:[e.jsx(Ce,{className:"w-3 h-3"}),"Subsidiary of: ",(_e=fe.find(s=>s.id===n.parent_company_id))==null?void 0:_e.name]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"town",children:"Town Location (Optional)"}),e.jsxs(I,{value:n.town_id,onValueChange:s=>_("town_id",s),children:[e.jsx(R,{children:e.jsx(U,{placeholder:"Select town location (optional)"})}),e.jsxs(B,{className:"z-[999999] !fixed",position:"popper",sideOffset:4,avoidCollisions:!0,side:"bottom",align:"start",children:[e.jsx(L,{value:"none",children:"No specific town"}),z.map(s=>e.jsxs(L,{value:s.id,children:[s.name," (",s.type,")"]},s.id))]})]}),n.town_id&&n.town_id!=="none"&&e.jsxs("p",{className:"text-xs text-blue-600 dark:text-blue-400 flex items-center gap-1",children:[e.jsx(Qe,{className:"w-3 h-3"}),"Located in: ",(ge=z.find(s=>s.id===n.town_id))==null?void 0:ge.name]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"headquarters_world",children:"World *"}),e.jsxs(I,{value:n.headquarters_world,onValueChange:s=>_("headquarters_world",s),children:[e.jsx(R,{children:e.jsx(U,{placeholder:"Select world"})}),e.jsx(B,{className:"z-[999999] !fixed",position:"popper",sideOffset:4,avoidCollisions:!0,side:"bottom",align:"start",children:ls.map(s=>e.jsx(L,{value:s,children:s},s))})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Select which world your company operates in"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"headquarters_coords",children:"Headquarters Coordinates"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(y,{type:"number",placeholder:"X",value:n.headquarters_coords.split(",")[0]||"",onChange:s=>{const[,a="",t=""]=n.headquarters_coords.split(",");J(m=>({...m,headquarters_coords:`${s.target.value},${a},${t}`}))},className:"w-20"}),e.jsx(y,{type:"number",placeholder:"Y",value:n.headquarters_coords.split(",")[1]||"",onChange:s=>{const[a="",,t=""]=n.headquarters_coords.split(",");J(m=>({...m,headquarters_coords:`${a},${s.target.value},${t}`}))},className:"w-20"}),e.jsx(y,{type:"number",placeholder:"Z",value:n.headquarters_coords.split(",")[2]||"",onChange:s=>{const[a="",t=""]=n.headquarters_coords.split(",");J(m=>({...m,headquarters_coords:`${a},${t},${s.target.value}`}))},className:"w-20"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Contact Information"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"website_url",children:"Website URL"}),e.jsx(y,{id:"website_url",type:"url",value:n.website_url,onChange:s=>_("website_url",s.target.value),placeholder:"https://example.com"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"email",children:"Email"}),e.jsx(y,{id:"email",type:"email",value:n.email,onChange:s=>_("email",s.target.value),placeholder:"contact@company.com"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"discord_invite",children:"Discord Invite"}),e.jsx(y,{id:"discord_invite",value:n.discord_invite,onChange:s=>_("discord_invite",s.target.value),placeholder:"https://discord.gg/invite"})]})]}),u&&(r==null?void 0:r.id)&&e.jsxs("div",{className:"space-y-4 mt-8",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Staff Members"}),e.jsxs(k,{type:"button",variant:"outline",size:"sm",onClick:()=>ee(!0),className:"flex items-center gap-2",children:[e.jsx(je,{className:"w-4 h-4"}),"Add Staff"]})]}),D.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground",children:'No staff members added yet. Click "Add Staff" to add team members.'}),D.map((s,a)=>e.jsx(as,{member:s,onChange:()=>{},onRemove:async()=>{try{const{error:t}=await f.from("company_staff").delete().eq("company_id",r.id).eq("user_uuid",s.user_uuid);if(t)throw t;S.success("Staff member removed"),te()}catch(t){S.error("Failed to remove staff: "+((t==null?void 0:t.message)||(t==null?void 0:t.details)||(t==null?void 0:t.code)||"Unknown error"))}}},s.user_uuid)),e.jsx(ve,{open:Le,onOpenChange:ee,children:e.jsxs(be,{className:"max-w-lg",children:[e.jsx(we,{children:e.jsx(Ne,{children:"Add Staff Member"})}),e.jsx(os,{companyId:r.id,onClose:()=>{ee(!1),te()}})]})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Visual Branding"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"logo",children:"Company Logo"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(y,{id:"logo",type:"file",accept:"image/*",onChange:Re,className:"flex-1"}),ie&&e.jsx("img",{src:ie,alt:"Logo preview",className:"w-12 h-12 object-cover rounded"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"banner",children:"Banner Image"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(y,{id:"banner",type:"file",accept:"image/*",onChange:s=>{var t;const a=(t=s.target.files)==null?void 0:t[0];a&&(re(a),ne(URL.createObjectURL(a)))},className:"w-64"}),e.jsx(y,{type:"url",placeholder:"Paste image URL...",value:le,onChange:s=>pe(s.target.value),className:"w-64"}),e.jsx(k,{type:"button",size:"sm",onClick:()=>{ne(le),re(null)},disabled:!le,children:"Use URL"})]}),H&&e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:H,alt:"Banner Preview",className:"max-h-32 rounded border"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"primary_color",children:"Primary Color"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(y,{id:"primary_color",type:"color",value:n.primary_color,onChange:s=>_("primary_color",s.target.value),className:"w-16 h-10"}),e.jsx(y,{value:n.primary_color,onChange:s=>_("primary_color",s.target.value),placeholder:"#1E40AF"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"secondary_color",children:"Secondary Color"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(y,{id:"secondary_color",type:"color",value:n.secondary_color,onChange:s=>_("secondary_color",s.target.value),className:"w-16 h-10"}),e.jsx(y,{value:n.secondary_color,onChange:s=>_("secondary_color",s.target.value),placeholder:"#F59E0B"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"is_public",children:"Public Company"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"is_public",checked:n.is_public,onChange:s=>_("is_public",s.target.checked?"true":"false"),className:"rounded"}),e.jsx("label",{htmlFor:"is_public",className:"text-sm text-muted-foreground",children:"Make this company visible to all users"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"is_open",children:"Open for Joining"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"is_open",checked:n.is_open,onChange:s=>_("is_open",s.target.checked?"true":"false"),className:"rounded"}),e.jsx("label",{htmlFor:"is_open",className:"text-sm text-muted-foreground",children:"Allow any user to join this company"})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-8",children:[w&&e.jsx(k,{type:"button",variant:"outline",onClick:w,disabled:F,children:"Cancel"}),e.jsx(k,{type:"submit",disabled:(()=>{const s=(l==null?void 0:l.role)==="admin"||(l==null?void 0:l.role)==="moderator";return F||!s&&(!$e||O===null)})(),children:u?"Save Changes":"Create Company"})]})]})]})]})]})},as=({member:b,onChange:r,onRemove:u})=>{const[w,q]=d.useState(""),{players:N,loading:P}=De(w);return e.jsxs("div",{className:"flex gap-2 p-3 border rounded-lg items-center",children:[e.jsxs("div",{className:"flex-1",children:[b.user_uuid?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:b.displayName}),e.jsx(k,{size:"xs",variant:"ghost",onClick:()=>r({user_uuid:"",displayName:"",role:b.role}),children:"Change"})]}):e.jsxs("div",{children:[e.jsx(y,{placeholder:"Search user...",value:w,onChange:o=>q(o.target.value)}),w.length>=2&&e.jsx("div",{className:"max-h-32 overflow-y-auto border rounded mt-1 bg-background",children:P?e.jsx("div",{className:"p-2 text-muted-foreground",children:"Searching..."}):N.length===0?e.jsx("div",{className:"p-2 text-muted-foreground",children:"No users found"}):N.map(o=>e.jsxs("div",{className:"p-2 hover:bg-muted cursor-pointer",onClick:()=>r({user_uuid:o.id,displayName:o.displayName,role:b.role}),children:[o.displayName," (",o.id,")"]},o.id))})]}),e.jsx(y,{placeholder:"Role/Position",value:b.role,onChange:o=>r({...b,role:o.target.value}),className:"mt-2"})]}),e.jsx(k,{type:"button",variant:"ghost",size:"sm",onClick:u,className:"text-red-500 hover:text-red-700",children:e.jsx(Ke,{className:"w-4 h-4"})})]})},os=({companyId:b,onClose:r})=>{const[u,w]=d.useState(""),[q,N]=d.useState([]),[P,o]=d.useState(!1),[l,T]=d.useState(null),[z,K]=d.useState("Staff"),[G,X]=d.useState(!1),[M,F]=d.useState(null);d.useEffect(()=>{u.length>=2?(o(!0),F(null),f.from("profiles").select("id, minecraft_username, full_name").ilike("minecraft_username",`%${u}%`).then(({data:c,error:Z})=>{N(c||[]),o(!1),Z&&F("Error searching profiles")})):N([])},[u]);const $=async()=>{if(l){X(!0),F(null);try{const{error:c}=await f.from("company_staff").insert({company_id:b,user_uuid:l.id,role:z});if(c)throw F("Failed to add staff: "+(c.message||c.details||c.code||"Unknown error")),c;S.success("Staff member added!"),r()}catch(c){F("Failed to add staff: "+((c==null?void 0:c.message)||(c==null?void 0:c.details)||(c==null?void 0:c.code)||"Unknown error"))}finally{X(!1)}}};return e.jsxs("div",{className:"space-y-4",children:[e.jsx(y,{placeholder:"Search by Minecraft username...",value:u,onChange:c=>w(c.target.value),disabled:!!l}),u.length>=2&&!l&&e.jsx("div",{className:"max-h-40 overflow-y-auto border rounded",children:P?e.jsx("div",{className:"p-2 text-muted-foreground",children:"Searching..."}):q.length===0?e.jsx("div",{className:"p-2 text-muted-foreground",children:"No profiles found"}):q.map(c=>e.jsxs("div",{className:"p-2 hover:bg-muted cursor-pointer",onClick:()=>T(c),children:[c.minecraft_username," ",c.full_name?`(${c.full_name})`:""]},c.id))}),l&&e.jsxs("div",{className:"flex items-center gap-2 p-2 border rounded",children:[e.jsxs("span",{children:[l.minecraft_username," ",l.full_name?`(${l.full_name})`:""]}),e.jsx(k,{size:"xs",variant:"ghost",onClick:()=>T(null),children:"Remove"})]}),e.jsxs("div",{children:[e.jsx(x,{children:"Role"}),e.jsxs(I,{value:z,onValueChange:K,children:[e.jsx(R,{children:e.jsx(U,{})}),e.jsxs(B,{className:"z-[99999] min-w-[180px]",position:"popper",side:"top",forceMount:!0,children:[e.jsx(L,{value:"Manager",children:"Manager"}),e.jsx(L,{value:"Staff",children:"Staff"}),e.jsx(L,{value:"Executive",children:"Executive"})]})]})]}),M&&e.jsx("div",{className:"text-red-600 text-sm",children:M}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(k,{variant:"outline",onClick:r,disabled:G,children:"Cancel"}),e.jsx(k,{onClick:$,disabled:!l||G,children:"Add"})]})]})};export{ps as C};
