import{I as ht,s as p,ay as Fe,bK as Ot,r as x,S as me,j as e,Z as Ke,$ as Qe,a0 as He,a1 as Ie,a2 as ke,X as Oe,aD as ft,aq as Xe,B as Y,aF as y,E as Ee,w as Ne,x as Pe,z as be,b1 as ye,v as S,l as xt,m as gt,n as pt,aV as Ae,aU as Vt,aI as Je,b8 as Gt,Y as Me,y as Ve,o as se,b0 as wt,p as ae,q as re,t as ie,at as vt,au as jt,av as ve,aw as je,aG as Ue,h as Yt,aO as Xt,aP as Jt,aQ as Zt,aR as nt,aH as yt,b2 as ot,b3 as es,a5 as lt,F as dt,bL as ts,br as ss,ba as as,u as rs,bM as is,bN as te,b5 as ns,bO as os,aJ as ct,aX as ls,O as _e,bP as ds,bi as cs}from"./index-DUDTAd9W.js";import{u as J,S as ut}from"./send-n6VBXVLq.js";import{P as us}from"./PageSettings-cV7I7ct-.js";import{u as ms}from"./use-toast-B0dFMpiE.js";import{E as hs}from"./EnhancedWikiEditor-DIlszybt.js";import{R as fs,a as xs}from"./rotate-ccw-CYDGZPix.js";import{P as Se}from"./pen-line-MjRWahhH.js";import{F as gs}from"./flag-BHMTMiEZ.js";import{H as Ge}from"./history-4ZclYXKV.js";import{H as ps}from"./house-DXLJ0JvH.js";import{S as ws}from"./SimpleMarkdownRenderer-x9IIvLyT.js";import{U as vs}from"./upload-tHEKoL-4.js";import{F as js}from"./folder-open-BzHz1uwH.js";import{S as ys}from"./save-uvmCJEKY.js";import"./switch-cn-L-SuC.js";import"./separator-BkI5HRhN.js";import"./ellipsis-Cad-C1ff.js";import"./copy-DxsP4cii.js";import"./download-Dh3YjV-9.js";import"./image-CKfeGsQ7.js";import"./minus-BIL9MBfk.js";import"./quote-DOE5sDw_.js";import"./list-CaF9zg65.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ns=ht("Diff",[["path",{d:"M12 3v14",key:"7cf3v8"}],["path",{d:"M5 10h14",key:"elsbfy"}],["path",{d:"M5 21h14",key:"11awu3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=ht("GitMerge",[["circle",{cx:"18",cy:"18",r:"3",key:"1xkwt0"}],["circle",{cx:"6",cy:"6",r:"3",key:"1lh9wr"}],["path",{d:"M6 21V9a9 9 0 0 0 9 9",key:"7kw0sc"}]]);class bs{async getComments(a){const{data:t,error:n}=await p.from("wiki_comments").select(`
        *,
        author:profiles!wiki_comments_author_id_fkey(full_name)
      `).eq("page_id",a).eq("parent_id",null).order("created_at",{ascending:!1});if(n)throw n;const s=t.map(d=>{var c;return{id:d.id,pageId:d.page_id,authorId:d.author_id,authorName:((c=d.author)==null?void 0:c.full_name)||"Unknown",parentId:d.parent_id,content:d.content,isResolved:d.is_resolved,isPinned:d.is_pinned,isModerated:d.is_moderated,createdAt:d.created_at,updatedAt:d.updated_at,replies:[]}});for(const d of s){const{data:c}=await p.from("wiki_comments").select(`
          *,
          author:profiles!wiki_comments_author_id_fkey(full_name)
        `).eq("parent_id",d.id).order("created_at",{ascending:!0});d.replies=(c==null?void 0:c.map(o=>{var h;return{id:o.id,pageId:o.page_id,authorId:o.author_id,authorName:((h=o.author)==null?void 0:h.full_name)||"Unknown",parentId:o.parent_id,content:o.content,isResolved:o.is_resolved,isPinned:o.is_pinned,isModerated:o.is_moderated,createdAt:o.created_at,updatedAt:o.updated_at}}))||[]}return s}async addComment(a,t,n){var o;const{data:{user:s}}=await p.auth.getUser();if(!s)throw new Error("User not authenticated");const{data:d,error:c}=await p.from("wiki_comments").insert({page_id:a,author_id:s.id,parent_id:n,content:t}).select(`
        *,
        author:profiles!wiki_comments_author_id_fkey(full_name)
      `).single();if(c)throw c;return await this.notifyPageSubscribers(a,n?"comment_replied":"comment_added",s.id,n?"New reply to comment":"New comment added",n?"Someone replied to a comment on this page":"Someone added a new comment to this page"),{id:d.id,pageId:d.page_id,authorId:d.author_id,authorName:((o=d.author)==null?void 0:o.full_name)||"Unknown",parentId:d.parent_id,content:d.content,isResolved:d.is_resolved,isPinned:d.is_pinned,isModerated:d.is_moderated,createdAt:d.created_at,updatedAt:d.updated_at}}async updateComment(a,t){const{error:n}=await p.from("wiki_comments").update({content:t}).eq("id",a);if(n)throw n}async deleteComment(a){const{error:t}=await p.from("wiki_comments").delete().eq("id",a);if(t)throw t}async resolveComment(a,t){const{error:n}=await p.from("wiki_comments").update({is_resolved:t}).eq("id",a);if(n)throw n}async getSuggestedEdits(a){const{data:t,error:n}=await p.from("wiki_suggested_edits").select(`
        *,
        author:profiles!wiki_suggested_edits_author_id_fkey(full_name),
        reviewer:profiles!wiki_suggested_edits_reviewed_by_fkey(full_name)
      `).eq("page_id",a).order("created_at",{ascending:!1});if(n)throw n;return t.map(s=>{var d;return{id:s.id,pageId:s.page_id,authorId:s.author_id,authorName:((d=s.author)==null?void 0:d.full_name)||"Unknown",title:s.title,content:s.content,description:s.description,status:s.status,reviewNotes:s.review_notes,reviewedBy:s.reviewed_by,reviewedAt:s.reviewed_at,createdAt:s.created_at,updatedAt:s.updated_at}})}async submitSuggestedEdit(a,t,n,s){var h;const{data:{user:d}}=await p.auth.getUser();if(!d)throw new Error("User not authenticated");const{data:c,error:o}=await p.from("wiki_suggested_edits").insert({page_id:a,author_id:d.id,title:t,content:n,description:s}).select(`
        *,
        author:profiles!wiki_suggested_edits_author_id_fkey(full_name)
      `).single();if(o)throw o;return await this.notifyPageSubscribers(a,"suggested_edit_submitted",d.id,"New suggested edit submitted","Someone submitted a suggested edit for this page"),{id:c.id,pageId:c.page_id,authorId:c.author_id,authorName:((h=c.author)==null?void 0:h.full_name)||"Unknown",title:c.title,content:c.content,description:c.description,status:c.status,createdAt:c.created_at,updatedAt:c.updated_at}}async reviewSuggestedEdit(a,t,n){const{data:{user:s}}=await p.auth.getUser();if(!s)throw new Error("User not authenticated");const{error:d}=await p.from("wiki_suggested_edits").update({status:t,review_notes:n,reviewed_by:s.id,reviewed_at:new Date().toISOString()}).eq("id",a);if(d)throw d;const{data:c}=await p.from("wiki_suggested_edits").select("author_id, page_id").eq("id",a).single();c&&await this.createNotification(c.author_id,"suggested_edit_reviewed",c.page_id,s.id,"Your suggested edit was reviewed",`Your suggested edit was ${t}${n?`: ${n}`:""}`)}async startEditSession(a){var c;const{data:{user:t}}=await p.auth.getUser();if(!t)throw new Error("User not authenticated");const n=`session_${Date.now()}_${Math.random()}`,{data:s,error:d}=await p.from("wiki_edit_sessions").insert({page_id:a,user_id:t.id,session_token:n}).select(`
        *,
        user:profiles!wiki_edit_sessions_user_id_fkey(full_name)
      `).single();if(d)throw d;return{id:s.id,pageId:s.page_id,userId:s.user_id,userName:((c=s.user)==null?void 0:c.full_name)||"Unknown",sessionToken:s.session_token,lastActivity:s.last_activity,isActive:s.is_active,createdAt:s.created_at}}async updateEditSession(a){const{error:t}=await p.from("wiki_edit_sessions").update({last_activity:new Date().toISOString()}).eq("id",a);if(t)throw t}async endEditSession(a){const{error:t}=await p.from("wiki_edit_sessions").update({is_active:!1}).eq("id",a);if(t)throw t}async checkEditConflicts(a,t){const{data:n,error:s}=await p.rpc("check_edit_conflicts",{page_id_param:a,user_id_param:t});if(s)throw s;return n.map(d=>({conflictUserId:d.conflict_user_id,conflictUserName:d.conflict_user_name,lastActivity:d.last_activity}))}async getCollaborationNotifications(){const{data:{user:a}}=await p.auth.getUser();if(!a)throw new Error("User not authenticated");const{data:t,error:n}=await p.from("wiki_collaboration_notifications").select(`
        *,
        page:wiki_pages!wiki_collaboration_notifications_page_id_fkey(title),
        actor:profiles!wiki_collaboration_notifications_actor_id_fkey(full_name)
      `).eq("user_id",a.id).order("created_at",{ascending:!1}).limit(50);if(n)throw n;return t.map(s=>{var d,c;return{id:s.id,userId:s.user_id,notificationType:s.notification_type,pageId:s.page_id,pageTitle:(d=s.page)==null?void 0:d.title,commentId:s.comment_id,suggestedEditId:s.suggested_edit_id,actorId:s.actor_id,actorName:((c=s.actor)==null?void 0:c.full_name)||"Unknown",title:s.title,message:s.message,data:s.data,isRead:s.is_read,createdAt:s.created_at}})}async markNotificationRead(a){const{error:t}=await p.from("wiki_collaboration_notifications").update({is_read:!0}).eq("id",a);if(t)throw t}async markAllNotificationsRead(){const{data:{user:a}}=await p.auth.getUser();if(!a)throw new Error("User not authenticated");const{error:t}=await p.from("wiki_collaboration_notifications").update({is_read:!0}).eq("user_id",a.id).eq("is_read",!1);if(t)throw t}async createNotification(a,t,n,s,d,c,o){const{error:h}=await p.rpc("create_wiki_collaboration_notification",{user_id_param:a,notification_type_param:t,page_id_param:n,actor_id_param:s,title_param:d,message_param:c,data_param:o});if(h)throw h}async notifyPageSubscribers(a,t,n,s,d,c){const{error:o}=await p.rpc("notify_page_subscribers",{page_id_param:a,notification_type_param:t,actor_id_param:n,title_param:s,message_param:d,data_param:c});if(o)throw o}async subscribeToPage(a,t=["page_edited","comment_added","suggested_edit_submitted"]){const{data:{user:n}}=await p.auth.getUser();if(!n)throw new Error("User not authenticated");const{error:s}=await p.from("wiki_page_subscriptions").upsert({user_id:n.id,page_id:a,notification_types:t});if(s)throw s}async unsubscribeFromPage(a){const{data:{user:t}}=await p.auth.getUser();if(!t)throw new Error("User not authenticated");const{error:n}=await p.from("wiki_page_subscriptions").delete().eq("user_id",t.id).eq("page_id",a);if(n)throw n}async getPageSubscription(a){const{data:{user:t}}=await p.auth.getUser();if(!t)throw new Error("User not authenticated");const{data:n,error:s}=await p.from("wiki_page_subscriptions").select("*").eq("user_id",t.id).eq("page_id",a).single();if(s&&s.code!=="PGRST116")throw s;return n?{id:n.id,userId:n.user_id,pageId:n.page_id,notificationTypes:n.notification_types,createdAt:n.created_at}:null}async getCommentCount(a){const{count:t,error:n}=await p.from("wiki_comments").select("*",{count:"exact",head:!0}).eq("page_id",a);if(n)throw n;return t||0}async getSuggestedEditCount(a){const{count:t,error:n}=await p.from("wiki_suggested_edits").select("*",{count:"exact",head:!0}).eq("page_id",a).eq("status","pending");if(n)throw n;return t||0}async getUnreadNotificationCount(){const{data:{user:a}}=await p.auth.getUser();if(!a)return 0;const{count:t,error:n}=await p.from("wiki_collaboration_notifications").select("*",{count:"exact",head:!0}).eq("user_id",a.id).eq("is_read",!1);if(n)throw n;return t||0}}const D=new bs,_s=i=>{if(!i||i==="temp-id"||i==="")return!1;const a=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,t=/^[a-z0-9-]+$/;return a.test(i)||t.test(i)},Cs=i=>{const{user:a}=Fe(),t=Ot();x.useRef(null);const n=_s(i),{data:s=[],isLoading:d,refetch:c}=me({queryKey:["wiki-comments",i],queryFn:()=>D.getComments(i),enabled:n,staleTime:3e4}),o=J({mutationFn:({content:P,parentId:O})=>D.addComment(i,P,O),onSuccess:()=>{t.invalidateQueries({queryKey:["wiki-comments",i]}),t.invalidateQueries({queryKey:["wiki-comment-count",i]})}}),h=J({mutationFn:({commentId:P,content:O})=>D.updateComment(P,O),onSuccess:()=>{t.invalidateQueries({queryKey:["wiki-comments",i]})}}),N=J({mutationFn:P=>D.deleteComment(P),onSuccess:()=>{t.invalidateQueries({queryKey:["wiki-comments",i]}),t.invalidateQueries({queryKey:["wiki-comment-count",i]})}}),L=J({mutationFn:({commentId:P,resolved:O})=>D.resolveComment(P,O),onSuccess:()=>{t.invalidateQueries({queryKey:["wiki-comments",i]})}}),{data:F=[],isLoading:q,refetch:B}=me({queryKey:["wiki-suggested-edits",i],queryFn:()=>D.getSuggestedEdits(i),enabled:n,staleTime:3e4}),z=J({mutationFn:({title:P,content:O,description:X})=>D.submitSuggestedEdit(i,P,O,X),onSuccess:()=>{t.invalidateQueries({queryKey:["wiki-suggested-edits",i]}),t.invalidateQueries({queryKey:["wiki-suggested-edit-count",i]})}}),U=J({mutationFn:({editId:P,status:O,notes:X})=>D.reviewSuggestedEdit(P,O,X),onSuccess:()=>{t.invalidateQueries({queryKey:["wiki-suggested-edits",i]}),t.invalidateQueries({queryKey:["wiki-suggested-edit-count",i]})}}),[v,k]=x.useState(null),[R,Q]=x.useState([]),[A,m]=x.useState(!1),j=J({mutationFn:()=>D.startEditSession(i),onSuccess:P=>{k(P)}}),r=J({mutationFn:P=>D.endEditSession(P),onSuccess:()=>{k(null)}}),b=x.useCallback(async()=>{if(!(!a||!v))try{m(!0);const P=await D.checkEditConflicts(i,a.id);Q(P)}catch(P){console.error("Failed to check for conflicts:",P)}finally{m(!1)}},[a,v,i]),{data:f=[],isLoading:w,refetch:E}=me({queryKey:["wiki-collaboration-notifications"],queryFn:()=>D.getCollaborationNotifications(),enabled:!!a,staleTime:3e4}),$=J({mutationFn:P=>D.markNotificationRead(P),onSuccess:()=>{t.invalidateQueries({queryKey:["wiki-collaboration-notifications"]}),t.invalidateQueries({queryKey:["wiki-unread-notification-count"]})}}),K=J({mutationFn:()=>D.markAllNotificationsRead(),onSuccess:()=>{t.invalidateQueries({queryKey:["wiki-collaboration-notifications"]}),t.invalidateQueries({queryKey:["wiki-unread-notification-count"]})}}),{data:I,isLoading:ne,refetch:he}=me({queryKey:["wiki-page-subscription",i],queryFn:()=>D.getPageSubscription(i),enabled:n&&!!a,staleTime:6e4}),oe=J({mutationFn:P=>D.subscribeToPage(i,P),onSuccess:()=>{t.invalidateQueries({queryKey:["wiki-page-subscription",i]})}}),le=J({mutationFn:()=>D.unsubscribeFromPage(i),onSuccess:()=>{t.invalidateQueries({queryKey:["wiki-page-subscription",i]})}}),{data:C=0}=me({queryKey:["wiki-comment-count",i],queryFn:()=>D.getCommentCount(i),enabled:n,staleTime:6e4}),{data:Re=0}=me({queryKey:["wiki-suggested-edit-count",i],queryFn:()=>D.getSuggestedEditCount(i),enabled:n,staleTime:6e4}),{data:De=0}=me({queryKey:["wiki-unread-notification-count"],queryFn:()=>D.getUnreadNotificationCount(),enabled:!!a,staleTime:3e4});return x.useEffect(()=>{if(!n||!a)return;const P=p.channel(`wiki-comments-${i}`).on("postgres_changes",{event:"*",schema:"public",table:"wiki_comments",filter:`page_id=eq.${i}`},()=>{t.invalidateQueries({queryKey:["wiki-comments",i]}),t.invalidateQueries({queryKey:["wiki-comment-count",i]})}).subscribe(),O=p.channel(`wiki-suggested-edits-${i}`).on("postgres_changes",{event:"*",schema:"public",table:"wiki_suggested_edits",filter:`page_id=eq.${i}`},()=>{t.invalidateQueries({queryKey:["wiki-suggested-edits",i]}),t.invalidateQueries({queryKey:["wiki-suggested-edit-count",i]})}).subscribe(),X=p.channel(`wiki-edit-sessions-${i}`).on("postgres_changes",{event:"*",schema:"public",table:"wiki_edit_sessions",filter:`page_id=eq.${i}`},()=>{b()}).subscribe(),$e=p.channel(`wiki-collaboration-notifications-${a.id}`).on("postgres_changes",{event:"*",schema:"public",table:"wiki_collaboration_notifications",filter:`user_id=eq.${a.id}`},()=>{t.invalidateQueries({queryKey:["wiki-collaboration-notifications"]}),t.invalidateQueries({queryKey:["wiki-unread-notification-count"]})}).subscribe();return()=>{p.removeChannel(P),p.removeChannel(O),p.removeChannel(X),p.removeChannel($e)}},[i,a,t,b]),x.useEffect(()=>{if(!v)return;const P=setInterval(async()=>{try{await D.updateEditSession(v.id)}catch(X){console.error("Failed to update edit session activity:",X)}},3e4),O=setInterval(()=>{b()},1e4);return()=>{clearInterval(P),clearInterval(O)}},[v,b]),x.useEffect(()=>()=>{v&&r.mutate(v.id)},[v]),{comments:s,commentsLoading:d,addComment:o.mutate,updateComment:h.mutate,deleteComment:N.mutate,resolveComment:L.mutate,commentCount:C,suggestedEdits:F,suggestedEditsLoading:q,submitSuggestedEdit:z.mutate,reviewSuggestedEdit:U.mutate,suggestedEditCount:Re,currentSession:v,conflicts:R,isCheckingConflicts:A,startEditSession:j.mutate,endEditSession:r.mutate,checkConflicts:b,notifications:f,notificationsLoading:w,markNotificationRead:$.mutate,markAllNotificationsRead:K.mutate,unreadNotificationCount:De,pageSubscription:I,subscriptionLoading:ne,subscribeToPage:oe.mutate,unsubscribeFromPage:le.mutate,refetchComments:c,refetchSuggestedEdits:B,refetchNotifications:E,refetchSubscription:he}},ks=i=>{switch(i){case"admin":return{canRead:!0,canEdit:!0,canCreate:!0,canDelete:!0,canPublish:!0,canManageStructure:!0,canManageUsers:!0,canModifyTheme:!0};case"moderator":return{canRead:!0,canEdit:!0,canCreate:!0,canDelete:!0,canPublish:!0,canManageStructure:!0,canManageUsers:!1,canModifyTheme:!1};case"editor":return{canRead:!0,canEdit:!0,canCreate:!0,canDelete:!1,canPublish:!1,canManageStructure:!1,canManageUsers:!1,canModifyTheme:!1};case"member":default:return{canRead:!0,canEdit:!1,canCreate:!1,canDelete:!1,canPublish:!1,canManageStructure:!1,canManageUsers:!1,canModifyTheme:!1}}},Ss=({categories:i,selectedSlug:a,onNavigate:t=()=>{},onRefreshData:n=()=>{},onForceRefreshData:s=()=>{},onWikiBranchChange:d=()=>{},loading:c=!1,searchQuery:o,onSearchChange:h,availableBranches:N=["Nordics"],currentBranch:L="Nordics"})=>{const{toast:F}=ms(),[q,B]=x.useState({}),z=m=>{B(j=>({...j,[m]:!j[m]}))},U=m=>{t(m)},v=async()=>{try{await n(),F({title:"Wiki refreshed",description:"Latest content loaded from storage"})}catch{F({title:"Refresh failed",description:"Could not load latest content",variant:"destructive"})}},k=async()=>{try{await s(),F({title:"Wiki force refreshed",description:"All caches cleared and content reloaded"})}catch{F({title:"Force refresh failed",description:"Could not force reload content",variant:"destructive"})}},R=m=>!m||!Array.isArray(m)?[]:m.map(j=>{var f;if(!j)return null;const r=o.trim()===""?j.pages||[]:((f=j.pages)==null?void 0:f.filter(w=>w&&w.title&&w.title.toLowerCase().includes(o.toLowerCase())||j.title&&j.title.toLowerCase().includes(o.toLowerCase())))||[],b=j.children?R(j.children):[];return{...j,pages:r,children:b}}).filter(j=>j&&(j.pages&&j.pages.length>0||j.children&&j.children.length>0||o.trim()!==""&&j.title&&j.title.toLowerCase().includes(o.toLowerCase()))),Q=R(i),A=(m,j=0)=>{var I,ne,he,oe,le;if(!m||!m.id)return null;const r=q[m.id],b=m.children&&m.children.length>0,f=m.pages&&m.pages.length>0,w=(((I=m.pages)==null?void 0:I.length)||0)+(((ne=m.children)==null?void 0:ne.length)||0),E=j===0,$=(he=m.pages)==null?void 0:he.find(C=>C&&C.id&&(C.id.endsWith("/README.md")||C.title&&C.title.toLowerCase()==="readme")),K=!!$;return e.jsxs("div",{className:`${E?"space-y-4":"space-y-2"}`,children:[e.jsxs("div",{className:`flex items-center gap-2 cursor-pointer transition-all duration-200 rounded-md px-2 py-1.5 ${E?"bg-muted/40 hover:bg-muted/60":"hover:bg-muted/30"}`,onClick:C=>{K&&$?(C.stopPropagation(),U($.id)):z(m.id)},children:[b||f?e.jsx("button",{className:"p-0.5 hover:bg-muted/50 rounded transition-colors",onClick:C=>{C.stopPropagation(),z(m.id)},children:r?e.jsx(ft,{className:"h-3 w-3"}):e.jsx(Xe,{className:"h-3 w-3"})}):e.jsx("div",{className:"w-4 h-4"}),e.jsxs("div",{className:"flex items-center gap-1.5 flex-1",children:[e.jsx("span",{className:`font-medium ${E?"text-sm":"text-xs"}`,children:m.title}),K&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"📄"})]}),e.jsx(Y,{variant:"secondary",className:"text-xs px-1.5 py-0.5",children:w})]}),r&&e.jsxs("div",{className:`${E?"space-y-2":"space-y-1"} ml-4`,children:[(oe=m.pages)==null?void 0:oe.filter(C=>C&&C.id&&!C.id.endsWith("/README.md")&&C.title&&C.title.toLowerCase()!=="readme").map(C=>!C||!C.id||!C.title?null:e.jsx("div",{className:`flex items-center gap-2 cursor-pointer rounded-md px-2 py-1 transition-all duration-200 ${a===C.id?"bg-primary/10 text-primary border border-primary/30":"hover:bg-muted/50 text-muted-foreground hover:text-foreground"}`,onClick:()=>{U(C.id)},children:e.jsx("span",{className:"text-xs font-medium truncate",children:C.title})},C.id)),(le=m.children)==null?void 0:le.map(C=>C?A(C,j+1):null)]})]},m.id)};return e.jsxs("div",{className:"h-full bg-background/60 backdrop-blur-sm rounded-lg p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"flex items-center gap-2 text-xs font-medium text-muted-foreground",children:"Wiki Branch"}),e.jsxs(Ke,{value:L,onValueChange:d,children:[e.jsx(Qe,{className:"h-7 text-xs",children:e.jsx(He,{placeholder:"Select wiki branch"})}),e.jsx(Ie,{children:N.map(m=>m?e.jsx(ke,{value:m,children:e.jsx("div",{className:"flex items-center gap-2",children:m})},m):null)})]})]}),e.jsx("div",{className:"h-px bg-border/50"}),e.jsx("div",{className:"space-y-2",children:e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(Oe,{placeholder:"Search pages...",value:o,onChange:m=>h(m.target.value),className:"h-7 text-xs"})})}),e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"p-1 hover:bg-muted/50 rounded transition-colors",onClick:v,disabled:c,title:"Refresh wiki content",children:c?"Refreshing...":"Refresh"}),e.jsx("button",{className:"p-1 hover:bg-muted/50 rounded transition-colors text-orange-600",onClick:k,disabled:c,title:"Force refresh wiki content (clear all caches)",children:c?"Refreshing...":"🔄"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[i.reduce((m,j)=>m+(j&&j.pages?j.pages.length:0),0)," pages"]})]})}),e.jsxs("div",{className:"space-y-4 overflow-y-auto flex-1",children:[Q.map(m=>{var j;if(!m)return null;if(((j=m.pages)==null?void 0:j.length)===1&&(!m.children||m.children.length===0)){const r=m.pages[0];return!r||!r.id||!r.title?null:e.jsx("div",{className:`flex items-center gap-2 cursor-pointer rounded-md px-2 py-1 transition-all duration-200 ${a===r.id?"bg-primary/10 text-primary border border-primary/30":"hover:bg-muted/50 text-muted-foreground hover:text-foreground"}`,onClick:()=>U(r.id),children:e.jsx("span",{className:"text-xs font-medium truncate",children:r.title})},r.id)}return A(m)}),Q.length===0&&o&&e.jsx("div",{className:"text-center py-6 text-muted-foreground",children:e.jsxs("p",{className:"text-xs",children:['No pages found matching "',o,'"']})})]})]})};class Ce{static async resolveDbPageId(a,t){if(/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(a))return a;const s=(t||a.split("/").pop()||"").replace(/\.md$/,"");if(!s)return a;const{data:d,error:c}=await p.from("wiki_pages").select("id").eq("slug",s).maybeSingle();return!c&&(d!=null&&d.id)?d.id:a}static async getComments(a,t){try{const n=await this.resolveDbPageId(a,t),{data:s,error:d}=await p.from("wiki_comments").select(`
          *,
          profiles:author_id (
            id,
            full_name,
            minecraft_username,
            username,
            avatar_url
          )
        `).eq("page_id",n).is("parent_id",null).order("is_pinned",{ascending:!1}).order("created_at",{ascending:!0});if(d)throw d;const c=(s==null?void 0:s.map(o=>{var h,N,L,F;return{...o,author_name:((h=o.profiles)==null?void 0:h.username)||((N=o.profiles)==null?void 0:N.minecraft_username)||((L=o.profiles)==null?void 0:L.full_name)||"Anonymous",author_avatar:(F=o.profiles)==null?void 0:F.avatar_url,replies:[]}}))||[];for(const o of c)o.replies=await this.getReplies(o.id);return c}catch(n){throw console.error("Error fetching comments:",n),n}}static async getReplies(a){try{const{data:t,error:n}=await p.from("wiki_comments").select(`
          *,
          profiles:author_id (
            id,
            full_name,
            minecraft_username,
            username,
            avatar_url
          )
        `).eq("parent_id",a).order("created_at",{ascending:!0});if(n)throw n;return(t==null?void 0:t.map(s=>{var d,c,o,h;return{...s,author_name:((d=s.profiles)==null?void 0:d.username)||((c=s.profiles)==null?void 0:c.minecraft_username)||((o=s.profiles)==null?void 0:o.full_name)||"Anonymous",author_avatar:(h=s.profiles)==null?void 0:h.avatar_url,replies:[]}}))||[]}catch(t){throw console.error("Error fetching replies:",t),t}}static async createComment(a,t){var n,s,d,c;try{const o=await this.resolveDbPageId(String(a.page_id),t),{data:h,error:N}=await p.from("wiki_comments").insert({page_id:o,author_id:a.author_id,parent_id:a.parent_id,content:a.content,is_resolved:a.is_resolved||!1,is_pinned:a.is_pinned||!1,is_moderated:a.is_moderated||!1}).select(`
          *,
          profiles:author_id (
            id,
            full_name,
            minecraft_username,
            username,
            avatar_url
          )
        `).single();if(N)throw N;return{...h,author_name:((n=h.profiles)==null?void 0:n.username)||((s=h.profiles)==null?void 0:s.minecraft_username)||((d=h.profiles)==null?void 0:d.full_name)||"Anonymous",author_avatar:(c=h.profiles)==null?void 0:c.avatar_url,replies:[]}}catch(o){throw console.error("Error creating comment:",o),o}}static async updateComment(a,t){var n,s,d,c;try{const{data:o,error:h}=await p.from("wiki_comments").update({content:t.content,is_resolved:t.is_resolved,is_pinned:t.is_pinned,is_moderated:t.is_moderated,updated_at:new Date().toISOString()}).eq("id",a).select(`
          *,
          profiles:author_id (
            id,
            full_name,
            minecraft_username,
            username,
            avatar_url
          )
        `).single();if(h)throw h;return{...o,author_name:((n=o.profiles)==null?void 0:n.username)||((s=o.profiles)==null?void 0:s.minecraft_username)||((d=o.profiles)==null?void 0:d.full_name)||"Anonymous",author_avatar:(c=o.profiles)==null?void 0:c.avatar_url,replies:[]}}catch(o){throw console.error("Error updating comment:",o),o}}static async deleteComment(a){try{const{error:t}=await p.from("wiki_comments").delete().eq("id",a);if(t)throw t}catch(t){throw console.error("Error deleting comment:",t),t}}static async getCommentCount(a){try{const t=await this.resolveDbPageId(a),{count:n,error:s}=await p.from("wiki_comments").select("*",{count:"exact",head:!0}).eq("page_id",t);if(s)throw s;return n||0}catch(t){return console.error("Error getting comment count:",t),0}}}const Es=({pageId:i,userRole:a,allowComments:t=!0,pageSlug:n})=>{const{user:s}=Fe(),[d,c]=x.useState([]),[o,h]=x.useState(!0),[N,L]=x.useState(""),[F,q]=x.useState(null),[B,z]=x.useState(null),[U,v]=x.useState("");x.useEffect(()=>{k()},[i,n]);const k=async()=>{try{h(!0);const f=await Ce.getComments(i,n);c(f)}catch(f){console.error("Error loading comments:",f),y.error("Failed to load comments")}finally{h(!1)}},R=async()=>{if(!(!s||!N.trim()))try{const f=await Ce.createComment({page_id:i,author_id:s.id,parent_id:null,content:N.trim(),is_resolved:!1,is_pinned:!1,is_moderated:!1},n);c(w=>[...w,f]),L(""),y.success("Comment added successfully")}catch(f){console.error("Error creating comment:",f),y.error("Failed to add comment")}},Q=async(f,w)=>{if(!(!s||!w.trim()))try{const E=await Ce.createComment({page_id:i,author_id:s.id,parent_id:f,content:w.trim(),is_resolved:!1,is_pinned:!1,is_moderated:!1});c($=>$.map(K=>K.id===f?{...K,replies:[...K.replies||[],E]}:K)),q(null),y.success("Reply added successfully")}catch(E){console.error("Error creating reply:",E),y.error("Failed to add reply")}},A=async f=>{if(U.trim())try{const w=await Ce.updateComment(f,{content:U.trim()});c(E=>E.map($=>$.id===f?w:$)),z(null),v(""),y.success("Comment updated successfully")}catch(w){console.error("Error updating comment:",w),y.error("Failed to update comment")}},m=async f=>{if(confirm("Are you sure you want to delete this comment?"))try{await Ce.deleteComment(f),c(w=>w.filter(E=>E.id!==f)),y.success("Comment deleted successfully")}catch(w){console.error("Error deleting comment:",w),y.error("Failed to delete comment")}},j=a==="admin"||a==="moderator",r=f=>(s==null?void 0:s.id)===f.author_id||j,b=({comment:f,isReply:w=!1})=>{var K;const[E,$]=x.useState("");return e.jsxs(Ne,{className:`${w?"ml-8 mt-2":"mb-4"}`,children:[e.jsx(Pe,{className:"pb-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(xt,{className:"h-6 w-6",children:[e.jsx(gt,{src:f.author_avatar}),e.jsx(pt,{children:(K=f.author_name)==null?void 0:K.charAt(0).toUpperCase()})]}),e.jsx("span",{className:"text-sm font-medium",children:f.author_name}),e.jsx("span",{className:"text-xs text-muted-foreground",children:Ae(new Date(f.created_at),{addSuffix:!0})})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[f.is_pinned&&e.jsxs(Y,{variant:"secondary",className:"text-xs",children:[e.jsx(Vt,{className:"h-3 w-3 mr-1"}),"Pinned"]}),f.is_resolved&&e.jsxs(Y,{variant:"outline",className:"text-xs",children:[e.jsx(Je,{className:"h-3 w-3 mr-1"}),"Resolved"]})]})]})}),e.jsxs(be,{className:"pt-0",children:[B===f.id?e.jsxs("div",{className:"space-y-2",children:[e.jsx(ye,{value:U,onChange:I=>v(I.target.value),placeholder:"Edit your comment...",className:"min-h-[80px]"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(S,{size:"sm",onClick:()=>A(f.id),children:"Save"}),e.jsx(S,{size:"sm",variant:"outline",onClick:()=>{z(null),v("")},children:"Cancel"})]})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:f.content}),e.jsxs("div",{className:"flex items-center gap-2",children:[!w&&e.jsxs(S,{size:"sm",variant:"ghost",onClick:()=>q(F===f.id?null:f.id),children:[e.jsx(fs,{className:"h-3 w-3 mr-1"}),"Reply"]}),r(f)&&e.jsxs(e.Fragment,{children:[e.jsxs(S,{size:"sm",variant:"ghost",onClick:()=>{z(f.id),v(f.content)},children:[e.jsx(Se,{className:"h-3 w-3 mr-1"}),"Edit"]}),e.jsxs(S,{size:"sm",variant:"ghost",onClick:()=>m(f.id),children:[e.jsx(Gt,{className:"h-3 w-3 mr-1"}),"Delete"]})]}),j&&e.jsxs(S,{size:"sm",variant:"ghost",children:[e.jsx(gs,{className:"h-3 w-3 mr-1"}),"Moderate"]})]})]}),F===f.id&&e.jsxs("div",{className:"mt-4 space-y-2",children:[e.jsx(ye,{value:E,onChange:I=>$(I.target.value),placeholder:"Write a reply...",className:"min-h-[80px]"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(S,{size:"sm",onClick:()=>Q(f.id,E),disabled:!E.trim(),children:[e.jsx(ut,{className:"h-3 w-3 mr-1"}),"Reply"]}),e.jsxs(S,{size:"sm",variant:"outline",onClick:()=>{q(null),$("")},children:[e.jsx(Me,{className:"h-3 w-3 mr-1"}),"Cancel"]})]})]}),f.replies&&f.replies.length>0&&e.jsx("div",{className:"mt-4",children:f.replies.map(I=>e.jsx(b,{comment:I,isReply:!0},I.id))})]})]})};return t?e.jsxs("div",{className:"space-y-6",children:[s&&e.jsxs(Ne,{children:[e.jsx(Pe,{children:e.jsx("h3",{className:"text-lg font-medium",children:"Add a Comment"})}),e.jsx(be,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(ye,{value:N,onChange:f=>L(f.target.value),placeholder:"Write your comment...",className:"min-h-[100px]"}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(S,{onClick:R,disabled:!N.trim(),children:[e.jsx(ut,{className:"h-4 w-4 mr-2"}),"Post Comment"]})})]})})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-medium mb-4",children:["Comments (",d.length,")"]}),o?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"Loading comments..."})]}):d.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ee,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"No Comments Yet"}),e.jsx("p",{className:"text-muted-foreground",children:"Be the first to share your thoughts!"})]}):e.jsx("div",{className:"space-y-4",children:d.map(f=>e.jsx(b,{comment:f},f.id))})]})]}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ee,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"Comments Disabled"}),e.jsx("p",{className:"text-muted-foreground",children:"Comments are not enabled for this page."})]})},mt=({edit:i,userRole:a,currentContent:t,currentTitle:n,onReview:s,onApplyEdit:d,canReview:c})=>{const{user:o}=Fe(),[h,N]=x.useState(!1),[L,F]=x.useState(!1),[q,B]=x.useState(""),[z,U]=x.useState(!1);o==null||o.id,i.authorId;const v=()=>{switch(i.status){case"pending":return e.jsxs(Y,{variant:"secondary",children:[e.jsx(Ue,{className:"w-3 h-3 mr-1"}),"Pending"]});case"approved":return e.jsxs(Y,{variant:"default",children:[e.jsx(ot,{className:"w-3 h-3 mr-1"}),"Approved"]});case"rejected":return e.jsxs(Y,{variant:"destructive",children:[e.jsx(Me,{className:"w-3 h-3 mr-1"}),"Rejected"]});case"merged":return e.jsxs(Y,{variant:"outline",children:[e.jsx(Ye,{className:"w-3 h-3 mr-1"}),"Merged"]});default:return null}},k=async A=>{if(!q.trim()&&A==="rejected"){y.error("Please provide review notes when rejecting an edit");return}U(!0);try{await s(i.id,A,q.trim()||void 0),N(!1),B(""),y.success(`Edit ${A}`)}catch(m){console.error("Failed to review edit:",m),y.error("Failed to review edit")}finally{U(!1)}},R=async()=>{try{await s(i.id,"approved"),y.success("Edit approved. Use Merge to apply changes.")}catch(A){console.error("Failed to approve edit:",A),y.error("Failed to approve edit")}},Q=()=>{const A=i.title!==n,m=i.content!==t;return e.jsxs("div",{className:"space-y-4",children:[A&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"Title Changes"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-xs font-medium text-muted-foreground",children:"Current"}),e.jsx("div",{className:"p-2 bg-red-50 border border-red-200 rounded text-sm",children:n})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-xs font-medium text-muted-foreground",children:"Proposed"}),e.jsx("div",{className:"p-2 bg-green-50 border border-green-200 rounded text-sm",children:i.title})]})]})]}),m&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"Content Changes"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-xs font-medium text-muted-foreground",children:"Current"}),e.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded text-sm max-h-96 overflow-y-auto",children:e.jsx("pre",{className:"whitespace-pre-wrap",children:t})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-xs font-medium text-muted-foreground",children:"Proposed"}),e.jsx("div",{className:"p-3 bg-green-50 border border-green-200 rounded text-sm max-h-96 overflow-y-auto",children:e.jsx("pre",{className:"whitespace-pre-wrap",children:i.content})})]})]})]})]})};return e.jsx(Ne,{className:Yt("border",i.status==="pending"&&"border-yellow-200 bg-yellow-50/30",i.status==="approved"&&"border-green-200 bg-green-50/30",i.status==="rejected"&&"border-red-200 bg-red-50/30",i.status==="merged"&&"border-blue-200 bg-blue-50/30"),children:e.jsxs(be,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs(xt,{className:"h-8 w-8",children:[e.jsx(gt,{src:`https://api.dicebear.com/7.x/initials/svg?seed=${i.authorName}`}),e.jsx(pt,{children:i.authorName.charAt(0).toUpperCase()})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"font-medium text-sm",children:i.authorName}),v()]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:Ae(new Date(i.createdAt),{addSuffix:!0})})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(se,{open:L,onOpenChange:F,children:[e.jsx(wt,{asChild:!0,children:e.jsxs(S,{variant:"outline",size:"sm",children:[e.jsx(Ns,{className:"w-4 h-4 mr-2"}),"View Changes"]})}),e.jsxs(ae,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsx(re,{children:e.jsx(ie,{children:"Suggested Edit Changes"})}),Q()]})]}),c&&i.status==="pending"&&e.jsxs(Xt,{children:[e.jsx(Jt,{asChild:!0,children:e.jsx(S,{variant:"outline",size:"sm",children:"Review"})}),e.jsxs(Zt,{align:"end",children:[e.jsxs(nt,{onClick:()=>N(!0),children:[e.jsx(yt,{className:"w-4 h-4 mr-2"}),"Review"]}),e.jsxs(nt,{onClick:R,children:[e.jsx(Ye,{className:"w-4 h-4 mr-2"}),"Apply & Merge"]})]})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-sm mb-1",children:"Proposed Title"}),e.jsx("p",{className:"text-sm bg-muted/30 p-2 rounded",children:i.title})]}),i.description&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-sm mb-1",children:"Description"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:i.description})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-sm mb-1",children:"Proposed Content"}),e.jsx("div",{className:"bg-muted/30 p-3 rounded max-h-32 overflow-y-auto",children:e.jsx("pre",{className:"text-sm whitespace-pre-wrap",children:i.content})})]}),i.reviewNotes&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-sm mb-1",children:"Review Notes"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:i.reviewNotes})]})]}),e.jsx(se,{open:h,onOpenChange:N,children:e.jsxs(ae,{children:[e.jsx(re,{children:e.jsx(ie,{children:"Review Suggested Edit"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Review Notes (optional)"}),e.jsx(ye,{value:q,onChange:A=>B(A.target.value),placeholder:"Provide feedback or notes about this edit...",className:"mt-1"})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(S,{variant:"outline",onClick:()=>N(!1),disabled:z,children:"Cancel"}),e.jsxs(S,{variant:"destructive",onClick:()=>k("rejected"),disabled:z,children:[e.jsx(Me,{className:"w-4 h-4 mr-2"}),"Reject"]}),e.jsxs(S,{onClick:()=>k("approved"),disabled:z,children:[e.jsx(ot,{className:"w-4 h-4 mr-2"}),"Approve"]})]})]})]})})]})})},Ps=({pageId:i,userRole:a,currentContent:t,currentTitle:n,onApplyEdit:s,pageOwnerId:d,openSubmit:c,onOpenSubmitChange:o})=>{const{user:h}=Fe(),[N,L]=x.useState([]),[F,q]=x.useState(!0),[B,z]=x.useState(!1),U=typeof c=="boolean",v=U?!!c:B,[k,R]=x.useState({title:n,content:t,description:""}),[Q,A]=x.useState(!1),m=async()=>{try{q(!0);const w=await D.getSuggestedEdits(i);L(w)}catch(w){console.error("Failed to load suggested edits:",w),y.error("Failed to load suggested edits")}finally{q(!1)}};x.useEffect(()=>{m()},[i]);const j=async()=>{if(!k.title.trim()||!k.content.trim()){y.error("Please provide both title and content");return}A(!0);try{await D.submitSuggestedEdit(i,k.title.trim(),k.content.trim(),k.description.trim()||void 0),U?o==null||o(!1):z(!1),R({title:n,content:t,description:""}),m(),y.success("Suggested edit submitted for review")}catch(w){console.error("Failed to submit edit:",w),y.error("Failed to submit suggested edit")}finally{A(!1)}},r=async(w,E,$)=>{try{await D.reviewSuggestedEdit(w,E,$),m()}catch(K){throw console.error("Failed to review edit:",K),K}},b=N.filter(w=>w.status==="pending"),f=N.filter(w=>w.status!=="pending");return e.jsxs(Ne,{children:[e.jsx(Pe,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ve,{className:"flex items-center space-x-2",children:[e.jsx(Se,{className:"w-5 h-5"}),e.jsxs("span",{children:["Suggested Edits (",N.length,")"]})]}),h&&e.jsxs(se,{open:v,onOpenChange:w=>{U?o==null||o(w):z(w)},children:[e.jsx(wt,{asChild:!0,children:e.jsxs(S,{size:"sm",onClick:()=>{U?o==null||o(!0):z(!0)},children:[e.jsx(Se,{className:"w-4 h-4 mr-2"}),"Suggest Edit"]})}),e.jsxs(ae,{className:"max-w-2xl",children:[e.jsx(re,{children:e.jsx(ie,{children:"Submit Suggested Edit"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Title"}),e.jsx("input",{type:"text",value:k.title,onChange:w=>R(E=>({...E,title:w.target.value})),className:"w-full mt-1 px-3 py-2 border rounded-md",placeholder:"Page title"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Content"}),e.jsx(ye,{value:k.content,onChange:w=>R(E=>({...E,content:w.target.value})),placeholder:"Page content in markdown...",className:"mt-1 min-h-[200px]"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Description (optional)"}),e.jsx(ye,{value:k.description,onChange:w=>R(E=>({...E,description:w.target.value})),placeholder:"Explain what changes you're suggesting and why...",className:"mt-1"})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(S,{variant:"outline",onClick:()=>setShowSubmitDialog(!1),disabled:Q,children:"Cancel"}),e.jsx(S,{onClick:j,disabled:Q,children:Q?"Submitting...":"Submit Edit"})]})]})]})]})]})}),e.jsx(be,{children:F?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"Loading suggested edits..."})]}):N.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(Se,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"No suggested edits yet."}),h&&e.jsx("p",{className:"text-sm",children:"Be the first to suggest an improvement!"})]}):e.jsxs(vt,{defaultValue:"pending",className:"w-full",children:[e.jsxs(jt,{className:"grid w-full grid-cols-2",children:[e.jsxs(ve,{value:"pending",children:["Pending (",b.length,")"]}),e.jsxs(ve,{value:"reviewed",children:["Reviewed (",f.length,")"]})]}),e.jsx(je,{value:"pending",className:"space-y-4 mt-4",children:b.length===0?e.jsxs("div",{className:"text-center py-4 text-muted-foreground",children:[e.jsx(Je,{className:"w-6 h-6 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"No pending edits"})]}):b.map(w=>e.jsx(mt,{edit:w,userRole:a,currentContent:t,currentTitle:n,onReview:r,onApplyEdit:s,canReview:a==="admin"||a==="moderator"},w.id))}),e.jsx(je,{value:"reviewed",className:"space-y-4 mt-4",children:f.length===0?e.jsxs("div",{className:"text-center py-4 text-muted-foreground",children:[e.jsx(Ue,{className:"w-6 h-6 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"No reviewed edits"})]}):f.map(w=>e.jsx(mt,{edit:w,userRole:a,currentContent:t,currentTitle:n,onReview:r,onApplyEdit:s,canReview:a==="admin"||a==="moderator"},w.id))})]})})]})},Fs=({pageId:i,pageTitle:a,pageSlug:t,onRevisionRestored:n})=>{const[s,d]=x.useState([]),[c,o]=x.useState(!0),[h,N]=x.useState(null),[L,F]=x.useState(!1);x.useEffect(()=>{q()},[i]);const q=async()=>{var v,k;try{o(!0);let R=i;const Q=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;if(!Q.test(R)){if(t){const{data:r,error:b}=await p.from("wiki_pages").select("id").eq("slug",t).single();!b&&(r!=null&&r.id)&&(R=r.id)}if(!Q.test(R)){const r=((v=i.split("/").pop())==null?void 0:v.replace(/\.md$/,""))||"";if(r){const{data:b}=await p.from("wiki_pages").select("id").eq("slug",r).maybeSingle();b!=null&&b.id&&(R=b.id)}}}const{data:A,error:m}=await p.from("page_revisions").select(`
          *,
          profiles:author_id (
            full_name,
            email
          )
        `).eq("page_id",R).order("revision_number",{ascending:!1});if(m){if(m.code==="PGRST116"){console.log("No revisions found for this page"),d([]);return}if(m.code==="406"||(k=m.message)!=null&&k.includes("Not Acceptable")){console.log("Permission denied accessing revisions"),d([]);return}throw m}const j=(A||[]).map(r=>{var b,f;return{...r,author_name:((b=r.profiles)==null?void 0:b.full_name)||((f=r.profiles)==null?void 0:f.email)||"Unknown"}});d(j)}catch(R){console.error("Failed to load revisions:",R),R instanceof Error&&!R.message.includes('relation "page_revisions" does not exist')&&y.error("Failed to load page history"),d([])}finally{o(!1)}},B=async v=>{if(confirm(`Are you sure you want to restore this page to revision ${v.revision_number}? This will create a new revision.`))try{F(!0);const{error:k}=await p.rpc("restore_page_revision",{p_revision_id:v.id});if(k)throw k;y.success(`Page restored to revision ${v.revision_number}`),n==null||n(),q()}catch(k){console.error("Failed to restore revision:",k),y.error("Failed to restore revision")}finally{F(!1)}},z=v=>{switch(v){case"published":return e.jsx(Je,{className:"w-4 h-4 text-green-600"});case"review":return e.jsx(ss,{className:"w-4 h-4 text-orange-600"});case"draft":return e.jsx(Ue,{className:"w-4 h-4 text-yellow-600"});default:return e.jsx(Ue,{className:"w-4 h-4 text-gray-600"})}},U=v=>{const k={draft:"bg-yellow-500/20 text-yellow-700 border-yellow-500/30",review:"bg-orange-500/20 text-orange-700 border-orange-500/30",published:"bg-green-500/20 text-green-700 border-green-500/30"};return e.jsxs(Y,{className:`${k[v]} flex items-center space-x-1`,children:[z(v),e.jsx("span",{className:"capitalize",children:v})]})};return c?e.jsx("div",{className:"flex items-center justify-center p-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-8 h-8 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading page history..."})]})}):s.length===0?e.jsx("div",{className:"flex items-center justify-center p-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Ge,{className:"w-12 h-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"No Page History"}),e.jsx("p",{className:"text-muted-foreground",children:"This page doesn't have any revision history yet."})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-semibold flex items-center space-x-2",children:[e.jsx(Ge,{className:"w-6 h-6"}),e.jsx("span",{children:"Page History"})]}),e.jsx("p",{className:"text-muted-foreground mt-1",children:a})]}),e.jsxs(Y,{variant:"outline",children:[s.length," revisions"]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(Ne,{children:[e.jsx(Pe,{children:e.jsx(Ve,{children:"Revision History"})}),e.jsx(be,{children:e.jsx(es,{className:"h-96",children:e.jsx("div",{className:"space-y-3",children:s.map(v=>e.jsxs("div",{className:`p-4 border rounded-lg cursor-pointer transition-colors ${(h==null?void 0:h.id)===v.id?"border-primary bg-primary/5":"border-border hover:border-primary/50"}`,onClick:()=>N(v),children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(Y,{variant:"outline",children:["#",v.revision_number]}),v.is_current&&e.jsx(Y,{variant:"default",className:"text-xs",children:"Current"})]}),U(v.status)]}),e.jsx("h4",{className:"font-medium text-sm mb-1",children:v.title}),e.jsxs("div",{className:"flex items-center space-x-4 text-xs text-muted-foreground mb-2",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(lt,{className:"w-3 h-3"}),e.jsx("span",{children:v.author_name})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(dt,{className:"w-3 h-3"}),e.jsx("span",{children:new Date(v.created_at).toLocaleDateString()})]})]}),v.comment&&e.jsxs("div",{className:"flex items-start space-x-1 text-xs text-muted-foreground",children:[e.jsx(Ee,{className:"w-3 h-3 mt-0.5 flex-shrink-0"}),e.jsx("span",{children:v.comment})]})]},v.id))})})})]}),e.jsxs(Ne,{children:[e.jsx(Pe,{children:e.jsxs(Ve,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Revision Preview"}),h&&!h.is_current&&e.jsxs(S,{size:"sm",onClick:()=>B(h),disabled:L,className:"flex items-center space-x-2",children:[e.jsx(xs,{className:"w-4 h-4"}),e.jsx("span",{children:"Restore"})]})]})}),e.jsx(be,{children:h?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-medium",children:h.title}),U(h.status)]}),e.jsxs("div",{className:"flex items-center space-x-4 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(lt,{className:"w-4 h-4"}),e.jsx("span",{children:h.author_name})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(dt,{className:"w-4 h-4"}),e.jsx("span",{children:new Date(h.created_at).toLocaleString()})]})]}),h.comment&&e.jsx("div",{className:"p-3 bg-muted/30 rounded-lg",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(Ee,{className:"w-4 h-4 mt-0.5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium mb-1",children:"Revision Comment"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:h.comment})]})]})}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Content Preview"}),e.jsx("div",{className:"prose prose-sm max-w-none max-h-96 overflow-y-auto",children:e.jsx(ts,{content:h.content})})]})]}):e.jsx("div",{className:"flex items-center justify-center h-64 text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(yt,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"Select a revision to preview"})]})})})]})]})]})},Rs=({currentPage:i,categories:a,onNavigate:t,className:n=""})=>{const d=(()=>{const o=[{id:"home",title:"Wiki",type:"home",slug:"/wiki"}];if(!i)return o;const h=(L,F)=>{for(const q of L){if(q.pages.some(B=>B.id===F))return q;if(q.children){const B=h(q.children,F);if(B)return B}}return null},N=h(a,i.id);return N&&o.push({id:N.id,title:N.title,type:"category",slug:N.slug}),o.push({id:i.id,title:i.title,type:"page",slug:i.slug}),o})(),c=o=>{if(o.type==="home")t("/wiki");else if(o.type==="category"){const h=a.find(N=>N.id===o.id);h&&h.pages.length>0&&t(`/wiki/${h.pages[0].slug}`)}else o.type==="page"&&o.slug&&t(`/wiki/${o.slug}`)};return e.jsx("nav",{className:`flex items-center space-x-1 text-sm ${n}`,"aria-label":"Breadcrumb",children:d.map((o,h)=>e.jsxs("div",{className:"flex items-center",children:[h>0&&e.jsx(Xe,{className:"w-4 h-4 text-muted-foreground"}),e.jsxs(S,{variant:h===d.length-1?"default":"ghost",size:"sm",className:`h-auto p-1 text-sm ${h===d.length-1?"font-medium":"text-muted-foreground hover:text-foreground"}`,onClick:()=>c(o),disabled:h===d.length-1,children:[o.type==="home"&&e.jsx(ps,{className:"w-3 h-3 mr-1"}),o.title]})]},o.id))})},Ds=({content:i,isLiveData:a,lastUpdated:t,onRefresh:n,isRefreshing:s,entityType:d,entityData:c})=>e.jsx("div",{className:"max-w-4xl mx-auto",children:e.jsx("div",{className:"prose prose-sm max-w-none",style:{"--tw-prose-body":"hsl(var(--foreground))","--tw-prose-headings":"hsl(var(--foreground))","--tw-prose-links":"hsl(var(--primary))","--tw-prose-bold":"hsl(var(--foreground))","--tw-prose-counters":"hsl(var(--muted-foreground))","--tw-prose-bullets":"hsl(var(--muted-foreground))","--tw-prose-hr":"hsl(var(--border))","--tw-prose-quotes":"hsl(var(--muted-foreground))","--tw-prose-quote-borders":"hsl(var(--border))","--tw-prose-captions":"hsl(var(--muted-foreground))","--tw-prose-code":"hsl(var(--foreground))","--tw-prose-pre-code":"hsl(var(--foreground))","--tw-prose-pre-bg":"hsl(var(--muted))","--tw-prose-th-borders":"hsl(var(--border))","--tw-prose-td-borders":"hsl(var(--border))"},children:e.jsx(ws,{content:i})})}),aa=()=>{const{user:i,profile:a}=Fe(),t=(a==null?void 0:a.role)||"member",n=ks(t),{slug:s}=as(),d=rs(),{categories:c,fileStructure:o,loading:h,error:N,refreshData:L,forceRefresh:F,getPageByPath:q,searchPages:B,getFileContent:z,getFileContentWithMetadata:U,savePage:v}=is(),[k,R]=x.useState("Nordics"),[Q,A]=x.useState(["Nordics"]),[m,j]=x.useState(""),[r,b]=x.useState(null);x.useState(!1);const[f,w]=x.useState(!1),[E,$]=x.useState(!1),[K,I]=x.useState(!1),[ne,he]=x.useState(!1),[oe,le]=x.useState(!1),[C,Re]=x.useState(!1),[De,P]=x.useState(!1),[O,X]=x.useState(!1),[$e,Ze]=x.useState(!1),[Nt,Te]=x.useState("content"),[We,bt]=x.useState(!1),[_t,et]=x.useState(!0),[T,fe]=x.useState({title:"",category:"",status:"draft",description:""}),[ze,qs]=x.useState(null),[Ct,kt]=x.useState(!0),[St,xe]=x.useState(!1),[Et,Be]=x.useState(),[Pt,qe]=x.useState(!1),[Ft,ge]=x.useState(null),[Rt,pe]=x.useState(null),V=Cs((r==null?void 0:r.id)||""),tt=l=>l.flatMap(u=>{var _;const g=((_=u.pages)==null?void 0:_.map(W=>({...W,categoryName:u.title,categorySlug:u.slug})))||[],M=u.children?tt(u.children):[];return[...g,...M]}),H=tt(c);x.useEffect(()=>{if(s&&c.length>0){const l=s.replace(/-/g,"/"),u=M=>{for(const _ of M){for(const W of _.pages||[])if(W.id===l||W.id.endsWith(`/${l}.md`)||W.slug===s||W.title.toLowerCase().replace(/\s+/g,"-")===s.toLowerCase()||W.id.toLowerCase().includes(l.toLowerCase())||W.id.replace(/\//g,"-").replace(/\.md$/,"")===s)return W;if(_.children){const W=u(_.children);if(W)return W}}return null},g=u(c);if(g)(r==null?void 0:r.id)!==g.id&&de(g);else{console.warn(`Page not found for URL slug: ${s}`);const M=H.find(_=>_.title.toLowerCase().includes(s.toLowerCase().replace(/-/g," "))||_.slug.toLowerCase().includes(s.toLowerCase())||_.id.toLowerCase().includes(s.toLowerCase()));M?(r==null?void 0:r.id)!==M.id&&de(M):H.length>0&&(r==null?void 0:r.id)!==H[0].id&&de(H[0])}}},[s,c,H,d,r]),x.useEffect(()=>{if(s||c.length===0||r)return;const l=G=>(G||"").trim().toLowerCase(),u=["nordics-home","nordics_home","home"],g=H.find(G=>u.includes(l(G.slug))),M=H.find(G=>u.includes(l(G.title).replace(/\s+/g,"-"))||l(G.title)==="nordics home"),_=H.find(G=>l(G.id)==="nordics/readme.md"),W=g||M||_||(H.length>0?H[0]:null);W&&de(W)},[s,c,H,r]);const st=l=>l.flatMap(u=>{const g=u.children?st(u.children):[];return[u,...g]}),Dt=st(c);H.filter(l=>{var u;return l.title.toLowerCase().includes(m.toLowerCase())||l.content.toLowerCase().includes(m.toLowerCase())||((u=l.categoryName)==null?void 0:u.toLowerCase().includes(m.toLowerCase()))});const at=async()=>{$(!0);try{await L(),y.success("Wiki data refreshed successfully!")}catch(l){console.error("Failed to refresh wiki data:",l),y.error("Failed to refresh wiki data")}finally{$(!1)}},qt=async()=>{$(!0);try{await F(),y.success("Wiki data force refreshed successfully!")}catch(l){console.error("Failed to force refresh wiki data:",l),y.error("Failed to force refresh wiki data")}finally{$(!1)}},Le=async()=>{if(r){qe(!0);try{const l=r.githubPath||r.id;if(l){const u=await te.getStaticFileContent(l),{frontmatter:g}=te.parseFrontmatterPublic(u||""),M=String((g==null?void 0:g.live_sync_enabled)||"").toLowerCase()==="true",_=((g==null?void 0:g.entity_type)||"").toLowerCase(),W=g==null?void 0:g.entity_name;if(b({...r,content:u}),M){const{LiveWikiDataService:G}=await cs(async()=>{const{LiveWikiDataService:we}=await import("./liveWikiDataService-zYJVuKWk.js");return{LiveWikiDataService:we}},[]);if(G.shouldUseLiveData(l)||!!(_&&W)){const{entityType:we,entityName:ce}=G.extractEntityInfo(l),Z=_==="town"||_==="nation"?_:we,ee=W||ce;if(Z&&ee)try{const ue=await G.getLiveWikiData(Z,ee);xe(!0),Be(ue.lastUpdated),ge(ue.entityData),pe(Z),y.success("Live data refreshed")}catch(ue){console.warn("Failed to fetch entity data for compact cards:",ue),xe(!1),ge(null),pe(null)}}else xe(!1),ge(null),pe(null)}else xe(!1),ge(null),pe(null)}}catch(l){console.error("Failed to refresh live data:",l),y.error("Failed to refresh live data")}finally{qe(!1)}}},Lt=()=>{X(!0),fe({title:"",description:"",category:"",status:"draft"})},At=async()=>{if(!T.title.trim()||!T.category){y.error("Please fill in all required fields");return}try{I(!0);const l=c.find(_=>_.id===T.category);if(!l){y.error("Selected category not found");return}const u=T.title.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,""),g=`${l.id}/${u}.md`,M=`# ${T.title}

${T.description?`> ${T.description}`:""}

<!-- Start writing your content here -->
`;await v(g,M,T.title),X(!1),fe({title:"",description:"",category:"",status:"draft"}),await L(),y.success("Page created successfully!")}catch(l){console.error("Failed to create page:",l),y.error("Failed to create page: "+(l instanceof Error?l.message:"Unknown error"))}finally{I(!1)}},de=async l=>{if((r==null?void 0:r.id)===l.id)return;b(l),Te("content");const u=l.id.replace(/\//g,"-").replace(/\.md$/,"");s!==u&&d(`/wiki/${u}`,{replace:!0}),qe(!0);try{const g=l.githubPath||l.id;if(g){const M=await te.getStaticFileContent(g);b(_=>({..._||l,content:M||((_==null?void 0:_.content)??"")})),xe(!1),Be(void 0),ge(null),pe(null)}}catch(g){console.warn("Failed to load live content, using static content:",g),xe(!1),Be(void 0),ge(null),pe(null)}finally{qe(!1)}},rt=async l=>{if(r)try{I(!0);const u=r.id||r.githubPath;if(!u)throw new Error("No file path found for the selected page");await te.savePage(u,l.content||r.content,l.title||r.title);try{await te.ensureWikiPageAndRecordRevision(r.slug,l.title||r.title,l.content||r.content,r.status)}catch(M){console.warn("Failed to save page to database (revision not recorded):",M)}const g={...r,...l,updatedAt:new Date().toISOString()};b(g),y.info("🔄 Refreshing wiki data to show your changes..."),await F(),y.success("Page saved successfully!")}catch(u){console.error("Failed to save page:",u),y.error("Failed to save page: "+(u instanceof Error?u.message:"Unknown error"))}finally{I(!1)}},it=()=>{r&&(f?(w(!1),V!=null&&V.endEditSession&&V.endEditSession(ze==null?void 0:ze.id)):(V!=null&&V.startEditSession&&V.startEditSession(),w(!0)))},Mt=l=>{let u=H.find(g=>g.id===l);u||(u=H.find(g=>g.slug===l)),u||(u=H.find(g=>g.id.endsWith(`/${l}.md`))),u?de(u):console.warn(`Page not found for ID: ${l}`)},Ut=l=>{j(l)},$t=l=>{R(l)},Tt=async l=>{if(r)try{await te.deletePage(r.id),y.success("Page deleted from Supabase!"),b(null),await L(),d("/wiki",{replace:!0})}catch(u){throw console.error("Failed to delete page:",u),y.error("Failed to delete page from Supabase: "+(u instanceof Error?u.message:"Unknown error")),u}},Wt=async(l,u)=>{if(r)try{const g={...r,title:u};b(g),console.log("Renaming page:",l,"to:",u)}catch(g){throw console.error("Failed to rename page:",g),g}},zt=async(l,u)=>{if(r)try{const g={...r,category:u};b(g),console.log("Moving page:",l,"to category:",u)}catch(g){throw console.error("Failed to move page:",g),g}},Bt=async l=>{try{const u={...l,id:`${l.id}-copy-${Date.now()}`,title:`${l.title} (Copy)`,slug:`${l.slug}-copy`,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};console.log("Duplicating page:",l.id),de(u)}catch(u){throw console.error("Failed to duplicate page:",u),u}},Kt=async l=>{try{const u=`# ${l.title}

${l.content}`,g=new Blob([u],{type:"text/markdown"}),M=URL.createObjectURL(g),_=document.createElement("a");_.href=M,_.download=`${l.slug}.md`,document.body.appendChild(_),_.click(),document.body.removeChild(_),URL.revokeObjectURL(M)}catch(u){throw console.error("Failed to export page:",u),u}},Qt=async l=>{try{const u=await l.text();console.log("Importing page from file:",l.name),y.success("Page imported successfully")}catch(u){throw console.error("Failed to import page:",u),u}},Ht=async(l,u)=>{if(r)try{let g=r.githubPath;if(!g){const ce=Z=>{for(const ee of Z){if(ee.type==="file"&&ee.name===r.slug+".md")return ee.path;if(ee.children){const ue=ce(ee.children);if(ue)return ue}}return null};g=ce(o)}if(!g)throw new Error("Could not find file path for the selected page");let M=r.content;const{frontmatter:_,markdown:W}=te.parseFrontmatterPublic(M),G={..._,...u,updated_at:new Date().toISOString()},we=`---
${Object.entries(G).map(([ce,Z])=>typeof Z=="string"?`${ce}: "${Z}"`:`${ce}: ${Z}`).join(`
`)}
---

${W}`;await te.savePage(g,we,r.title),b({...r,...u,content:we}),await L(),await Le(),y.success("Page settings updated!")}catch(g){console.error("Failed to update page settings:",g),y.error("Failed to update page settings: "+(g instanceof Error?g.message:"Unknown error"))}};return h?e.jsx("div",{className:"container mx-auto px-4 py-12",children:e.jsx("div",{className:"flex items-center justify-center min-h-[420px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mx-auto mb-4 h-10 w-10 rounded-full border-2 border-muted border-t-primary animate-spin"}),e.jsx("h2",{className:"text-sm font-medium text-foreground",children:"Loading wiki…"})]})})}):N?e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx(ns,{className:"h-12 w-12 text-destructive mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold mb-2",children:"Error Loading Wiki"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:N}),e.jsxs("div",{className:"flex gap-2 justify-center",children:[e.jsx(S,{onClick:at,disabled:E,children:E?e.jsxs(e.Fragment,{children:[e.jsx(RefreshCw,{className:"h-4 w-4 animate-spin mr-2"}),"Refreshing..."]}):"Try Again"}),e.jsx(S,{variant:"outline",onClick:()=>window.location.reload(),children:"Reload Page"})]})]})})}):(H.length,c.length,e.jsxs("div",{className:"flex h-screen bg-background justify-center",children:[e.jsxs("div",{className:"flex h-full max-w-8xl w-full",children:[e.jsx("div",{className:`
          ${We?"w-16":"w-80"} 
          transition-all duration-300 flex-shrink-0
          relative z-50
          h-full
        `,children:e.jsx("div",{className:"h-full overflow-y-auto bg-background/60 backdrop-blur-sm rounded-lg flex flex-col",children:e.jsx(Ss,{categories:c||[],selectedSlug:(r==null?void 0:r.id)||"",onNavigate:l=>{Mt(l),et(!1)},onRefreshData:at,onForceRefreshData:qt,onWikiBranchChange:$t,loading:h||!1,searchQuery:m||"",onSearchChange:Ut,availableBranches:Q||["Nordics"],currentBranch:k||"Nordics"})})}),e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsx("div",{className:"border-b bg-background/60 backdrop-blur-sm",children:e.jsxs("div",{className:"flex items-center justify-between p-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(S,{variant:"ghost",size:"sm",onClick:()=>et(!_t),className:"lg:hidden",children:e.jsx(os,{className:"h-4 w-4"})}),e.jsx(S,{variant:"ghost",size:"sm",onClick:()=>bt(!We),className:"hidden lg:flex",children:We?e.jsx(Xe,{className:"h-4 w-4"}):e.jsx(ft,{className:"h-4 w-4"})}),r&&e.jsx(Rs,{categories:c,currentPage:r,onNavigate:l=>{const u=H.find(g=>g.slug===l);u&&de(u)}})]}),e.jsx("div",{className:"flex items-center gap-2",children:i&&n.canCreate&&e.jsxs(S,{size:"sm",onClick:Lt,children:[e.jsx(ct,{className:"h-4 w-4 mr-2"}),"New Page"]})})]})}),e.jsxs("div",{className:"flex-1 overflow-hidden",children:[e.jsx("div",{className:"bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4",children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("svg",{className:"h-5 w-5 text-yellow-400",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z",clipRule:"evenodd"})})}),e.jsx("div",{className:"ml-3",children:e.jsxs("p",{className:"text-sm text-yellow-700",children:[e.jsx("strong",{children:"Work in Progress:"})," This wiki is currently under development and may not be fully functional. Some features may be incomplete or unavailable."]})})]})}),r?e.jsx("div",{className:"h-full flex",children:e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden px-4 lg:px-12 mr-4",children:[e.jsx("div",{className:"border-b p-3 bg-background/40 backdrop-blur-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(Y,{variant:"secondary",className:"h-5 px-2 text-[11px]",children:r.category}),r.status!=="published"&&e.jsx(Y,{variant:"outline",className:"h-5 px-2 text-[11px]",children:r.status})]}),e.jsx("h1",{className:"text-xl font-semibold leading-tight",children:r.title}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground mt-1",children:[e.jsxs("span",{children:["By ",r.authorName||"Unknown"]}),e.jsx("span",{children:"•"}),e.jsx("span",{children:Ae(new Date(r.createdAt),{addSuffix:!0})}),r.updatedAt!==r.createdAt&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"•"}),e.jsxs("span",{children:["Updated ",Ae(new Date(r.updatedAt),{addSuffix:!0})]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[i&&e.jsxs(e.Fragment,{children:[e.jsxs(S,{variant:"outline",size:"sm",onClick:()=>le(!0),className:"bg-white hover:bg-gray-50 border-gray-300 text-gray-700 shadow-sm",children:[e.jsx(Ge,{className:"h-4 w-4 mr-2"}),"History"]}),e.jsxs(S,{variant:"outline",size:"sm",onClick:it,className:"bg-white hover:bg-gray-50 border-gray-300 text-gray-700 shadow-sm",children:[e.jsx(Se,{className:"h-4 w-4 mr-2"}),f?"Cancel Edit":"Edit"]}),f&&e.jsxs(S,{variant:"outline",size:"sm",onClick:()=>Re(!0),className:"bg-white hover:bg-gray-50 border-gray-300 text-gray-700 shadow-sm",children:[e.jsx(vs,{className:"h-4 w-4 mr-2"}),"Media"]})]}),i&&!f&&e.jsxs(S,{variant:"outline",size:"sm",onClick:()=>{Te("suggested-edits"),Ze(!0)},className:"bg-white hover:bg-gray-50 border-gray-300 text-gray-700 shadow-sm",children:[e.jsx(Ye,{className:"h-4 w-4 mr-2"}),"Suggest Edit"]}),i&&r&&e.jsx(us,{page:r,onDelete:Tt,onRename:Wt,onMove:zt,onDuplicate:Bt,onExport:Kt,onImport:Qt,onUpdateSettings:Ht})]})]})}),e.jsx("div",{className:"flex-1 overflow-hidden",children:e.jsxs(vt,{value:Nt,onValueChange:Te,className:"h-full flex flex-col",children:[e.jsxs(jt,{className:"w-full justify-start border-b rounded-none h-9 gap-1",children:[e.jsx(ve,{className:"h-7 px-2 text-xs",value:"content",children:"Content"}),e.jsxs(ve,{className:"h-7 px-2 text-xs",value:"comments",children:["Comments",V!=null&&V.commentCount?e.jsx("span",{className:"ml-1",children:V.commentCount}):null]}),e.jsxs(ve,{className:"h-7 px-2 text-xs",value:"suggested-edits",children:["Suggested Edits",V!=null&&V.suggestedEditCount?e.jsx("span",{className:"ml-1",children:V.suggestedEditCount}):null]}),e.jsx(ve,{className:"h-7 px-2 text-xs",value:"collaboration",children:"Collab"})]}),e.jsx(je,{value:"content",className:"flex-1 overflow-auto p-6",children:f?e.jsx(hs,{page:r,userRole:t,isEditing:f,onSave:rt,onToggleEdit:it,autoSaveEnabled:Ct,onAutoSaveToggle:kt}):e.jsx(Ds,{content:r.content,isLiveData:St,lastUpdated:Et,onRefresh:Le,isRefreshing:Pt,entityType:Rt,entityData:Ft})}),e.jsx(je,{value:"comments",className:"flex-1 overflow-auto p-6",children:e.jsx(Es,{pageId:r.id,pageSlug:r.slug,userRole:t,allowComments:r.allowComments})}),e.jsx(je,{value:"suggested-edits",className:"flex-1 overflow-auto p-6",children:r&&e.jsx(Ps,{pageId:r.id,userRole:t,currentContent:r.content,currentTitle:r.title,pageOwnerId:r.authorId,onApplyEdit:async(l,u)=>{await rt({title:l,content:u}),await Le()},openSubmit:$e,onOpenSubmitChange:Ze})}),e.jsx(je,{value:"collaboration",className:"flex-1 overflow-auto p-6",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ee,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"Collaboration Dashboard"}),e.jsx("p",{className:"text-muted-foreground",children:"Real-time collaboration features coming soon"})]})})]})})]})}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx(ls,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"Select a Page"}),e.jsx("p",{className:"text-muted-foreground",children:"Choose a page from the sidebar to view its content"})]})})]})]})]}),ne&&e.jsx(se,{open:ne,onOpenChange:he,children:e.jsxs(ae,{className:"max-w-4xl",children:[e.jsx(re,{children:e.jsx(ie,{children:"Advanced Search"})}),e.jsx("div",{className:"p-4",children:e.jsx("p",{className:"text-muted-foreground",children:"Advanced search coming soon"})})]})}),oe&&r&&e.jsx(se,{open:oe,onOpenChange:le,children:e.jsxs(ae,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsx(re,{children:e.jsx(ie,{children:"Page History"})}),e.jsx("div",{className:"p-2",children:e.jsx(Fs,{pageId:r.id,pageTitle:r.title,pageSlug:r.slug,onRevisionRestored:async()=>{await Le()}})})]})}),C&&r&&e.jsx(se,{open:C,onOpenChange:Re,children:e.jsxs(ae,{className:"max-w-4xl",children:[e.jsx(re,{children:e.jsx(ie,{children:"Media Upload"})}),e.jsx("div",{className:"p-4",children:e.jsx("p",{className:"text-muted-foreground",children:"Media upload coming soon"})})]})}),De&&e.jsx(se,{open:De,onOpenChange:P,children:e.jsxs(ae,{className:"max-w-4xl",children:[e.jsx(re,{children:e.jsx(ie,{children:"Wiki Settings"})}),e.jsx("div",{className:"p-4",children:e.jsx("p",{className:"text-muted-foreground",children:"Wiki settings coming soon"})})]})}),O&&e.jsx(se,{open:O,onOpenChange:X,children:e.jsxs(ae,{className:"max-w-2xl",children:[e.jsx(re,{children:e.jsxs(ie,{className:"flex items-center gap-2",children:[e.jsx(ct,{className:"h-5 w-5"}),"Create New Page"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(_e,{htmlFor:"title",children:"Title *"}),e.jsx(Oe,{id:"title",value:T.title,onChange:l=>fe({...T,title:l.target.value}),placeholder:"Enter page title..."})]}),T.title&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(_e,{children:"Slug Preview"}),e.jsx("div",{className:"p-2 bg-muted rounded-md text-sm font-mono text-muted-foreground",children:T.title.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,"")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_e,{htmlFor:"category",children:"Category *"}),e.jsxs(Ke,{value:T.category,onValueChange:l=>fe({...T,category:l}),children:[e.jsx(Qe,{children:e.jsx(He,{placeholder:"Select category"})}),e.jsx(Ie,{children:Dt.map(l=>l?e.jsx(ke,{value:l.id,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(js,{className:"h-4 w-4"}),e.jsx("span",{children:l.title||"Untitled"}),l.id!==l.title&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",l.id,")"]})]})},l.id):null)})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_e,{htmlFor:"description",children:"Description (optional)"}),e.jsx(Oe,{id:"description",value:T.description,onChange:l=>fe({...T,description:l.target.value}),placeholder:"Brief description of the page..."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_e,{htmlFor:"status",children:"Status"}),e.jsxs(Ke,{value:T.status,onValueChange:l=>fe({...T,status:l}),children:[e.jsx(Qe,{children:e.jsx(He,{})}),e.jsxs(Ie,{children:[e.jsx(ke,{value:"draft",children:"Draft"}),e.jsx(ke,{value:"review",children:"Review"}),e.jsx(ke,{value:"published",children:"Published"})]})]})]})]}),e.jsxs(ds,{children:[e.jsxs(S,{variant:"outline",onClick:()=>X(!1),children:[e.jsx(Me,{className:"h-4 w-4 mr-2"}),"Cancel"]}),e.jsx(S,{onClick:At,disabled:K||!T.title.trim()||!T.category,children:K?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ys,{className:"h-4 w-4 mr-2"}),"Create Page"]})})]})]})})]}))};export{aa as default};
