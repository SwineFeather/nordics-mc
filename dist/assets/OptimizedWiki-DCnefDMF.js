import{r as n,ay as K,ba as Y,u as Z,j as e,b5 as _,v as k,aX as M,aq as ee,aD as te,w as $,x as W,W as B,X as ae,z as E,B as A,b4 as T,y as se,a5 as re,F as ne,aV as oe}from"./index-DUDTAd9W.js";import{O as w}from"./optimizedWikiService-C1zy6_dl.js";import{P as le}from"./PageSettings-cV7I7ct-.js";import{S as ce}from"./SimpleMarkdownRenderer-x9IIvLyT.js";import{R as ie}from"./refresh-cw-DXtGU-vZ.js";import{F as Q}from"./folder-open-BzHz1uwH.js";import{L as de}from"./loader-circle-DMK_EDKw.js";import"./switch-cn-L-SuC.js";import"./separator-BkI5HRhN.js";import"./ellipsis-Cad-C1ff.js";import"./pen-line-MjRWahhH.js";import"./copy-DxsP4cii.js";import"./download-Dh3YjV-9.js";import"./upload-tHEKoL-4.js";const me=()=>{const[L,y]=n.useState([]),[h,F]=n.useState([]),[g,p]=n.useState(!0),[C,P]=n.useState(null),[O,U]=n.useState(null),[S,N]=n.useState(new Map),l=n.useRef(null),f=n.useCallback(async(c=!1)=>{l.current&&l.current.abort(),l.current=new AbortController;try{p(!0),P(null),console.log("üîÑ Loading optimized wiki structure...");const r=await w.getFileStructureOnly();if(l.current.signal.aborted)return;const x=await w.convertToWikiDataMinimal(r);if(l.current.signal.aborted)return;F(r),y(x),U(new Date),console.log(`‚úÖ Loaded ${x.length} categories with ${x.reduce((j,R)=>{var u;return j+(((u=R.pages)==null?void 0:u.length)||0)},0)} pages (structure only)`)}catch(r){if(l.current.signal.aborted)return;console.error("‚ùå Failed to load optimized wiki data:",r),P(r instanceof Error?r.message:"Failed to load wiki data")}finally{l.current.signal.aborted||p(!1)}},[]),o=n.useCallback(async c=>{if(S.has(c))return S.get(c)||null;try{console.log(`üìÑ Loading content for page: ${c}`);const r=await w.getPageContent(c);return r&&(N(x=>new Map(x).set(c,r)),console.log(`‚úÖ Loaded content for page: ${c}`)),r}catch(r){return console.error(`‚ùå Failed to load content for page ${c}:`,r),null}},[S]),d=n.useCallback(async()=>{console.log("üîÑ Refreshing optimized wiki data..."),N(new Map),await f(!0)},[f]),b=n.useCallback(async c=>{try{return await w.getPageByPath(c)}catch(r){return console.error("Failed to get page by path:",r),null}},[]),m=n.useCallback(async c=>{try{return await w.searchPages(c)}catch(r){return console.error("Failed to search pages:",r),[]}},[]),D=n.useCallback(async c=>{try{return await w.getFileContent(c)}catch(r){throw console.error("Failed to get file content:",r),r}},[]);return n.useEffect(()=>{f()},[f]),n.useEffect(()=>()=>{l.current&&l.current.abort()},[]),{categories:L,fileStructure:h,loading:g,error:C,lastUpdated:O,refreshData:d,getPageByPath:b,searchPages:m,getFileContent:D,loadPageContent:o}},Se=()=>{const{user:L,profile:y}=K();y!=null&&y.role;const{slug:h}=Y(),F=Z(),{categories:g,loading:p,error:C,refreshData:P,getPageByPath:O,searchPages:U,getFileContent:S,loadPageContent:N}=me(),[l,f]=n.useState(""),[o,d]=n.useState(null),[b,m]=n.useState(""),[D,c]=n.useState(!1),[r,x]=n.useState(!1),j=g.flatMap(t=>{var a;return((a=t.pages)==null?void 0:a.map(s=>({...s,categoryName:t.title,categorySlug:t.slug})))||[]}),R=j.filter(t=>t.title.toLowerCase().includes(l.toLowerCase())||t.categoryName.toLowerCase().includes(l.toLowerCase())),u=n.useCallback(async t=>{if(d(t),m(""),t!=null&&t.slug&&F(`/wiki/${t.slug}`,{replace:!1}),t.content)m(t.content);else{c(!0);try{const a=await N(t.id);a&&(m(a),t.content=a)}catch(a){console.error("Failed to load page content:",a),m(`# Error Loading Content

Unable to load the page content. Please try again.`)}finally{c(!1)}}},[N]);n.useEffect(()=>{if(!h||g.length===0)return;const t=j.find(s=>s.slug===h);if(t){u(t);return}const a=j.find(s=>s.id.replace(/\//g,"-").replace(/\.md$/,"")===h||s.title.toLowerCase().replace(/\s+/g,"-")===h.toLowerCase());a&&u(a)},[h,g,j,u]);const z=async()=>{try{await P(),d(null),m("")}catch(t){console.error("Failed to refresh:",t)}},X=async t=>{if(o)try{console.log("Deleting page:",t),d(null),m("")}catch(a){throw console.error("Failed to delete page:",a),a}},q=async(t,a)=>{if(o)try{const s={...o,title:a};d(s),console.log("Renaming page:",t,"to:",a)}catch(s){throw console.error("Failed to rename page:",s),s}},H=async(t,a)=>{if(o)try{const s={...o,category:a};d(s),console.log("Moving page:",t,"to category:",a)}catch(s){throw console.error("Failed to move page:",s),s}},V=async t=>{try{const a={...t,id:`${t.id}-copy-${Date.now()}`,title:`${t.title} (Copy)`,slug:`${t.slug}-copy`,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};console.log("Duplicating page:",t.id),u(a)}catch(a){throw console.error("Failed to duplicate page:",a),a}},G=async t=>{try{const a=`# ${t.title}

${b}`,s=new Blob([a],{type:"text/markdown"}),i=URL.createObjectURL(s),v=document.createElement("a");v.href=i,v.download=`${t.slug}.md`,document.body.appendChild(v),v.click(),document.body.removeChild(v),URL.revokeObjectURL(i)}catch(a){throw console.error("Failed to export page:",a),a}},I=async t=>{try{const a=await t.text();console.log("Importing page from file:",t.name)}catch(a){throw console.error("Failed to import page:",a),a}},J=async(t,a)=>{if(o)try{const s={...o,...a};d(s),console.log("Updating page settings:",t,a)}catch(s){throw console.error("Failed to update page settings:",s),s}};return p?e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading wiki structure..."}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Loading file structure only (fast loading)"})]})})}):C?e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx(_,{className:"h-12 w-12 text-destructive mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold mb-2",children:"Error Loading Wiki"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:C}),e.jsxs("div",{className:"flex gap-2 justify-center",children:[e.jsx(k,{onClick:z,children:"Try Again"}),e.jsx(k,{variant:"outline",onClick:()=>window.location.reload(),children:"Reload Page"})]})]})})}):e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-2",children:[e.jsx(M,{className:"h-8 w-8"}),"Wiki"]}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Fast-loading wiki with on-demand content"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(k,{variant:"outline",size:"sm",onClick:z,disabled:p,children:[e.jsx(ie,{className:`h-4 w-4 ${p?"animate-spin":""}`}),"Refresh"]}),e.jsxs(k,{variant:"outline",size:"sm",onClick:()=>x(!r),children:[r?e.jsx(ee,{className:"h-4 w-4"}):e.jsx(te,{className:"h-4 w-4"}),r?"Expand":"Collapse"]})]})]}),e.jsxs("div",{className:"flex gap-6",children:[e.jsx("div",{className:`${r?"w-64":"w-80"} transition-all duration-300`,children:e.jsxs($,{children:[e.jsx(W,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{className:"h-4 w-4"}),e.jsx(ae,{placeholder:"Search pages...",value:l,onChange:t=>f(t.target.value),className:"h-8"})]})}),e.jsxs(E,{className:"pt-0",children:[e.jsx("div",{className:"space-y-2",children:g.map(t=>{var a,s;return e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-medium text-muted-foreground",children:[e.jsx(Q,{className:"h-4 w-4"}),t.title,e.jsx(A,{variant:"secondary",className:"ml-auto",children:((a=t.pages)==null?void 0:a.length)||0})]}),e.jsx("div",{className:"ml-4 space-y-1",children:(s=t.pages)==null?void 0:s.filter(i=>!l||i.title.toLowerCase().includes(l.toLowerCase())||t.title.toLowerCase().includes(l.toLowerCase())).map(i=>e.jsx("button",{onClick:()=>u(i),className:`w-full text-left p-2 rounded-md text-sm transition-colors ${(o==null?void 0:o.id)===i.id?"bg-primary text-primary-foreground":"hover:bg-muted"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(T,{className:"h-4 w-4"}),e.jsx("span",{className:"truncate",children:i.title})]})},i.id))})]},t.id)})}),l&&R.length===0&&e.jsxs("div",{className:"text-center py-4 text-muted-foreground",children:[e.jsx(B,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),e.jsxs("p",{children:['No pages found matching "',l,'"']})]})]})]})}),e.jsx("div",{className:"flex-1",children:o?e.jsxs($,{children:[e.jsx(W,{children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx(se,{className:"text-2xl",children:o.title}),e.jsxs("div",{className:"flex items-center gap-4 mt-2 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(re,{className:"h-4 w-4"}),o.authorName]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ne,{className:"h-4 w-4"}),oe(new Date(o.updatedAt),{addSuffix:!0})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Q,{className:"h-4 w-4"}),o.category]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(A,{variant:o.status==="published"?"default":"secondary",children:o.status}),L&&o&&e.jsx(le,{page:o,onDelete:X,onRename:q,onMove:H,onDuplicate:V,onExport:G,onImport:I,onUpdateSettings:J})]})]})}),e.jsx(E,{children:D?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx(de,{className:"h-8 w-8 animate-spin mx-auto mb-2"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading page content..."})]})}):b?e.jsx("div",{className:"prose prose-sm max-w-none",children:e.jsx(ce,{content:b})}):e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(T,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No content available for this page"})]})})]}):e.jsx($,{children:e.jsx(E,{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx(M,{className:"h-16 w-16 mx-auto mb-4 text-muted-foreground"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Welcome to the Wiki"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Select a page from the sidebar to start reading"}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[e.jsx("p",{children:"‚úÖ Fast loading - only structure loaded initially"}),e.jsx("p",{children:"üìÑ Content loads on-demand when you open pages"}),e.jsx("p",{children:"üîç Search through page titles and categories"})]})]})})})})]})]})};export{Se as default};
