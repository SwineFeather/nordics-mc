const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DUDTAd9W.js","assets/index-DAFZuYWp.css"])))=>i.map(i=>d[i]);
import{I as _e,aF as m,s as j,r as i,ay as we,j as e,o as se,p as ae,q as ue,t as xe,bc as he,bd as Q,b5 as te,be as Z,v as p,O as re,aI as Ue,Y as Ne,X as Pe,aT as De,u as ve,aA as W,w as N,x as D,l as ye,m as be,n as Ce,B as T,z as v,U as me,a4 as Te,F as Se,ba as Fe,k as Le,G as ne,Q as Re,bi as Ie,M as $e,at as Ae,au as qe,av as ie,aw as le,y as I,aX as oe,bh as pe,ar as Me,H as Be,b7 as Oe}from"./index-DUDTAd9W.js";import{I as ce}from"./imageStorageService-DFMDSFOA.js";import{L as fe}from"./loader-circle-DMK_EDKw.js";import{I as Ee}from"./image-CKfeGsQ7.js";import{E as Ge}from"./external-link-BIoP0QEd.js";import{C as ze}from"./copy-DxsP4cii.js";import{F as We,L as Ve}from"./link-AkN5CDkb.js";import{U as Ye}from"./upload-tHEKoL-4.js";import{C as ge,D as Je,T as He}from"./TownPhotoGallery-PMBfHPkL.js";import{T as Xe}from"./TownProfilePicture-DhHVfOeY.js";import{E as Ke}from"./EnhancedWikiEditor-DIlszybt.js";import{S as Qe}from"./SimpleMarkdownRenderer-x9IIvLyT.js";import{T as Ze}from"./trending-up-obebY5n1.js";import{A as je}from"./arrow-left-BF2Td8_J.js";import{U as es}from"./user-plus-C6bBkbaX.js";import{H as ss}from"./house-DXLJ0JvH.js";import{C as as}from"./coins-DnpU2Pgu.js";import{P as ts}from"./pen-line-MjRWahhH.js";import"./download-Dh3YjV-9.js";import"./save-uvmCJEKY.js";import"./list-CaF9zg65.js";import"./minus-BIL9MBfk.js";import"./quote-DOE5sDw_.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rs=_e("Briefcase",[["path",{d:"M16 20V4a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16",key:"jecpp"}],["rect",{width:"20",height:"14",x:"2",y:"6",rx:"2",key:"i6l2r4"}]]);class de{static async updateTownImage(a,s){try{if(console.log(`Updating town image for town ${a} with URL: ${s}`),!this.isValidImageUrl(s))return m.error("Please provide a valid image URL (must end with .jpg, .jpeg, .png, .gif, .webp)"),!1;const{data:t,error:n}=await j.from("towns").select("name").eq("id",a).single();if(n||!t)return m.error("Town not found"),!1;const{data:d,error:l}=await j.from("towns").update({image_url:s}).eq("id",a).select().single();return l?(console.error("Error updating town image:",l),l.code==="42501"?m.error("You do not have permission to update this town's image. Only town mayors and staff can update town images."):m.error("Failed to update town image. Please try again."),!1):d?(m.success("Town image updated successfully!"),console.log("Town image updated successfully:",d),!0):(m.error("Town not found"),!1)}catch(t){return console.error("Error in updateTownImage:",t),m.error("An unexpected error occurred while updating the town image"),!1}}static async uploadTownImageFile(a,s){try{console.log(`Uploading image file for town ${a}`);const{data:t,error:n}=await j.from("towns").select("name").eq("id",a).single();if(n||!t)return m.error("Town not found"),!1;const d=await ce.uploadFile(s,t.name,"town"),{data:l,error:f}=await j.from("towns").update({image_url:d}).eq("id",a).select().single();return f?(console.error("Error updating town image:",f),f.code==="42501"?m.error("You do not have permission to update this town's image. Only town mayors and staff can update town images."):m.error("Failed to update town image. Please try again."),!1):l?(m.success("Town image uploaded successfully!"),console.log("Town image uploaded successfully:",l),!0):(m.error("Town not found"),!1)}catch(t){return console.error("Error in uploadTownImageFile:",t),m.error("An unexpected error occurred while uploading the town image"),!1}}static async getTownImage(a){try{const{data:s,error:t}=await j.from("towns").select("image_url").eq("id",a).single();return t?(console.error("Error fetching town image:",t),null):(s==null?void 0:s.image_url)||null}catch(s){return console.error("Error in getTownImage:",s),null}}static async canUpdateTownImage(a){try{const{data:{user:s},error:t}=await j.auth.getUser();if(t||!s)return!1;const{data:n,error:d}=await j.from("profiles").select("role, full_name").eq("id",s.id).single();if(d||!n)return!1;if(["admin","moderator"].includes(n.role))return!0;const{data:l,error:f}=await j.from("towns").select("mayor").eq("id",a).single();return f||!l?!1:l.mayor===n.full_name}catch(s){return console.error("Error checking town image update permissions:",s),!1}}static isValidImageUrl(a){try{const s=new URL(a),t=[".jpg",".jpeg",".png",".gif",".webp"],n=s.pathname.toLowerCase();return t.some(d=>n.endsWith(d))}catch{return!1}}static async getBlueMapUrl(a){return ce.generateBlueMapUrl(a,"town")}static getBlueMapUrlTemplate(){return ce.getBlueMapUrlTemplate("town")}static getImageProxyUrl(a){return a}static getRawImageUrl(a){return a}}const ns=({isOpen:u,onClose:a,townId:s,townName:t,currentImageUrl:n,onImageUpdated:d})=>{const[l,f]=i.useState(n||""),[F,S]=i.useState(!1),[o,k]=i.useState(!1),[V,Y]=i.useState(!0),[L,_]=i.useState(null),[$,A]=i.useState(null),[y,U]=i.useState(null),[ee,R]=i.useState(!1),[b,G]=i.useState("file"),[J,E]=i.useState(0),z=i.useRef(null);we(),i.useEffect(()=>{u&&(C(),f(n||""),_(n||null),U(null),E(0))},[u,n,s]);const C=async()=>{Y(!0);try{const r=await de.canUpdateTownImage(s);k(r)}catch(r){console.error("Error checking permissions:",r),k(!1)}finally{Y(!1)}},w=r=>{f(r),A(null),r&&H(r)?_(r):_(null)},H=r=>{try{const h=new URL(r),g=[".jpg",".jpeg",".png",".gif",".webp"],P=h.pathname.toLowerCase();return g.some(O=>P.endsWith(O))}catch{return!1}},X=r=>{var P;if(!r.type.startsWith("image/"))return"Please select an image file";if(r.size>5*1024*1024)return"File size must be less than 5MB";const h=[".jpg",".jpeg",".png",".gif",".webp"],g="."+((P=r.name.split(".").pop())==null?void 0:P.toLowerCase());return h.includes(g)?null:"Please select a JPEG, PNG, GIF, or WebP image"},q=i.useCallback(r=>{const h=X(r);if(h){m.error(h);return}U(r),A(null);const g=URL.createObjectURL(r);return _(g),()=>{g&&URL.revokeObjectURL(g)}},[]),M=i.useCallback(r=>{r.preventDefault(),r.stopPropagation(),r.type==="dragenter"||r.type==="dragover"?R(!0):r.type==="dragleave"&&R(!1)},[]),K=i.useCallback(r=>{r.preventDefault(),r.stopPropagation(),R(!1);const g=Array.from(r.dataTransfer.files).find(P=>P.type.startsWith("image/"));g?q(g):m.error("Please drop an image file")},[q]),c=async r=>{if(r.preventDefault(),!(b==="url"&&!l.trim())&&!(b==="file"&&!y)){S(!0),E(0);try{let h;if(b==="file"&&y){E(50);const P=await de.uploadTownImageFile(s,y);if(E(100),P){const{data:O}=await j.from("towns").select("image_url").eq("id",s).single();O!=null&&O.image_url&&(d==null||d(O.image_url)),a()}return}else h=l.trim();E(75);const g=await de.updateTownImage(s,h);E(100),g&&(d==null||d(h),a())}catch(h){console.error("Error updating town image:",h),m.error("An unexpected error occurred")}finally{S(!1),E(0)}}},x=()=>{A("Failed to load image preview")},B=()=>{U(null),_(n||null),z.current&&(z.current.value="")};return V?e.jsx(se,{open:u,onOpenChange:a,children:e.jsx(ae,{className:"max-w-3xl",children:e.jsxs("div",{className:"flex items-center justify-center p-8",children:[e.jsx(fe,{className:"h-8 w-8 animate-spin"}),e.jsx("span",{className:"ml-2",children:"Checking permissions..."})]})})}):o?e.jsx(se,{open:u,onOpenChange:a,children:e.jsxs(ae,{className:"max-w-3xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(ue,{children:[e.jsx(xe,{className:"text-lg",children:"Update Town Image"}),e.jsxs(he,{children:["Update the image for ",t,". You can upload a file or provide an image URL."]})]}),e.jsxs("form",{onSubmit:c,className:"space-y-6",children:[n&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(re,{className:"text-sm font-medium",children:"Current Image"}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx(Ee,{className:"h-4 w-4 flex-shrink-0"}),e.jsx("span",{className:"truncate flex-1",title:n,children:n.includes("supabase.co/storage")?"Stored in Supabase Storage":n.length>50?n.substring(0,50)+"...":n}),e.jsx(p,{type:"button",variant:"ghost",size:"sm",onClick:()=>window.open(n,"_blank"),className:"flex-shrink-0",title:"Open image in new tab",children:e.jsx(Ge,{className:"h-4 w-4"})}),e.jsx(p,{type:"button",variant:"ghost",size:"sm",onClick:()=>navigator.clipboard.writeText(n),className:"flex-shrink-0",title:"Copy image URL",children:e.jsx(ze,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs(p,{type:"button",variant:b==="file"?"default":"outline",size:"sm",onClick:()=>G("file"),className:"flex items-center gap-2",children:[e.jsx(We,{className:"h-4 w-4"}),"Upload File"]}),e.jsxs(p,{type:"button",variant:b==="url"?"default":"outline",size:"sm",onClick:()=>G("url"),className:"flex items-center gap-2",children:[e.jsx(Ve,{className:"h-4 w-4"}),"Image URL"]})]}),b==="file"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:`border-2 border-dashed rounded-lg p-6 text-center transition-colors ${ee?"border-primary bg-primary/5":"border-muted-foreground/25"}`,onDragEnter:M,onDragLeave:M,onDragOver:M,onDrop:K,children:[e.jsx("input",{ref:z,type:"file",accept:"image/*",onChange:r=>{var g;const h=(g=r.target.files)==null?void 0:g[0];h&&q(h)},className:"hidden"}),y?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm",children:[e.jsx(Ue,{className:"h-5 w-5 text-green-500"}),e.jsx("span",{className:"font-medium",children:y.name}),e.jsx(p,{type:"button",variant:"ghost",size:"sm",onClick:B,className:"h-6 w-6 p-0",children:e.jsx(Ne,{className:"h-4 w-4"})})]}),L&&e.jsx("div",{className:"flex justify-center",children:e.jsx("img",{src:L,alt:"Preview",className:"max-h-32 max-w-full rounded border",onError:x})})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx(Ye,{className:"mx-auto h-12 w-12 text-muted-foreground"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{className:"text-sm font-medium",children:["Drop your image here, or"," ",e.jsx("button",{type:"button",onClick:()=>{var r;return(r=z.current)==null?void 0:r.click()},className:"text-primary hover:underline",children:"browse"})]}),e.jsx("p",{className:"text-xs text-muted-foreground overflow-hidden min-w-0 break-words max-w-full",children:"Supports JPEG, PNG, GIF, WebP up to 5MB"})]})]})]}),$&&e.jsxs(Q,{variant:"destructive",children:[e.jsx(te,{className:"h-4 w-4"}),e.jsx(Z,{children:$})]})]}),b==="url"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(re,{htmlFor:"imageUrl",className:"text-sm font-medium",children:"Image URL"}),e.jsx(Pe,{id:"imageUrl",type:"url",placeholder:"https://example.com/image.png",value:l,onChange:r=>w(r.target.value),className:"mt-1"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Enter a direct link to an image (JPEG, PNG, GIF, WebP)"})]}),L&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(re,{className:"text-sm font-medium",children:"Preview"}),e.jsx("div",{className:"flex justify-center",children:e.jsx("img",{src:L,alt:"Preview",className:"max-h-32 max-w-full rounded border",onError:x})})]}),$&&e.jsxs(Q,{variant:"destructive",children:[e.jsx(te,{className:"h-4 w-4"}),e.jsx(Z,{children:$})]})]}),J>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Uploading..."}),e.jsxs("span",{children:[J,"%"]})]}),e.jsx("div",{className:"w-full bg-muted rounded-full h-2",children:e.jsx("div",{className:"bg-primary h-2 rounded-full transition-all duration-300",style:{width:`${J}%`}})})]}),e.jsxs(Q,{children:[e.jsx(De,{className:"h-4 w-4"}),e.jsx(Z,{children:"The image will be stored on our server and made available for BlueMap compatibility. Make sure you have permission to use the image you're uploading."})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(p,{type:"button",variant:"outline",onClick:a,children:"Cancel"}),e.jsx(p,{type:"submit",disabled:F||b==="file"&&!y||b==="url"&&!l.trim(),children:F?e.jsxs(e.Fragment,{children:[e.jsx(fe,{className:"mr-2 h-4 w-4 animate-spin"}),"Updating..."]}):"Update Image"})]})]})]})}):e.jsx(se,{open:u,onOpenChange:a,children:e.jsxs(ae,{className:"max-w-3xl",children:[e.jsxs(ue,{children:[e.jsx(xe,{className:"text-lg",children:"Update Town Image"}),e.jsxs(he,{children:["Update the image for ",t]})]}),e.jsxs(Q,{children:[e.jsx(te,{className:"h-4 w-4"}),e.jsx(Z,{children:"You do not have permission to update this town's image. Only town mayors and staff can update town images."})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(p,{onClick:a,children:"Close"})})]})})};class is{static async updateTownDescription(a,s){try{console.log(`Updating town description for town ${a} with description: "${s}"`);const{data:t,error:n}=await j.from("towns").select("id, name, mayor_uuid").eq("id",a).single();if(n)return console.error("Error fetching existing town data:",n),m.error("Failed to fetch town data"),!1;if(!t)return console.error("Town not found with ID:",a),m.error("Town not found"),!1;console.log("Existing town data:",t);const{data:d,error:l}=await j.from("towns").update({description:s}).eq("id",a).select().single();return l?(console.error("Error updating town description:",l),console.error("Error details:",{code:l.code,message:l.message,details:l.details,hint:l.hint}),l.code==="42501"?m.error("You do not have permission to update this town's description. Only town mayors, co-mayors, and assistants can update town descriptions."):m.error(`Failed to update town description: ${l.message}`),!1):d?(console.log("Town description updated successfully:",d),m.success("Town description updated successfully!"),!0):(console.error("No data returned after update"),m.error("Town not found"),!1)}catch(t){return console.error("Error in updateTownDescription:",t),m.error("An unexpected error occurred while updating the town description"),!1}}static async getTownDescription(a){try{const{data:s,error:t}=await j.from("towns").select("description").eq("id",a).single();return t?(console.error("Error fetching town description:",t),null):(s==null?void 0:s.description)||null}catch(s){return console.error("Error in getTownDescription:",s),null}}static async canUpdateTownDescription(a,s){try{const{data:t,error:n}=await j.from("towns").select("mayor_uuid").eq("id",a).single();return n||!t?!1:t.mayor_uuid===s}catch(t){return console.error("Error in canUpdateTownDescription:",t),!1}}}class ke{static async getTownCompanies(a){try{console.log(`Getting companies for town ID: ${a}`);const{data:s,error:t}=await j.from("companies").select(`
          id,
          name,
          slug,
          tagline,
          description,
          logo_url,
          banner_url,
          industry,
          business_type,
          member_count,
          max_members,
          is_public,
          is_featured,
          average_rating,
          review_count,
          total_revenue,
          status,
          verification_status,
          created_at,
          updated_at,
          owner_uuid,
          ceo_uuid
        `).eq("town_id",a).eq("status","active").eq("is_public",!0).order("is_featured",{ascending:!1}).order("average_rating",{ascending:!1}).order("created_at",{ascending:!1});return t?(console.error("Error fetching town companies:",t),[]):(console.log(`Found ${(s==null?void 0:s.length)||0} companies for town ${a}`),s||[])}catch(s){return console.error("Error in getTownCompanies:",s),[]}}static async getTownCompanyCount(a){try{const{count:s,error:t}=await j.from("companies").select("*",{count:"exact",head:!0}).eq("town_id",a).eq("status","active").eq("is_public",!0);return t?(console.error("Error fetching town company count:",t),0):s||0}catch(s){return console.error("Error in getTownCompanyCount:",s),0}}}const ls=({townId:u})=>{const[a,s]=i.useState([]),[t,n]=i.useState(!0),[d,l]=i.useState(null),f=ve();i.useEffect(()=>{(async()=>{try{n(!0),l(null);const k=await ke.getTownCompanies(u);s(k)}catch(k){l("Failed to fetch companies"),console.error("Error fetching companies:",k)}finally{n(!1)}})()},[u]);const F=o=>{try{return new Date(o).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}catch{return"Unknown"}},S=o=>o>=1e6?`$${(o/1e6).toFixed(1)}M`:o>=1e3?`$${(o/1e3).toFixed(1)}K`:`$${o.toFixed(0)}`;return t?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading companies..."})]})}):d?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"text-red-500 mb-4",children:e.jsx(W,{className:"w-12 h-12 mx-auto opacity-50"})}),e.jsx("p",{className:"text-muted-foreground",children:"Failed to load companies"}),e.jsx(p,{variant:"outline",size:"sm",className:"mt-2",onClick:()=>window.location.reload(),children:"Retry"})]}):a.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(W,{className:"w-12 h-12 mx-auto mb-3 opacity-30"}),e.jsx("p",{className:"text-lg font-medium mb-2",children:"No companies registered"}),e.jsx("p",{className:"text-sm",children:"This town doesn't have any registered companies yet."})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("p",{className:"text-sm text-muted-foreground",children:[a.length," ",a.length===1?"company":"companies"," registered in this town"]})}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:a.map(o=>e.jsxs(N,{className:"hover:shadow-lg transition-shadow cursor-pointer",children:[e.jsx(D,{className:"pb-3",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(ye,{className:"w-12 h-12",children:[e.jsx(be,{src:o.logo_url||void 0,alt:o.name}),e.jsx(Ce,{className:"bg-primary/10 text-primary",children:o.name.charAt(0).toUpperCase()})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"font-semibold text-lg truncate cursor-pointer hover:text-primary transition-colors",onClick:()=>f(`/company/${o.slug}`),children:o.name}),o.tagline&&e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:o.tagline})]})]}),o.is_featured&&e.jsx(T,{variant:"default",className:"bg-yellow-600 text-xs",children:"Featured"})]})}),e.jsx(v,{className:"pt-0",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[o.industry&&e.jsxs(T,{variant:"outline",className:"text-xs",children:[e.jsx(rs,{className:"w-3 h-3 mr-1"}),o.industry]}),o.business_type&&e.jsx(T,{variant:"outline",className:"text-xs",children:o.business_type})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(me,{className:"w-4 h-4 text-muted-foreground"}),e.jsxs("span",{children:[o.member_count," staff"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Te,{className:"w-4 h-4 text-yellow-500"}),e.jsxs("span",{children:[o.average_rating.toFixed(1)," (",o.review_count,")"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ze,{className:"w-4 h-4 text-green-500"}),e.jsx("span",{children:S(o.total_revenue)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Se,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{children:F(o.created_at)})]})]})]})})]},o.id))})]})},os=({townId:u})=>{const[a,s]=i.useState(0),[t,n]=i.useState(!0);return i.useEffect(()=>{(async()=>{try{const l=await ke.getTownCompanyCount(u);s(l)}catch(l){console.error("Error fetching company count:",l),s(0)}finally{n(!1)}})()},[u]),t?e.jsx("span",{className:"text-muted-foreground",children:"..."}):e.jsx("span",{children:a})},Ds=()=>{var H,X,q,M,K;const{townName:u}=Fe(),a=ve(),[s,t]=i.useState(null),[n,d]=i.useState([]),[l,f]=i.useState(!0),[F,S]=i.useState(null),[o,k]=i.useState("overview");i.useState(!0),i.useState(!0);const[V,Y]=i.useState("supabase"),[L,_]=i.useState(null),[$,A]=i.useState(!1),[y,U]=i.useState(!1),[ee,R]=i.useState(""),[b,G]=i.useState(!1),{profiles:J,getProfileByUsername:E}=Le({fetchAll:!0}),{user:z,userRole:C,profile:w}=we();return i.useEffect(()=>{(async()=>{if(!u){S("Town name is required"),f(!1);return}console.log("Fetching town data:",decodeURIComponent(u));try{f(!0),S(null);const x=await pe.getTown(decodeURIComponent(u));if(!x){S("Town not found"),f(!1);return}t(x),d(x.residents||[]),R(x.description||""),Y("supabase")}catch(x){console.error("Error fetching town data:",x),S(x instanceof Error?x.message:"Failed to fetch town data")}finally{f(!1)}})()},[u]),l?e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading town data..."})]})})}):F||!s?e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-4xl mb-4",children:"🏘️"}),e.jsx("h1",{className:"text-2xl font-bold mb-2",children:"Town Not Found"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:F||"The requested town could not be found."}),e.jsxs("p",{className:"text-sm text-muted-foreground mb-4",children:["Requested: ",u?decodeURIComponent(u):"No town name"]}),e.jsxs("div",{className:"flex gap-2 justify-center",children:[e.jsxs(p,{onClick:()=>a("/towns"),children:[e.jsx(je,{className:"w-4 h-4 mr-2"}),"Back to Towns"]}),e.jsx(p,{variant:"outline",onClick:()=>window.location.reload(),children:"Retry"})]})]})})}):e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("div",{className:"relative bg-gradient-to-br from-primary/10 to-secondary/10 py-8",children:e.jsxs("div",{className:"container mx-auto px-4",children:[e.jsx("div",{className:"mb-6",children:e.jsxs(p,{variant:"outline",onClick:()=>a("/towns"),children:[e.jsx(je,{className:"w-4 h-4 mr-2"}),"Back to Towns"]})}),e.jsx("div",{className:"flex flex-col md:flex-row gap-6 items-start",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(Xe,{townName:s.name,className:"h-64 w-64 object-contain",imageUrl:s.image_url}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("h1",{className:"text-4xl font-bold",children:s.name}),e.jsx(T,{className:s.capital?"bg-yellow-600":"bg-blue-600",children:s.capital?"Capital":"Town"}),e.jsx(T,{className:s.public?"bg-green-600":"bg-gray-600",children:s.public?"Public":"Private"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsxs(T,{variant:"outline",className:"flex items-center gap-1",children:[e.jsx(ne,{className:"w-3 h-3"}),"Mayor:",e.jsx("button",{className:"font-medium hover:underline text-left ml-1",onClick:()=>{a(`/community?player=${encodeURIComponent(s.mayor)}`)},children:s.mayor})]}),s.nation&&e.jsxs(T,{variant:"outline",className:"flex items-center gap-1",children:[e.jsx(Re,{className:"w-3 h-3"}),s.nation.name]})]}),e.jsxs("p",{className:"text-muted-foreground max-w-2xl",children:[s.capital?"Capital city":"Town"," in ",((H=s.nation)==null?void 0:H.name)||"Unknown Nation"," with ",s.resident_count," residents."]})]})]})}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-6",children:[e.jsxs(p,{className:"flex items-center gap-2",children:[e.jsx(es,{className:"w-4 h-4"}),"Request to Join"]}),e.jsxs(p,{variant:"outline",className:"flex items-center gap-2",onClick:()=>{const c=s.mayor;c&&(async()=>{try{const{data:x,error:B}=await(await Ie(async()=>{const{supabase:r}=await import("./index-DUDTAd9W.js").then(h=>h.cd);return{supabase:r}},__vite__mapDeps([0,1]))).supabase.from("profiles").select("id").eq("minecraft_username",c).single();!B&&(x!=null&&x.id)?a(`/messages?with=${encodeURIComponent(x.id)}`):a(`/community?player=${encodeURIComponent(c)}`)}catch{a(`/community?player=${encodeURIComponent(c)}`)}})()},children:[e.jsx($e,{className:"w-4 h-4"}),"Message Mayor"]}),((s==null?void 0:s.mayor)===(w==null?void 0:w.minecraft_username)||C==="admin"||C==="moderator")&&e.jsxs(p,{variant:"outline",className:"flex items-center gap-2",onClick:()=>A(!0),children:[e.jsx(Ee,{className:"w-4 h-4"}),"Update Image"]})]})]})}),e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsxs(Ae,{value:o,onValueChange:k,className:"w-full",children:[e.jsxs(qe,{className:"grid w-full grid-cols-3 mb-8 h-12",children:[e.jsxs(ie,{value:"overview",className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(ss,{className:"w-4 h-4"}),"Overview"]}),e.jsxs(ie,{value:"gallery",className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(ge,{className:"w-4 h-4"}),"Gallery"]}),e.jsxs(ie,{value:"companies",className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(W,{className:"w-4 h-4"}),"Companies"]})]}),e.jsxs(le,{value:"overview",className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3",children:[e.jsx(N,{className:"w-auto min-w-0",children:e.jsx(v,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(me,{className:"w-6 h-6 text-primary flex-shrink-0"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Population"}),e.jsx("p",{className:"text-lg font-bold truncate",children:s.resident_count})]})]})})}),e.jsx(N,{className:"w-auto min-w-0",children:e.jsx(v,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Se,{className:"w-6 h-6 text-primary flex-shrink-0"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Founded"}),e.jsx("p",{className:"text-lg font-bold truncate",children:new Date(s.created).toLocaleDateString()})]})]})})}),e.jsx(N,{className:"w-auto min-w-0",children:e.jsx(v,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Te,{className:"w-6 h-6 text-primary flex-shrink-0"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Plots"}),e.jsx("p",{className:"text-lg font-bold truncate",children:((q=(X=s.plots)==null?void 0:X[0])==null?void 0:q.count)||0})]})]})})}),e.jsx(N,{className:"w-auto min-w-0",children:e.jsx(v,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(as,{className:"w-6 h-6 text-primary flex-shrink-0"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Balance"}),e.jsxs("p",{className:"text-lg font-bold truncate",children:["$",(s.balance||0).toFixed(2)]})]})]})})}),e.jsx(N,{className:"w-auto min-w-0",children:e.jsx(v,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(W,{className:"w-6 h-6 text-primary flex-shrink-0"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Companies"}),e.jsx("p",{className:"text-lg font-bold truncate",children:e.jsx(os,{townId:parseInt(s.id)})})]})]})})})]}),e.jsxs(N,{children:[e.jsx(D,{children:e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"w-5 h-5"}),"Town Description",((s==null?void 0:s.mayor)===(w==null?void 0:w.minecraft_username)||C==="admin"||C==="moderator")&&e.jsx(p,{size:"sm",variant:"outline",onClick:()=>{y?U(!1):(R(s.description||""),U(!0))},className:"ml-auto",children:y?e.jsxs(e.Fragment,{children:[e.jsx(Ne,{className:"w-4 h-4 mr-2"}),"Cancel"]}):e.jsxs(e.Fragment,{children:[e.jsx(ts,{className:"w-4 h-4 mr-2"}),"Edit"]})})]})}),e.jsx(v,{children:y?e.jsx("div",{className:"max-w-4xl mx-auto",children:e.jsx(Ke,{page:{content:ee,title:s.name,status:"published",updatedAt:"",authorName:"",id:s.id,slug:s.name.toLowerCase().replace(/\s+/g,"-"),authorId:(w==null?void 0:w.id)||"",createdAt:s.created_at,category:null,order:0},userRole:C==="admin"||C==="moderator"?"admin":"member",isEditing:!0,onSave:async c=>{G(!0);const x=await is.updateTownDescription(parseInt(s.id),c.content||"");if(G(!1),x){U(!1),R(c.content||"");const B=await pe.getTown(decodeURIComponent(u||""));B&&t(B)}},onToggleEdit:()=>U(!1),autoSaveEnabled:!1,onAutoSaveToggle:()=>{}})}):e.jsx("div",{className:"prose max-w-4xl mx-auto px-4",children:s.description?e.jsx(Qe,{content:s.description}):e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(oe,{className:"w-12 h-12 mx-auto mb-3 opacity-30"}),e.jsx("p",{className:"text-lg font-medium mb-2",children:"No description yet"}),e.jsx("p",{className:"text-sm",children:(w==null?void 0:w.minecraft_username)===s.mayor||C==="admin"||C==="moderator"?"Add a description to tell visitors about your town!":"This town hasn't added a description yet."})]})})})]}),e.jsxs(N,{children:[e.jsx(D,{children:e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(me,{className:"w-5 h-5"}),"Residents (",n.length,")",V==="mock"&&e.jsx(T,{variant:"secondary",className:"text-xs",children:"Mock Data"})]})}),e.jsxs(v,{children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:n.map(c=>e.jsxs("div",{className:"flex items-center gap-3 p-3 border rounded-lg",children:[e.jsxs(ye,{className:"w-10 h-10",children:[e.jsx(be,{src:`https://mc-heads.net/avatar/${c.name}/100`,alt:c.name}),e.jsx(Ce,{children:c.name.charAt(0).toUpperCase()})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"font-medium truncate hover:underline text-left",onClick:()=>{a(`/community?player=${encodeURIComponent(c.name)}`)},children:c.name}),c.is_mayor&&e.jsxs(T,{variant:"default",className:"bg-yellow-600 text-xs",children:[e.jsx(ne,{className:"w-3 h-3 mr-1"}),"Mayor"]}),c.is_king&&e.jsxs(T,{variant:"default",className:"bg-purple-600 text-xs",children:[e.jsx(ne,{className:"w-3 h-3 mr-1"}),"King"]})]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Joined: ",new Date(c.joined).toLocaleDateString()]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Last online: ",new Date(c.last_online).toLocaleDateString()]})]})]},c.uuid))}),L&&(()=>{const c=E(L);return c?e.jsx(Me,{profile:c,onClose:()=>_(null)}):e.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-50 bg-black/40",children:e.jsxs("div",{className:"bg-white dark:bg-card p-8 rounded-lg shadow-lg flex flex-col items-center",children:[e.jsx("div",{className:"text-muted-foreground mb-4",children:"Player profile not found."}),e.jsx("button",{className:"text-sm underline",onClick:()=>_(null),children:"Close"})]})})})(),V==="mock"&&e.jsx("div",{className:"mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-yellow-800",children:[e.jsx("span",{className:"font-medium",children:"Note:"}),e.jsx("span",{children:"Showing mock data. The real API may be unavailable or experiencing CORS issues."})]})})]})]}),e.jsxs(N,{children:[e.jsx(D,{children:e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(Be,{className:"w-5 h-5"}),"Live Map View"]})}),e.jsx(v,{children:e.jsx(Je,{townName:s.name,coordinates:{x:s.spawn.x,z:s.spawn.z},className:"w-full"})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(N,{children:[e.jsx(D,{children:e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"w-5 h-5"}),"Town Information"]})}),e.jsxs(v,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Basic Information"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Name:"}),e.jsx("span",{className:"font-medium",children:s.name})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Type:"}),e.jsx("span",{className:"font-medium",children:s.capital?"Capital":"Town"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Status:"}),e.jsx("span",{className:"font-medium",children:s.public?"Public":"Private"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Mayor:"}),e.jsx("button",{className:"font-medium hover:underline text-left",onClick:()=>{a(`/community?player=${encodeURIComponent(s.mayor)}`)},children:s.mayor})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Founded:"}),e.jsx("span",{className:"font-medium",children:new Date(s.created).toLocaleDateString()})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Open:"}),e.jsx("span",{className:"font-medium",children:s.open?"Yes":"No"})]})]})]}),s.nation&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Nation Information"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Nation:"}),e.jsx("span",{className:"font-medium",children:s.nation.name})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Capital:"}),e.jsx("span",{className:"font-medium",children:s.nation.capital})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Balance:"}),e.jsxs("span",{className:"font-medium",children:["$",(s.nation.balance||0).toFixed(2)]})]})]})]})]})]}),e.jsxs(N,{children:[e.jsx(D,{children:e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(Oe,{className:"w-5 h-5"}),"Statistics"]})}),e.jsxs(v,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Current Stats"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Population:"}),e.jsxs("span",{className:"font-medium",children:[s.resident_count," residents"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Total Plots:"}),e.jsx("span",{className:"font-medium",children:((K=(M=s.plots)==null?void 0:M[0])==null?void 0:K.count)||0})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Balance:"}),e.jsxs("span",{className:"font-medium",children:["$",(s.balance||0).toFixed(2)]})]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Location"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"World:"}),e.jsx("span",{className:"font-medium",children:s.spawn.world})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Coordinates:"}),e.jsxs("span",{className:"font-medium",children:[s.spawn.x.toFixed(1),", ",s.spawn.z.toFixed(1)]})]})]})]})]})]})]})]}),e.jsx(le,{value:"gallery",children:e.jsxs(N,{children:[e.jsx(D,{children:e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(ge,{className:"w-5 h-5"}),"Photo Gallery"]})}),e.jsx(v,{children:e.jsx(He,{townName:s.name})})]})}),e.jsx(le,{value:"companies",children:e.jsxs(N,{children:[e.jsx(D,{children:e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(W,{className:"w-5 h-5"}),"Town Companies"]})}),e.jsx(v,{children:e.jsx(ls,{townId:parseInt(s.id)})})]})})]})}),e.jsx(ns,{isOpen:$,onClose:()=>A(!1),townId:s.id,townName:s.name,currentImageUrl:s.image_url,onImageUpdated:c=>{t(x=>x?{...x,image_url:c}:null)}})]})};export{Ds as default};
