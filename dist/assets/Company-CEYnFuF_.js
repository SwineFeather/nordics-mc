import{I as ts,aF as d,s as u,j as e,a4 as J,ay as Be,r as i,w as U,z as D,x as G,y as H,v as h,b1 as Ve,M as we,a5 as as,B as Y,ba as rs,u as ns,aA as Pe,a6 as is,Q as os,b7 as ls,U as be,bj as Le,at as cs,au as ds,av as ne,aw as ie,H as Oe,b8 as ms,o as ce,p as de,q as me,t as ue,b6 as us,bc as xs,X as Z,O as T,Z as ge,$ as pe,a0 as fe,a1 as je,a2 as L}from"./index-BDwxLbfg.js";import{S as hs}from"./SimpleMarkdownRenderer-48bOWxLE.js";import{I as gs}from"./imageStorageService-Bbnc4G-y.js";import{C as ps}from"./CreateCompanyModal-uGax7U5r.js";import{u as fs}from"./usePlayerSearch-6-rZ-bFC.js";import{u as Ye}from"./useShopsData-DSSRsv2y.js";import{S as js}from"./ShopMapEmbed-H36lczdu.js";import{E as ys}from"./EnhancedWikiEditor-BPVwHkpi.js";import{P as vs}from"./playerTownService-Cn9WKRSh.js";import{S as Ns}from"./ShopCard-ChrMdGbc.js";import{e as bs,h as ws}from"./MinecraftItemImage-B08oUpod.js";import{U as xe}from"./upload-B5TiAeXb.js";import{U as _s}from"./user-plus-v6PF39qN.js";import{T as $e}from"./trending-up-CmxDmib0.js";import"./external-link-DMGOVlse.js";import"./loader-circle-BQXbm3ye.js";import"./copy-D3RDa5qZ.js";import"./image-CdpHxvLf.js";import"./minus-BS56cca9.js";import"./save-CBFCkKxY.js";import"./quote-BAutpiux.js";import"./list-DgrYmvyF.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ss=ts("UserMinus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]);class Cs{static async updateCompanyLogo(c,a){try{if(console.log(`Updating company logo for company ${c} with URL: ${a}`),!this.isValidImageUrl(a))return d.error("Please provide a valid image URL (must end with .jpg, .jpeg, .png, .gif, .webp)"),!1;const{data:r,error:s}=await u.from("companies").select("name").eq("id",c).single();if(s||!r)return d.error("Company not found"),!1;const{data:p,error:l}=await u.from("companies").update({logo_url:a}).eq("id",c).select().single();return l?(console.error("Error updating company logo:",l),l.code==="42501"?d.error("You do not have permission to update this company's logo. Only company owners and staff can update company logos."):d.error("Failed to update company logo. Please try again."),!1):p?(d.success("Company logo updated successfully!"),console.log("Company logo updated successfully:",p),!0):(d.error("Company not found"),!1)}catch(r){return console.error("Error in updateCompanyLogo:",r),d.error("An unexpected error occurred while updating the company logo"),!1}}static async uploadCompanyLogoFile(c,a){try{console.log(`Uploading logo file for company ${c}`);const{data:r,error:s}=await u.from("companies").select("name").eq("id",c).single();if(s||!r)return d.error("Company not found"),!1;const p=await gs.uploadFile(a,r.name,"company"),{data:l,error:x}=await u.from("companies").update({logo_url:p}).eq("id",c).select().single();return x?(console.error("Error updating company logo:",x),x.code==="42501"?d.error("You do not have permission to update this company's logo. Only company owners and staff can update company logos."):d.error("Failed to update company logo. Please try again."),!1):l?(d.success("Company logo uploaded successfully!"),console.log("Company logo uploaded successfully:",l),!0):(d.error("Company not found"),!1)}catch(r){return console.error("Error in uploadCompanyLogoFile:",r),d.error("An unexpected error occurred while uploading the company logo"),!1}}static async getCompanyLogo(c){try{const{data:a,error:r}=await u.from("companies").select("logo_url").eq("id",c).single();return r?(console.error("Error fetching company logo:",r),null):(a==null?void 0:a.logo_url)||null}catch(a){return console.error("Error in getCompanyLogo:",a),null}}static async canUpdateCompanyLogo(c){try{const{data:{user:a}}=await u.auth.getUser();if(!a)return!1;const{data:r}=await u.from("profiles").select("role").eq("id",a.id).single();if((r==null?void 0:r.role)==="admin"||(r==null?void 0:r.role)==="moderator")return!0;const{data:s}=await u.from("companies").select("owner_uuid").eq("id",c).single();return(s==null?void 0:s.owner_uuid)===a.id}catch(a){return console.error("Error checking company logo update permissions:",a),!1}}static isValidImageUrl(c){const a=[".jpg",".jpeg",".png",".gif",".webp"],r=c.toLowerCase();return a.some(s=>r.endsWith(s))}}const ks=({rating:j,reviewCount:c,size:a="md",showCount:r=!0})=>{const s={sm:"w-4 h-4",md:"w-5 h-5",lg:"w-6 h-6"},p={sm:"text-xs",md:"text-sm",lg:"text-base"},l=()=>e.jsx("div",{className:"flex items-center gap-1",children:[1,2,3,4,5].map(x=>e.jsx(J,{className:`${s[a]} ${x<=j?"text-yellow-400 fill-current":"text-gray-300"}`},x))});return j===0&&c===0?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex items-center gap-1",children:[1,2,3,4,5].map(x=>e.jsx(J,{className:`${s[a]} text-gray-300`},x))}),r&&e.jsx("span",{className:`${p[a]} text-muted-foreground`,children:"No ratings yet"})]}):e.jsxs("div",{className:"flex items-center gap-2",children:[l(),r&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:`${p[a]} font-medium`,children:j>0?j.toFixed(1):"No ratings yet"}),j>0&&e.jsxs("span",{className:`${p[a]} text-muted-foreground`,children:["(",c," ",c===1?"review":"reviews",")"]})]})]})};class he{static async submitRating(c,a,r,s,p){try{const{data:l}=await u.from("company_ratings").select("id").eq("company_id",c).eq("user_id",s).single();if(l){const{error:x}=await u.from("company_ratings").update({rating:a,comment:r,updated_at:new Date().toISOString()}).eq("id",l.id);if(x)throw x;d.success("Rating updated successfully!")}else{const{error:x}=await u.from("company_ratings").insert({company_id:c,user_id:s,username:p,rating:a,comment:r,created_at:new Date().toISOString(),updated_at:new Date().toISOString()});if(x)throw x;d.success("Rating submitted successfully!")}return await this.updateCompanyRatingStats(c),!0}catch(l){return console.error("Error submitting rating:",l),d.error("Failed to submit rating"),!1}}static async getCompanyRatings(c){try{const{data:a,error:r}=await u.from("company_ratings").select("*").eq("company_id",c).order("created_at",{ascending:!1});if(r)throw r;return a||[]}catch(a){return console.error("Error fetching company ratings:",a),[]}}static async getCompanyRatingStats(c){try{const{data:a,error:r}=await u.from("company_ratings").select("rating").eq("company_id",c);if(r)throw r;const s=a||[],p=s.length;if(p===0)return{average_rating:0,total_ratings:0,rating_distribution:{}};const l=s.reduce((g,b)=>g+b.rating,0)/p,x={};for(let g=1;g<=5;g++)x[g]=s.filter(b=>b.rating===g).length;return{average_rating:Math.round(l*10)/10,total_ratings:p,rating_distribution:x}}catch(a){return console.error("Error fetching rating stats:",a),{average_rating:0,total_ratings:0,rating_distribution:{}}}}static async getUserRating(c,a){try{const{data:r,error:s}=await u.from("company_ratings").select("*").eq("company_id",c).eq("user_id",a).single();if(s&&s.code!=="PGRST116")throw s;return r}catch(r){return console.error("Error fetching user rating:",r),null}}static async updateCompanyRatingStats(c){try{const a=await this.getCompanyRatingStats(c),{error:r}=await u.from("companies").update({average_rating:a.average_rating,review_count:a.total_ratings}).eq("id",c);if(r)throw r}catch(a){console.error("Error updating company rating stats:",a)}}}const Es=({companyId:j,companyName:c})=>{const{user:a,profile:r}=Be(),[s,p]=i.useState([]),[l,x]=i.useState({average_rating:0,total_ratings:0,rating_distribution:{}}),[g,b]=i.useState(null),[f,v]=i.useState(!1),[k,n]=i.useState(5),[_,R]=i.useState(""),[O,$]=i.useState(!1),[F,W]=i.useState(!0);i.useEffect(()=>{M()},[j]);const M=async()=>{try{W(!0);const[y,m]=await Promise.all([he.getCompanyRatings(j),he.getCompanyRatingStats(j)]);if(p(y),x(m),a){const S=await he.getUserRating(j,a.id);b(S),S&&(n(S.rating),R(S.comment))}}catch(y){console.error("Error fetching ratings:",y)}finally{W(!1)}},B=async()=>{if(!a||!r){d.error("You must be logged in to submit a rating");return}if(!_.trim()){d.error("Please provide a comment with your rating");return}$(!0);try{await he.submitRating(j,k,_.trim(),a.id,r.minecraft_username||"Unknown User")&&(v(!1),await M())}finally{$(!1)}},K=()=>{v(!0)},V=()=>{v(!1),g?(n(g.rating),R(g.comment)):(n(5),R(""))},z=(y,m=!1,S="w-5 h-5")=>e.jsx("div",{className:"flex items-center gap-1",children:[1,2,3,4,5].map(w=>e.jsx(J,{className:`${S} ${w<=y?"text-yellow-400 fill-current":"text-gray-300"} ${m?"cursor-pointer hover:text-yellow-300":""}`,onClick:()=>m&&n(w)},w))});return F?e.jsx(U,{children:e.jsx(D,{className:"p-6",children:e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4 mb-4"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/2"})]})})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs(U,{children:[e.jsx(G,{children:e.jsxs(H,{className:"flex items-center gap-2",children:[e.jsx(J,{className:"w-5 h-5 text-yellow-400"}),"Ratings & Reviews"]})}),e.jsxs(D,{children:[e.jsxs("div",{className:"flex items-center gap-6 mb-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-3xl font-bold text-primary",children:l.average_rating>0?l.average_rating.toFixed(1):"No ratings yet"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:l.average_rating>0?"out of 5":""}),l.average_rating>0?z(l.average_rating):e.jsx("div",{className:"flex items-center gap-1 justify-center mt-2",children:[1,2,3,4,5].map(y=>e.jsx(J,{className:"w-5 h-5 text-gray-300"},y))}),e.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:l.total_ratings>0?`${l.total_ratings} ${l.total_ratings===1?"rating":"ratings"}`:"No ratings yet"})]}),e.jsx("div",{className:"flex-1",children:e.jsx("div",{className:"space-y-2",children:[5,4,3,2,1].map(y=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm w-8",children:[y,"★"]}),e.jsx("div",{className:"flex-1 bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-yellow-400 h-2 rounded-full",style:{width:`${l.total_ratings>0?(l.rating_distribution[y]||0)/l.total_ratings*100:0}%`}})}),e.jsx("span",{className:"text-xs text-muted-foreground w-8 text-right",children:l.rating_distribution[y]||0})]},y))})})]}),a?e.jsx("div",{children:!f&&!g?e.jsxs(h,{onClick:()=>v(!0),className:"w-full",children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),"Rate this Company"]}):!f&&g?e.jsxs("div",{className:"border rounded-lg p-4 bg-muted/50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:"Your Rating:"}),z(g.rating)]}),e.jsx(h,{variant:"outline",size:"sm",onClick:K,children:"Edit"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:g.comment})]}):e.jsxs("div",{className:"border rounded-lg p-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Rating"}),z(k,!0)]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Comment"}),e.jsx(Ve,{value:_,onChange:y=>R(y.target.value),placeholder:"Share your experience with this company...",rows:3})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{onClick:B,disabled:O||!_.trim(),className:"flex-1",children:O?"Submitting...":g?"Update Rating":"Submit Rating"}),e.jsx(h,{variant:"outline",onClick:V,children:"Cancel"})]})]})}):e.jsxs("div",{className:"text-center py-4",children:[e.jsx(we,{className:"w-8 h-8 text-muted-foreground mx-auto mb-2"}),e.jsx("p",{className:"text-muted-foreground",children:"Please log in to rate this company"})]})]})]}),s.length>0&&e.jsxs(U,{children:[e.jsx(G,{children:e.jsxs(H,{className:"flex items-center gap-2",children:[e.jsx(we,{className:"w-5 h-5"}),"All Reviews (",s.length,")"]})}),e.jsx(D,{children:e.jsx("div",{className:"space-y-4",children:s.map(y=>e.jsxs("div",{className:"border-b pb-4 last:border-b-0",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(as,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"font-medium",children:y.username}),e.jsx(Y,{variant:"secondary",className:"text-xs",children:new Date(y.created_at).toLocaleDateString()})]}),z(y.rating)]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:y.comment})]},y.id))})})]})]})},rt=()=>{var Ue,De,Ie,Te;const{slug:j}=rs(),c=ns(),{user:a,profile:r}=Be(),[s,p]=i.useState(null),[l,x]=i.useState(!0),[g,b]=i.useState(null),[f,v]=i.useState("overview"),[k,n]=i.useState(!1),[_,R]=i.useState(!1),[O,$]=i.useState(!1),[F,W]=i.useState(!1);Ye();const[M,B]=i.useState(!1),[K,V]=i.useState(!1),[z,y]=i.useState(!1),[m,S]=i.useState([]),[w,_e]=i.useState([]),[oe,te]=i.useState(!1),[Q,ae]=i.useState(""),[Ts,Se]=i.useState(!1),[Fs,Ge]=i.useState(null),[qs,He]=i.useState(null),[Ce,ke]=i.useState(!1);i.useEffect(()=>{(r==null?void 0:r.role)==="admin"?R(!0):R(!1)},[r]),i.useEffect(()=>{s!=null&&s.id&&ye()},[s==null?void 0:s.id]),i.useEffect(()=>{f==="inventory"&&(s!=null&&s.id)&&ye()},[f,s==null?void 0:s.id]),i.useEffect(()=>{f==="transactions"&&(s!=null&&s.id)&&Ee()},[f,s==null?void 0:s.id]),i.useEffect(()=>{f==="analytics"&&(s!=null&&s.id)&&Ee()},[f,s==null?void 0:s.id]);const ye=async()=>{if(s!=null&&s.id){console.log("Fetching inventory for company:",s.id);const{data:t}=await u.from("companies").select("inventory").eq("id",s.id).single();if(t!=null&&t.inventory){console.log("Raw inventory data:",t.inventory);const o=[...new Set(t.inventory.map(I=>I.added_by))];console.log("User IDs found:",o);const{data:N}=await u.from("profiles").select("id, minecraft_username, full_name").in("id",o);console.log("Profiles found:",N);const E=new Map;N==null||N.forEach(I=>{const P=I.minecraft_username||I.full_name||"Unknown User";E.set(I.id,P)}),console.log("Username map:",Object.fromEntries(E));const X=t.inventory.map(I=>({...I,added_by_username:E.get(I.added_by)||"Unknown User"}));console.log("Inventory with usernames:",X),S(X)}else console.log("No inventory data found"),S([])}},Ee=async()=>{if(s!=null&&s.id){console.log("Fetching transactions for company:",s.id);const{data:t,error:o}=await u.from("company_transactions").select(`
          *,
          profiles!user_id(
            minecraft_username,
            full_name
          )
        `).eq("company_id",s.id).order("created_at",{ascending:!1});if(o){console.error("Error fetching transactions:",o);return}console.log("Transactions found:",t),_e(t||[])}};i.useEffect(()=>{j&&A()},[j]),i.useEffect(()=>{(s==null?void 0:s.description)!==void 0&&ae(s.description||"")},[s==null?void 0:s.description]),i.useEffect(()=>{r!=null&&r.minecraft_username&&vs.getPlayerTownData(r.minecraft_username).then(He)},[r==null?void 0:r.minecraft_username]),i.useEffect(()=>{console.log("Auth user:",a),console.log("Auth profile:",r),s&&(console.log("Company owner_uuid:",s.owner_uuid),console.log("Company owner_minecraft_username:",s.owner_minecraft_username),console.log("Company staff:",s.staff))},[a,r,s]);const ee=s&&a&&String(s.owner_uuid).trim()===String(a.id).trim(),ve=((s==null?void 0:s.staff)??[]).some(t=>String(t.user_uuid).trim()===String(a==null?void 0:a.id).trim()),Ne=((s==null?void 0:s.staff)??[]).find(t=>String(t.user_uuid).trim()===String(a==null?void 0:a.id).trim()),se=(Ne==null?void 0:Ne.role)||null,Je=(se==null?void 0:se.toLowerCase())==="executive",We=(se==null?void 0:se.toLowerCase())==="manager",q=ee||_||Je||We,A=async()=>{try{x(!0),b(null);const{data:t,error:o}=await u.from("companies").select(`
          *,
          inventory,
          shops:shops(
            id,
            owner_uuid,
            item_type,
            item_amount,
            item_durability,
            item_display_name,
            item_lore,
            item_enchants,
            item_custom_model_data,
            item_unbreakable,
            price,
            type,
            stock,
            unlimited,
            world,
            x,
            y,
            z,
            last_updated,
            description,
            company_id,
            is_featured
          )
        `).eq("slug",j).eq("status","active").single();if(o){if(o.code==="PGRST116")b("Company not found");else throw o;return}let N=null;if(t.parent_company_id){const{data:C}=await u.from("companies").select("id, name, slug, business_type, industry").eq("id",t.parent_company_id).single();N=C}let E=[];if(t.company_type==="parent"){const{data:C}=await u.from("companies").select("id, name, slug, business_type, industry, tagline").eq("parent_company_id",t.id).order("name");E=C||[]}const{data:X,error:I}=await u.from("company_staff").select(`
          id,
          company_id,
          user_uuid,
          role,
          joined_at,
          profiles!user_uuid(
            minecraft_username,
            full_name,
            avatar_url
          )
        `).eq("company_id",t.id);I&&console.error("Error fetching staff:",I);const P=(X||[]).map(C=>{var Ae,Me,ze;return{...C,user_name:((Ae=C.profiles)==null?void 0:Ae.full_name)||"Unknown User",user_avatar:(Me=C.profiles)==null?void 0:Me.avatar_url,minecraft_username:(ze=C.profiles)==null?void 0:ze.minecraft_username}});console.log("Raw staff data:",X),console.log("Processed staff data:",P);let Fe=null;if(t.owner_uuid){const{data:C}=await u.from("profiles").select("minecraft_username").eq("id",t.owner_uuid).single();Fe=(C==null?void 0:C.minecraft_username)||null}const qe=P.some(C=>C.user_uuid===t.owner_uuid);let le=qe?P.length:P.length+1;le<1&&(le=1),console.log("Staff count:",P.length),console.log("Owner in staff:",qe),console.log("Owner UUID:",t.owner_uuid),console.log("Staff UUIDs:",P.map(C=>C.user_uuid)),console.log("Calculated member count:",le),p({...t,parent_company:N,subsidiaries:E,staff:P,inventory:t.inventory||[],member_count:le}),Ge(Fe)}catch(t){console.error("Error fetching company:",t),b(t instanceof Error?t.message:"Failed to fetch company")}finally{x(!1)}},re=t=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(t),Re=t=>new Date(t).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),Qe=t=>{},Xe=t=>!1,Ze=async t=>{if(s)try{await Cs.uploadCompanyLogoFile(s.id,t)&&(A(),n(!1))}catch(o){console.error("Error uploading image:",o),d.error("Failed to upload image")}},Ke=async t=>{try{const{error:o}=await u.from("company_staff").delete().eq("id",t);if(o)throw o;d.success("Staff member removed successfully"),A()}catch(o){console.error("Error removing staff member:",o),d.error("Failed to remove staff member")}},es=async()=>{if(!(!s||!a)){ke(!0);try{const{data:t,error:o}=await u.rpc("join_company",{p_company_id:s.id,p_user_uuid:a.id});if(o)throw o;t.success?(d.success(t.message||"Successfully joined company!"),A()):d.error(t.error||"Failed to join company")}catch(t){console.error("Error joining company:",t),d.error("Failed to join company")}finally{ke(!1)}}},ss=async t=>{if(s)try{const N=(s.inventory||[]).filter(X=>X.id!==t),{error:E}=await u.from("companies").update({inventory:N}).eq("id",s.id);if(E)throw E;d.success("Inventory item removed!"),A()}catch(o){console.error("Error removing inventory item:",o),d.error("Failed to remove inventory item")}};return l?e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading company..."})]})}):g||!s?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"text-4xl mb-4",children:"🏢"}),e.jsx("h3",{className:"text-xl font-bold mb-2",children:"Company Not Found"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:g||"The company you are looking for does not exist or is not active."}),e.jsx(h,{onClick:()=>c("/marketplace"),variant:"outline",children:"Back to Marketplace"})]}):!l&&s&&!ee&&!ve&&!_?e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"text-4xl mb-4",children:"⚠️"}),e.jsx("h3",{className:"text-xl font-bold mb-2",children:"You do not have permission to edit this company"}),e.jsxs("p",{className:"text-muted-foreground mb-4",children:[e.jsx("strong",{children:"Your user ID:"})," ",a==null?void 0:a.id,e.jsx("br",{}),e.jsx("strong",{children:"Your Minecraft username:"})," ",r==null?void 0:r.minecraft_username,e.jsx("br",{}),e.jsx("strong",{children:"Company owner_uuid:"})," ",s.owner_uuid,e.jsx("br",{}),e.jsx("strong",{children:"Company owner_minecraft_username:"})," ",s.owner_minecraft_username,e.jsx("br",{}),e.jsx("strong",{children:"Company staff user_uuids:"})," ",(s.staff||[]).map(t=>t.user_uuid).join(", "),e.jsx("br",{}),e.jsx("strong",{children:"Company staff Minecraft usernames:"})," ",(s.staff||[]).map(t=>t.minecraft_username).join(", ")]}),e.jsx(h,{onClick:()=>c("/marketplace"),variant:"outline",children:"Back to Marketplace"})]})}):(a==null||a.id,String(ee),String(ve),((s==null?void 0:s.staff)||[]).map(t=>e.jsxs("li",{children:["user_uuid: ",t.user_uuid,", role: ",t.role,", user_name: ",t.user_name,", minecraft_username: ",t.minecraft_username]},t.id)),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"h-48 w-full rounded-lg flex items-center justify-center",style:{background:`linear-gradient(135deg, ${s.primary_color||"#1E40AF"}20, ${s.secondary_color||"#F59E0B"}20)`},children:s.banner_url?e.jsx("img",{src:s.banner_url,alt:`${s.name} banner`,className:"w-full h-full object-cover rounded-lg"}):e.jsxs("div",{className:"text-center",children:[e.jsx(Pe,{className:"w-16 h-16 mx-auto mb-4 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"No banner image"})]})}),e.jsx("div",{className:"absolute left-8 -bottom-16",children:s.logo_url?e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:s.logo_url,alt:`${s.name} logo`,className:"w-32 h-32 rounded-lg object-cover border-4 border-background shadow-lg bg-background"}),(ee||_)&&e.jsx(h,{size:"icon",variant:"outline",className:"absolute -top-2 -right-2 bg-background/90 hover:bg-background",onClick:()=>n(!0),title:"Upload company logo",children:e.jsx(xe,{className:"h-4 w-4"})})]}):e.jsxs("div",{className:"w-32 h-32 rounded-lg border-4 border-background shadow-lg flex items-center justify-center relative",style:{backgroundColor:s.primary_color||"#6B7280"},children:[e.jsx(Pe,{className:"w-16 h-16 text-white"}),(ee||_)&&e.jsx(h,{size:"icon",variant:"outline",className:"absolute -top-2 -right-2 bg-background/90 hover:bg-background",onClick:()=>n(!0),title:"Upload company logo",children:e.jsx(xe,{className:"h-4 w-4"})})]})}),e.jsx("div",{className:"ml-48 pt-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold mb-2",children:s.name}),s.tagline&&e.jsx("p",{className:"text-lg text-muted-foreground mb-4",children:s.tagline}),e.jsx("div",{className:"mb-4",children:e.jsx(ks,{rating:s.average_rating||0,reviewCount:s.review_count||0,size:"md",showCount:!0})}),e.jsxs("div",{className:"flex items-center gap-4 mb-4",children:[s.is_featured&&e.jsxs(Y,{className:"bg-gradient-to-r from-yellow-500 to-orange-500 text-white",children:[e.jsx(J,{className:"w-3 h-3 mr-1"}),"Featured"]}),s.verification_status==="verified"&&e.jsxs(Y,{variant:"outline",className:"text-green-600 border-green-600",children:[e.jsx(is,{className:"w-3 h-3 mr-1"}),"Verified"]}),e.jsx(Y,{variant:"outline",children:s.industry}),s.business_type&&e.jsx(Y,{variant:"outline",children:s.business_type})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[s.website_url&&e.jsx(h,{variant:"outline",size:"sm",asChild:!0,children:e.jsxs("a",{href:s.website_url,target:"_blank",rel:"noopener noreferrer",children:[e.jsx(os,{className:"w-4 h-4 mr-2"}),"Website"]})}),s.discord_invite&&e.jsx(h,{variant:"outline",size:"sm",asChild:!0,children:e.jsxs("a",{href:s.discord_invite,target:"_blank",rel:"noopener noreferrer",children:[e.jsx(we,{className:"w-4 h-4 mr-2"}),"Discord"]})}),q&&e.jsxs(h,{variant:"outline",size:"sm",onClick:()=>$(!0),children:[e.jsx(ls,{className:"w-4 h-4 mr-2"}),"Manage"]}),!ee&&!ve&&!_&&s.is_open&&e.jsx(h,{variant:"default",size:"sm",onClick:es,disabled:Ce,children:Ce?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Joining..."]}):e.jsxs(e.Fragment,{children:[e.jsx(_s,{className:"w-4 h-4 mr-2"}),"Join Company"]})})]})]})})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(U,{children:e.jsxs(D,{className:"p-4 text-center",children:[e.jsx(be,{className:"w-6 h-6 mx-auto mb-2 text-primary"}),e.jsx("p",{className:"text-2xl font-bold",children:s.member_count}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Members"})]})}),e.jsx(U,{children:e.jsxs(D,{className:"p-4 text-center",children:[e.jsx(Le,{className:"w-6 h-6 mx-auto mb-2 text-primary"}),e.jsx("p",{className:"text-2xl font-bold",children:((Ue=s.shops)==null?void 0:Ue.length)||0}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Shops"})]})}),e.jsx(U,{children:e.jsxs(D,{className:"p-4 text-center",children:[e.jsx($e,{className:"w-6 h-6 mx-auto mb-2 text-primary"}),e.jsx("p",{className:"text-2xl font-bold",children:re(s.total_revenue)}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Revenue"})]})}),e.jsx(U,{children:e.jsxs(D,{className:"p-4 text-center",children:[e.jsx(J,{className:"w-6 h-6 mx-auto mb-2 text-primary"}),e.jsx("p",{className:"text-2xl font-bold",children:s.average_rating.toFixed(1)}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Rating"})]})})]}),e.jsxs(cs,{value:f,onValueChange:v,children:[e.jsxs(ds,{className:"max-w-4xl mx-auto flex gap-2 px-2 py-1 rounded-lg bg-muted/40 border mb-4",children:[e.jsx(ne,{value:"overview",className:"px-3 py-1 text-sm min-w-[80px]",children:"Overview"}),e.jsx(ne,{value:"shops",className:"px-3 py-1 text-sm min-w-[80px]",children:"Shops"}),e.jsx(ne,{value:"inventory",className:"px-3 py-1 text-sm min-w-[80px]",children:"Inventory"}),e.jsx(ne,{value:"transactions",className:"px-3 py-1 text-sm min-w-[80px]",children:"Transactions & Analytics"}),e.jsx(ne,{value:"ratings",className:"px-3 py-1 text-sm min-w-[80px]",children:"Ratings"})]}),e.jsxs(ie,{value:"overview",className:"space-y-6",children:[oe?e.jsx("div",{className:"max-w-4xl mx-auto",children:e.jsx(ys,{page:{content:Q,title:s.name,status:"published",updatedAt:"",authorName:"",id:s.id,slug:s.slug,authorId:s.owner_uuid,createdAt:s.created_at,category:null,order:0},userRole:q?"admin":"member",isEditing:!0,onSave:async t=>{Se(!0);const{error:o}=await u.from("companies").update({description:t.content}).eq("id",s.id);Se(!1),o?d.error("Failed to update description"):(te(!1),ae(t.content||""),A(),d.success("Description updated!"))},onToggleEdit:()=>te(!1),autoSaveEnabled:!1,onAutoSaveToggle:()=>{}})}):e.jsxs("div",{className:"prose max-w-4xl mx-auto px-4",children:[e.jsx(hs,{content:Q||s.description||"*No description provided.*"}),q&&e.jsx(h,{size:"sm",variant:"outline",className:"mt-2",onClick:()=>te(!0),children:"Edit Description"})]}),e.jsxs(U,{children:[e.jsx(G,{children:e.jsx(H,{children:"Headquarters Location"})}),e.jsx(D,{children:s.headquarters_world&&s.headquarters_coords?(()=>{const[t,o,N]=(s.headquarters_coords||"").split(",").map(Number);return[t,o,N].some(E=>isNaN(E))?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Invalid coordinates specified"}):e.jsxs(e.Fragment,{children:[e.jsx(js,{shopName:s.name,coordinates:{x:t,y:o,z:N},world:s.headquarters_world}),e.jsx("div",{className:"mt-4 text-center",children:e.jsx(h,{asChild:!0,variant:"outline",size:"sm",className:"inline-flex items-center gap-2",children:e.jsxs("a",{href:`https://map.nordics.world/#world:${t}:${o}:${N}:444:0:0:0:1:flat`,target:"_blank",rel:"noopener noreferrer",children:[e.jsx(Oe,{className:"w-4 h-4 mr-1"}),"Live Map View"]})})})]})})():e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Oe,{className:"w-12 h-12 mx-auto mb-4 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"No headquarters location specified"})]})})]}),e.jsxs(U,{children:[e.jsx(G,{children:e.jsx(H,{children:"Company Staff"})}),e.jsx(D,{children:s.staff&&s.staff.length>0?e.jsx("div",{className:"space-y-4",children:s.staff.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(be,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:t.user_name||"Unknown User"}),e.jsx("p",{className:"text-sm text-muted-foreground capitalize",children:t.role})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(Y,{variant:"outline",className:"text-xs",children:["Joined ",Re(t.joined_at)]}),q&&e.jsx(h,{variant:"outline",size:"sm",onClick:()=>Ke(t.id),children:e.jsx(Ss,{className:"w-4 h-4"})})]})]},t.id))}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(be,{className:"w-12 h-12 mx-auto mb-4 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"No staff members found"})]})})]})]}),e.jsxs(ie,{value:"inventory",className:"space-y-6 max-w-4xl mx-auto",children:[e.jsxs(U,{children:[e.jsxs(G,{className:"flex flex-row items-center justify-between",children:[e.jsx(H,{children:"Company Inventory"}),q&&e.jsx(h,{size:"sm",onClick:()=>y(!0),children:"Add Item"})]}),e.jsx(D,{children:m.length>0?e.jsx("div",{className:"space-y-2",children:m.map(t=>e.jsxs("div",{className:"flex items-center gap-4 border rounded p-2",children:[e.jsx("span",{className:"font-medium",children:t.item_name}),e.jsxs("span",{className:"text-muted-foreground",children:["x",t.quantity]}),e.jsxs("span",{className:"text-xs text-muted-foreground ml-auto",children:["Added by ",t.added_by_username||t.added_by,t.added_at&&` on ${new Date(t.added_at).toLocaleDateString()}`]}),q&&e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>ss(t.id),className:"text-red-500 hover:text-red-700",children:e.jsx(ms,{className:"w-4 h-4"})})]},t.id))}):e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No inventory items found."})})]}),z&&e.jsx(ce,{open:z,onOpenChange:y,children:e.jsxs(de,{children:[e.jsx(me,{children:e.jsx(ue,{children:"Add Inventory Item"})}),e.jsx(Is,{companyId:s.id,userId:a.id,onClose:()=>{y(!1),ye()}})]})})]}),e.jsx(ie,{value:"shops",className:"space-y-6 max-w-4xl mx-auto",children:e.jsxs(U,{children:[e.jsx(G,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(H,{children:"Company Shops"}),q&&e.jsx(h,{size:"sm",className:"mb-4",onClick:()=>B(!0),children:"Add Shop"})]})}),e.jsx(D,{children:s.shops&&s.shops.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:s.shops.map(t=>e.jsxs("div",{className:"relative",children:[e.jsx(Ns,{shop:t,formatPrice:bs,formatLastUpdated:ws,onToggleFavorite:Qe,isFavorite:Xe}),q&&e.jsx(h,{size:"sm",variant:"destructive",className:"absolute top-2 right-2 z-10",onClick:o=>{o.stopPropagation(),(async()=>(await u.from("shops").update({company_id:null}).eq("id",t.id),A()))()},children:"Remove"})]},t.id))}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Le,{className:"w-12 h-12 mx-auto mb-4 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"No shops found for this company"})]})})]})}),e.jsxs(ie,{value:"transactions",className:"space-y-6 max-w-4xl mx-auto",children:[e.jsxs(U,{children:[e.jsxs(G,{className:"flex flex-row items-center justify-between",children:[e.jsx(H,{children:"Company Transactions"}),q&&e.jsx(h,{size:"sm",onClick:()=>V(!0),children:"Create Transaction"})]}),e.jsx(D,{children:w.length>0?e.jsx("div",{className:"space-y-4",children:w.map(t=>{var o,N;return e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Y,{variant:t.transaction_type==="service"?"default":t.transaction_type==="product"?"secondary":t.transaction_type==="consultation"?"outline":"destructive",children:t.transaction_type.charAt(0).toUpperCase()+t.transaction_type.slice(1)}),t.service_category&&e.jsx(Y,{variant:"outline",className:"text-xs",children:t.service_category})]}),e.jsxs("div",{className:"space-y-1",children:[t.service_name&&e.jsx("p",{className:"font-medium",children:t.service_name}),t.client_name&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Client: ",t.client_name]}),t.description&&e.jsx("p",{className:"text-sm text-muted-foreground",children:t.description}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Created by ",((o=t.profiles)==null?void 0:o.minecraft_username)||((N=t.profiles)==null?void 0:N.full_name)||"Unknown User"," on ",Re(t.created_at)]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-lg font-bold text-primary",children:re(t.amount)}),t.proof_image_url&&e.jsx(h,{size:"sm",variant:"outline",onClick:()=>window.open(t.proof_image_url,"_blank"),children:"View Proof"})]})]},t.id)})}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx($e,{className:"w-12 h-12 mx-auto mb-4 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"No transactions found for this company"}),q&&e.jsx(h,{size:"sm",className:"mt-2",onClick:()=>V(!0),children:"Create First Transaction"})]})})]}),e.jsxs(U,{children:[e.jsx(G,{children:e.jsx(H,{children:"Company Analytics"})}),e.jsxs(D,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-semibold",children:"Financial Overview"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Total Revenue:"}),e.jsx("span",{className:"font-semibold",children:re(s.total_revenue)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Total Transactions:"}),e.jsx("span",{className:"font-semibold",children:s.total_transactions.toLocaleString()})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Average Transaction:"}),e.jsx("span",{className:"font-semibold",children:s.total_transactions>0?re(s.total_revenue/s.total_transactions):"$0"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Recent Transactions:"}),e.jsx("span",{className:"font-semibold",children:w.length})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-semibold",children:"Performance Metrics"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Member Count:"}),e.jsx("span",{className:"font-semibold",children:s.member_count})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Shop Count:"}),e.jsx("span",{className:"font-semibold",children:((De=s.shops)==null?void 0:De.length)||0})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Average Rating:"}),e.jsxs("span",{className:"font-semibold",children:[s.average_rating>0?s.average_rating.toFixed(1):"No ratings yet","/5"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Inventory Items:"}),e.jsx("span",{className:"font-semibold",children:m.length})]})]})]})]}),w.length>0&&e.jsxs("div",{className:"mt-6",children:[e.jsx("h4",{className:"font-semibold mb-4",children:"Recent Transaction Breakdown"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h5",{className:"text-sm font-medium text-muted-foreground",children:"By Type"}),e.jsx("div",{className:"space-y-1",children:Object.entries(w.reduce((t,o)=>(t[o.transaction_type]=(t[o.transaction_type]||0)+1,t),{})).map(([t,o])=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"capitalize",children:[t,":"]}),e.jsx("span",{className:"font-medium",children:o})]},t))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h5",{className:"text-sm font-medium text-muted-foreground",children:"By Service Category"}),e.jsx("div",{className:"space-y-1",children:Object.entries(w.filter(t=>t.service_category).reduce((t,o)=>(t[o.service_category]=(t[o.service_category]||0)+1,t),{})).map(([t,o])=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{children:[t,":"]}),e.jsx("span",{className:"font-medium",children:o})]},t))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h5",{className:"text-sm font-medium text-muted-foreground",children:"Revenue by Type"}),e.jsx("div",{className:"space-y-1",children:Object.entries(w.reduce((t,o)=>(t[o.transaction_type]=(t[o.transaction_type]||0)+o.amount,t),{})).map(([t,o])=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"capitalize",children:[t,":"]}),e.jsx("span",{className:"font-medium",children:re(o)})]},t))})]})]})]}),e.jsx("div",{className:"mt-8 h-64 bg-muted rounded-lg flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(us,{className:"w-12 h-12 mx-auto mb-4 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"Analytics charts coming soon"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Revenue trends, member growth, and performance metrics"})]})})]})]})]}),e.jsx(ie,{value:"ratings",className:"space-y-6 max-w-4xl mx-auto",children:e.jsx(Es,{companyId:s.id,companyName:s.name})})]}),k&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-background rounded-lg max-w-md w-full p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Upload Company Logo"}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"border-2 border-dashed border-border rounded-lg p-8 text-center",children:[e.jsx(xe,{className:"w-8 h-8 mx-auto mb-4 text-muted-foreground"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"Upload your company logo"}),e.jsx("p",{className:"text-xs text-muted-foreground mb-4",children:"PNG, JPG up to 2MB. Recommended size: 256x256px"}),e.jsxs(h,{variant:"outline",onClick:()=>{const t=document.createElement("input");t.type="file",t.accept="image/*",t.onchange=o=>{var E;const N=(E=o.target.files)==null?void 0:E[0];if(N){if(N.size>2*1024*1024){d.error("File size must be less than 2MB");return}Ze(N)}},t.click()},children:[e.jsx(xe,{className:"w-4 h-4 mr-2"}),"Choose Image"]})]})}),e.jsx("div",{className:"flex justify-end gap-3 mt-6",children:e.jsx(h,{variant:"outline",onClick:()=>n(!1),children:"Cancel"})})]})}),O&&e.jsx(ps,{initialData:{...s,staff:((Ie=s.staff)==null?void 0:Ie.map(t=>({user_uuid:t.user_uuid,displayName:t.user_name||"Unknown User",role:t.role})))||[]},onClose:()=>$(!1),onCompanyUpdated:A,isEditMode:!0,open:O,onOpenChange:$}),F&&e.jsx(ce,{open:F,onOpenChange:W,children:e.jsxs(de,{className:"max-w-lg",children:[e.jsx(me,{children:e.jsx(ue,{children:"Add Staff Member"})}),e.jsx(Rs,{companyId:s.id,onClose:()=>{W(!1),A()}})]})}),M&&e.jsx(ce,{open:M,onOpenChange:B,children:e.jsxs(de,{className:"max-w-lg",children:[e.jsx(me,{children:e.jsx(ue,{children:"Add Shop to Company"})}),e.jsx(Us,{companyId:s.id,userId:a==null?void 0:a.id,isAdmin:_,onClose:()=>{B(!1),A()},companyShopIds:((Te=s.shops)==null?void 0:Te.map(t=>t.id))||[]})]})}),K&&e.jsx(ce,{open:K,onOpenChange:V,children:e.jsxs(de,{className:"max-w-2xl",children:[e.jsxs(me,{children:[e.jsx(ue,{children:"Create Transaction"}),e.jsx(xs,{children:"Record a new transaction for your company. Choose the transaction type and fill in the details."})]}),e.jsx(Ds,{companyId:s.id,shops:s.shops,userId:a.id,onClose:()=>V(!1)})]})})]}))},Rs=({companyId:j,onClose:c})=>{const[a,r]=i.useState(""),{players:s,loading:p}=fs(a),[l,x]=i.useState(null),[g,b]=i.useState("Staff"),[f,v]=i.useState(!1),k=async()=>{if(l){v(!0);try{const{error:n}=await u.from("company_staff").insert({company_id:j,user_uuid:l.id,role:g});if(n)throw d.error("Failed to add staff: "+(n.message||n.details||n.code||"Unknown error")),n;d.success("Staff member added!"),c()}catch(n){d.error("Failed to add staff: "+((n==null?void 0:n.message)||(n==null?void 0:n.details)||(n==null?void 0:n.code)||"Unknown error"))}finally{v(!1)}}};return e.jsxs("div",{className:"space-y-4",children:[e.jsx(Z,{placeholder:"Search player by name...",value:a,onChange:n=>r(n.target.value),disabled:!!l}),a.length>=2&&!l&&e.jsx("div",{className:"max-h-40 overflow-y-auto border rounded",children:p?e.jsx("div",{className:"p-2 text-muted-foreground",children:"Searching..."}):s.length===0?e.jsx("div",{className:"p-2 text-muted-foreground",children:"No players found"}):s.map(n=>e.jsx("div",{className:"p-2 hover:bg-muted cursor-pointer",onClick:()=>x(n),children:n.displayName},n.id))}),l&&e.jsxs("div",{className:"flex items-center gap-2 p-2 border rounded",children:[e.jsx("span",{children:l.displayName}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>x(null),children:"Remove"})]}),e.jsxs("div",{children:[e.jsx(T,{children:"Role"}),e.jsxs(ge,{value:g,onValueChange:b,children:[e.jsx(pe,{children:e.jsx(fe,{})}),e.jsxs(je,{className:"z-[9999]",position:"popper",children:[e.jsx(L,{value:"Manager",children:"Manager"}),e.jsx(L,{value:"Staff",children:"Staff"}),e.jsx(L,{value:"Executive",children:"Executive"})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(h,{variant:"outline",onClick:c,disabled:f,children:"Cancel"}),e.jsx(h,{onClick:k,disabled:!l||f,children:"Add"})]})]})},Us=({companyId:j,userId:c,isAdmin:a,onClose:r,companyShopIds:s})=>{const{shops:p,loading:l}=Ye(),[x,g]=i.useState(!1),b=a?p.filter(n=>!n.company_id||!s.includes(n.id)):p.filter(n=>n.owner_uuid===c&&(!n.company_id||!s.includes(n.id))),[f,v]=i.useState(null),k=async()=>{if(f){g(!0);try{const{error:n}=await u.from("shops").update({company_id:j}).eq("id",f);if(n)throw n;d.success("Shop linked to company!"),r()}catch{d.error("Failed to link shop")}finally{g(!1)}}};return e.jsxs("div",{className:"space-y-4",children:[l?e.jsx("div",{className:"p-2 text-muted-foreground",children:"Loading shops..."}):b.length===0?e.jsx("div",{className:"p-2 text-muted-foreground",children:"No eligible shops to add."}):e.jsx("div",{className:"max-h-40 overflow-y-auto border rounded",children:b.map(n=>e.jsxs("div",{className:`p-2 hover:bg-muted cursor-pointer ${f===n.id?"bg-primary/10":""}`,onClick:()=>v(n.id),children:[n.item_display_name||n.item_type," (",n.world," ",n.x,",",n.y,",",n.z,")"]},n.id))}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(h,{variant:"outline",onClick:r,disabled:x,children:"Cancel"}),e.jsx(h,{onClick:k,disabled:!f||x,children:"Add"})]})]})},Ds=({companyId:j,shops:c,userId:a,onClose:r})=>{const[s,p]=i.useState("service"),[l,x]=i.useState(""),[g,b]=i.useState(""),[f,v]=i.useState(""),[k,n]=i.useState(""),[_,R]=i.useState(""),[O,$]=i.useState(""),[F,W]=i.useState(null),[M,B]=i.useState(!1),K=i.useRef(null),V=["Building & Construction","Design & Architecture","Consulting & Planning","Transportation & Logistics","Security & Protection","Entertainment & Events","Education & Training","Healthcare & Medical","Technology & IT","Agriculture & Farming","Mining & Resources","Manufacturing & Crafting","Landscaping & Groundskeeping","Other"],z=m=>{var w;const S=(w=m.target.files)==null?void 0:w[0];S&&W(S)},y=async m=>{if(m.preventDefault(),!k||!F){d.error("Amount and proof image are required.");return}if(s==="product"&&!l){d.error("Please select a shop for product transactions.");return}if(s==="service"&&(!g||!f)){d.error("Please fill in service category and name.");return}B(!0);try{const S=F.name.split(".").pop(),w=`${Date.now()}_${a}.${S}`,{data:_e,error:oe}=await u.storage.from("transaction-proofs").upload(w,F);if(oe)throw oe;const{data:{publicUrl:te}}=u.storage.from("transaction-proofs").getPublicUrl(w),Q={company_id:j,user_id:a,transaction_type:s,amount:parseFloat(k),description:_,client_name:O||null,proof_image_url:te,created_at:new Date().toISOString()};s==="product"?Q.shop_id=l:s==="service"&&(Q.service_category=g,Q.service_name=f);const{error:ae}=await u.from("company_transactions").insert(Q);if(ae)throw ae;d.success("Transaction created successfully!"),r()}catch(S){console.error("Transaction creation error:",S),d.error("Failed to create transaction")}finally{B(!1)}};return e.jsxs("form",{onSubmit:y,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(T,{children:"Transaction Type"}),e.jsxs(ge,{value:s,onValueChange:m=>p(m),children:[e.jsx(pe,{children:e.jsx(fe,{placeholder:"Select transaction type"})}),e.jsxs(je,{className:"z-[999999]",side:"bottom",align:"start",sideOffset:4,children:[e.jsx(L,{value:"service",children:"Service"}),e.jsx(L,{value:"product",children:"Product (Shop)"}),e.jsx(L,{value:"consultation",children:"Consultation"}),e.jsx(L,{value:"other",children:"Other"})]})]})]}),s==="product"&&e.jsxs("div",{children:[e.jsx(T,{children:"Shop"}),e.jsxs(ge,{value:l,onValueChange:x,children:[e.jsx(pe,{children:e.jsx(fe,{placeholder:"Select shop"})}),e.jsx(je,{className:"z-[999999]",side:"bottom",align:"start",sideOffset:4,children:c.map(m=>e.jsxs(L,{value:m.id,children:[m.item_display_name||m.item_type," (",m.world," ",m.x,",",m.y,",",m.z,")"]},m.id))})]})]}),s==="service"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx(T,{children:"Service Category"}),e.jsxs(ge,{value:g,onValueChange:b,children:[e.jsx(pe,{children:e.jsx(fe,{placeholder:"Select service category"})}),e.jsx(je,{className:"z-[999999]",side:"bottom",align:"start",sideOffset:4,children:V.map(m=>e.jsx(L,{value:m,children:m},m))})]})]}),e.jsxs("div",{children:[e.jsx(T,{children:"Service Name"}),e.jsx(Z,{value:f,onChange:m=>v(m.target.value),placeholder:"e.g., Castle Construction, Redstone System Design",required:!0})]})]}),e.jsxs("div",{children:[e.jsx(T,{children:"Client Name (Optional)"}),e.jsx(Z,{value:O,onChange:m=>$(m.target.value),placeholder:"Who was this transaction for?"})]}),e.jsxs("div",{children:[e.jsx(T,{children:"Amount"}),e.jsx(Z,{type:"number",step:"0.01",min:"0",value:k,onChange:m=>n(m.target.value),required:!0})]}),e.jsxs("div",{children:[e.jsx(T,{children:"Description"}),e.jsx(Ve,{value:_,onChange:m=>R(m.target.value),placeholder:"Describe the transaction details..."})]}),e.jsxs("div",{children:[e.jsx(T,{children:"Proof Image"}),e.jsx(Z,{type:"file",accept:"image/*",onChange:z,ref:K,required:!0}),F&&e.jsx("span",{className:"text-xs text-muted-foreground",children:F.name})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(h,{variant:"outline",type:"button",onClick:r,disabled:M,children:"Cancel"}),e.jsx(h,{type:"submit",disabled:M,children:M?"Submitting...":"Create Transaction"})]})]})},Is=({companyId:j,userId:c,onClose:a})=>{const[r,s]=i.useState(""),[p,l]=i.useState(""),[x,g]=i.useState(!1),b=async f=>{if(f.preventDefault(),!r||!p){d.error("Item name and quantity are required.");return}g(!0);try{console.log("Adding inventory item:",{companyId:j,itemName:r,quantity:p,userId:c});const{data:v}=await u.from("companies").select("inventory").eq("id",j).single(),k=(v==null?void 0:v.inventory)||[],n={id:Date.now().toString(),item_name:r,quantity:parseInt(p,10),added_by:c,added_at:new Date().toISOString()},_=[...k,n],{error:R}=await u.from("companies").update({inventory:_}).eq("id",j);if(R)throw console.error("Inventory update error:",R),R;d.success("Inventory item added!"),a()}catch(v){console.error("Failed to add inventory item:",v),d.error("Failed to add inventory item: "+(v instanceof Error?v.message:"Unknown error"))}finally{g(!1)}};return e.jsxs("form",{onSubmit:b,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(T,{children:"Item Name"}),e.jsx(Z,{value:r,onChange:f=>s(f.target.value),required:!0})]}),e.jsxs("div",{children:[e.jsx(T,{children:"Quantity"}),e.jsx(Z,{type:"number",min:"1",value:p,onChange:f=>l(f.target.value),required:!0})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(h,{variant:"outline",type:"button",onClick:a,disabled:x,children:"Cancel"}),e.jsx(h,{type:"submit",disabled:x,children:x?"Adding...":"Add Item"})]})]})};export{rt as default};
