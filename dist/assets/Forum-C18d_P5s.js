var Vs=Object.defineProperty;var Qs=(c,t,s)=>t in c?Vs(c,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):c[t]=s;var Ke=(c,t,s)=>Qs(c,typeof t!="symbol"?t+"":t,s);import{I as re,r as n,s as _,aN as Ss,j as e,aO as Cs,aP as Ps,v as g,aD as Es,aQ as Ts,aR as ie,B as E,aS as ss,ay as he,w as W,x as le,y as ye,z as X,G as Ee,az as fs,aT as ps,E as Oe,F as Ws,aa as Ys,U as qe,aG as As,a4 as Ds,X as je,Y as ts,aU as qs,ag as Ms,l as Te,m as Ae,n as De,aV as be,aW as Us,aX as Is,i as Gs,aY as Fs,aZ as G,a_ as K,a$ as Z,o as ce,b0 as Ls,ah as Ks,p as de,q as me,t as ue,b1 as Zs,b2 as we,O as Js,h as gs,aJ as Xs,b3 as et,b4 as st,b5 as js,b6 as Rs,at as tt,au as at,av as Ze,a7 as rt,aw as Je,aI as nt,Z as it,$ as ot,a0 as lt,a1 as ct,a2 as Xe,ae as dt,b7 as mt,aH as ut,b8 as ht,b9 as ys,ba as xt,u as ft,W as pt,aL as gt,bb as jt}from"./index-BDwxLbfg.js";import{u as ke}from"./use-toast-IlxM9Ntm.js";import{P as as}from"./playerTownService-Cn9WKRSh.js";import{T as yt}from"./TownProfilePicture-CY--EK_H.js";import{B as rs}from"./building-nraDPmQ5.js";import{C as zs}from"./circle-help-BGbt7uES.js";import{T as vt}from"./trending-up-CmxDmib0.js";import{A as Nt}from"./anchor-BJGCImXu.js";import{A as _e}from"./arrow-left-BpGtw6K8.js";import{I as Os}from"./image-CdpHxvLf.js";import{B as bt,I as wt,H as _t,a as kt,b as St,Q as Ct,C as vs}from"./quote-BAutpiux.js";import{L as Pt}from"./list-DgrYmvyF.js";import{L as Et,F as Tt}from"./link-BSO0-lYh.js";import{L as Qe}from"./loader-circle-BQXbm3ye.js";import{C as Ns}from"./copy-D3RDa5qZ.js";import{H as We}from"./history-Byz8ox4I.js";import{T as Pe}from"./target-CRQiVHpG.js";import{U as At}from"./user-plus-v6PF39qN.js";import{E as Dt}from"./ellipsis--V5nHi61.js";import{S as qt}from"./square-pen-BbMsOEvb.js";import{F as Mt}from"./filter-NS2wN-5_.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Hs=re("BellOff",[["path",{d:"M8.7 3A6 6 0 0 1 18 8a21.3 21.3 0 0 0 .6 5",key:"o7mx20"}],["path",{d:"M17 17H3s3-2 3-9a4.67 4.67 0 0 1 .3-1.7",key:"16f1lm"}],["path",{d:"M10.3 21a1.94 1.94 0 0 0 3.4 0",key:"qgo35s"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ut=re("Droplets",[["path",{d:"M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.84-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z",key:"1ptgy4"}],["path",{d:"M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97",key:"1sl1rz"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bs=re("FilePen",[["path",{d:"M12.5 22H18a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v9.5",key:"1couwa"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M13.378 15.626a1 1 0 1 0-3.004-3.004l-5.01 5.012a2 2 0 0 0-.506.854l-.837 2.87a.5.5 0 0 0 .62.62l2.87-.837a2 2 0 0 0 .854-.506z",key:"1y4qbx"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const os=re("Lightbulb",[["path",{d:"M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5",key:"1gvzjb"}],["path",{d:"M9 18h6",key:"x1upvd"}],["path",{d:"M10 22h4",key:"ceow96"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const It=re("ListOrdered",[["path",{d:"M10 12h11",key:"6m4ad9"}],["path",{d:"M10 18h11",key:"11hvi2"}],["path",{d:"M10 6h11",key:"c7qv1k"}],["path",{d:"M4 10h2",key:"16xx2s"}],["path",{d:"M4 6h1v4",key:"cnovpq"}],["path",{d:"M6 18H4c0-1 2-2 2-3s-1-1.5-2-1",key:"m9a95d"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ft=re("Megaphone",[["path",{d:"m3 11 18-5v12L3 14v-3z",key:"n962bs"}],["path",{d:"M11.6 16.8a3 3 0 1 1-5.8-1.6",key:"1yl0tm"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Lt=re("Newspaper",[["path",{d:"M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2",key:"7pis2x"}],["path",{d:"M18 14h-8",key:"sponae"}],["path",{d:"M15 18h-5",key:"95g1m2"}],["path",{d:"M10 6h8v4h-8V6Z",key:"smlsk5"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rt=re("Strikethrough",[["path",{d:"M16 4H9a3 3 0 0 0-2.83 4",key:"43sutm"}],["path",{d:"M14 12a4 4 0 0 1 0 8H6",key:"nlfj13"}],["line",{x1:"4",x2:"20",y1:"12",y2:"12",key:"1e0a9i"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zt=re("ThumbsDown",[["path",{d:"M17 14V2",key:"8ymqnk"}],["path",{d:"M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z",key:"m61m77"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ot=re("ThumbsUp",[["path",{d:"M7 10v12",key:"1qc93n"}],["path",{d:"M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z",key:"emmmcr"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ht=re("Underline",[["path",{d:"M6 4v6a6 6 0 0 0 12 0V4",key:"9kb039"}],["line",{x1:"4",x2:"20",y1:"20",y2:"20",key:"nun2al"}]]),Bt=()=>{const[c,t]=n.useState([]),[s,a]=n.useState(!0),[l,u]=n.useState(null);return n.useEffect(()=>{(async()=>{try{const{data:r,error:p}=await _.from("forum_categories").select(`
            *,
            forum_posts!forum_posts_category_id_fkey(
              id,
              created_at,
              updated_at
            )
          `).order("order_index",{ascending:!0});if(p)throw p;const x=(r||[]).map(i=>{const h=i.forum_posts||[],w=h.length,y=h.length>0?Math.max(...h.map(j=>new Date(j.updated_at||j.created_at).getTime())):null;return{...i,post_count:w,last_activity:y?new Date(y).toISOString():null,forum_posts:void 0}});t(x)}catch(r){u(r instanceof Error?r.message:"An error occurred")}finally{a(!1)}})()},[]),{categories:c,loading:s,error:l}},$t=[{value:"instant",label:"Instant"},{value:"hourly",label:"Hourly"},{value:"daily",label:"Daily"},{value:"weekly",label:"Weekly"},{value:"never",label:"Never"}],Ve=({subscriptionType:c,targetId:t,targetName:s,variant:a="outline",size:l="sm",showFrequency:u=!1,showText:d=!1})=>{const{isSubscribed:r,subscribeToContent:p,unsubscribeFromContent:x,getSubscriptionStatus:i}=Ss(),{toast:h}=ke(),[w,y]=n.useState(!1),j=r(c,t),v=i(c,t),S=async(N="instant")=>{try{y(!0),await p(c,t,N),h({title:"Subscribed",description:`You are now subscribed to ${s||c} notifications.`})}catch{h({title:"Error",description:"Failed to subscribe. Please try again.",variant:"destructive"})}finally{y(!1)}},T=async()=>{try{y(!0),await x(c,t),h({title:"Unsubscribed",description:`You are no longer subscribed to ${s||c} notifications.`})}catch{h({title:"Error",description:"Failed to unsubscribe. Please try again.",variant:"destructive"})}finally{y(!1)}},D=async N=>{N==="never"?await T():await S(N)},q=()=>{var z;if(!j)return"Subscribe";if(!u)return"Subscribed";const N=(v==null?void 0:v.frequency)||"instant";return`Subscribed (${((z=$t.find(O=>O.value===N))==null?void 0:z.label)||N})`},C=()=>j?e.jsx(ss,{className:"h-4 w-4"}):e.jsx(Hs,{className:"h-4 w-4"});return u&&j?e.jsxs(Cs,{children:[e.jsx(Ps,{asChild:!0,children:e.jsxs(g,{variant:a,size:l,disabled:w,className:"flex items-center gap-2",children:[C(),d&&q(),e.jsx(Es,{className:"h-3 w-3"})]})}),e.jsxs(Ts,{align:"end",children:[e.jsx(ie,{onClick:()=>D("instant"),children:"Instant"}),e.jsx(ie,{onClick:()=>D("hourly"),children:"Hourly"}),e.jsx(ie,{onClick:()=>D("daily"),children:"Daily"}),e.jsx(ie,{onClick:()=>D("weekly"),children:"Weekly"}),e.jsx(ie,{onClick:()=>D("never"),className:"text-destructive",children:"Unsubscribe"})]})]}):e.jsxs(g,{variant:a,size:l,onClick:j?T:()=>S(),disabled:w,className:"flex items-center gap-2",title:d?void 0:q(),children:[C(),d&&q(),j&&d&&e.jsx(E,{variant:"secondary",className:"ml-1 h-4 px-1 text-xs",children:(v==null?void 0:v.frequency)||"instant"})]})},ls=()=>{const{user:c,profile:t}=he(),[s,a]=n.useState(null),[l,u]=n.useState(null),[d,r]=n.useState(!1),[p,x]=n.useState(!1),[i,h]=n.useState(!0);return n.useEffect(()=>{(async()=>{if(!c||!t){h(!1);return}try{const j=t.role==="admin",v=t.role==="moderator";if(r(j),x(v),j||v){a("ALL"),h(!1);return}const S=await as.getPlayerTownData(t.minecraft_username);if(S!=null&&S.nationName){a(S.nationName);const T=await as.getUserNationForums(t.minecraft_username);u(T)}}catch(j){console.error("Error fetching user nation access:",j)}finally{h(!1)}})()},[c,t]),{userNation:s,userNationForums:l,isAdmin:d,isModerator:p,hasAccessToForum:(y,j)=>d||p?!0:s&&(y&&!j||j)?s===y:!1,loading:i}},Vt={"message-square":Oe,calendar:Ws,building:rs,newspaper:Lt,"help-circle":zs,lightbulb:os,wrench:Ys,users:qe,"trending-up":vt,clock:As,crown:Ee,anchor:Nt,droplets:Ut,star:Ds},Qt=({onCategorySelect:c,onCreatePost:t})=>{const{user:s,profile:a}=he(),{categories:l,loading:u}=Bt(),{userNation:d,userNationForums:r,isAdmin:p,isModerator:x,hasAccessToForum:i,loading:h}=ls(),[w,y]=n.useState({}),[j,v]=n.useState(null),S=o=>o.replace(/_/g," "),T=p||x,D=async()=>{if(!s)return;const{data:o,error:I}=await _.from("forum_notifications").select("id, post_id, read_at, notification_type, post:forum_posts(category_id)").eq("user_id",s.id).is("read_at",null).eq("notification_type","reply");if(I)return;const R={};(o||[]).forEach(L=>{var $;const A=($=L.post)==null?void 0:$.category_id;A&&(R[A]=!0)}),y(R)},q=async()=>{if(a!=null&&a.minecraft_username)try{const o=await as.getPlayerTownData(a.minecraft_username);o&&v({isMayor:o.isMayor,isKing:o.isKing})}catch(o){console.error("Error fetching player role:",o)}};n.useEffect(()=>{D(),q()},[s,a]);const C=l.filter(o=>o.role_required==="member"&&!o.nation_name&&!o.town_name&&!o.is_archived),N=l.filter(o=>o.nation_name&&!o.town_name&&!o.is_archived&&(T||d&&o.nation_name===d)).filter((o,I,R)=>I===R.findIndex(L=>L.id===o.id)),Y=l.filter(o=>o.nation_name&&o.town_name&&!o.is_archived&&(T||d&&o.nation_name===d)).filter((o,I,R)=>I===R.findIndex(L=>L.id===o.id)),z=l.filter(o=>o.role_required==="moderator"&&!o.is_archived),O=o=>Vt[o]||Oe,M=(o,I)=>e.jsx("div",{className:"p-2 rounded-lg flex items-center justify-center w-9 h-9",style:{backgroundColor:I+"20"},children:e.jsx(yt,{townName:o,className:"w-10 h-10 object-contain"})}),J=(o,I)=>{const R=`https://erdconvorgecupvavlwv.supabase.co/storage/v1/object/public/nation-town-images/nations/${o.toLowerCase().replace(/[^a-zA-Z0-9]/g,"_")}.png`;return e.jsxs("div",{className:"p-2 rounded-lg flex items-center justify-center w-9 h-9",style:{backgroundColor:I+"20"},children:[e.jsx("img",{src:R,alt:`${o} flag`,className:"w-10 h-10 object-contain rounded",onError:L=>{var A;L.currentTarget.style.display="none",(A=L.currentTarget.nextElementSibling)==null||A.classList.remove("hidden")}}),e.jsx(Ee,{className:"w-10 h-10 hidden",style:{color:I}})]})},ee=o=>({"Skyward Sanctum":"#3b82f6",North_Sea_League:"#059669","Kesko Corporation":"#f59e0b","Aqua Union":"#0ea5e9",Constellation:"#8b5cf6"})[o]||"#3b82f6";return u||h?e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-8 bg-gray-200 rounded w-1/3 mb-4"}),e.jsx("div",{className:"grid gap-4",children:[...Array(6)].map((o,I)=>e.jsx("div",{className:"h-24 bg-gray-200 rounded"},I))})]})}):e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("h2",{className:"text-2xl font-semibold text-foreground",children:"Discussion Categories"})}),e.jsx("div",{className:"grid gap-4",children:C.map(o=>{const I=O(o.icon);return e.jsxs(W,{className:"group cursor-pointer hover:shadow-lg transition-all duration-300",onClick:()=>c(o.id),children:[e.jsx(le,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"p-2 rounded-lg",style:{backgroundColor:o.color+"20",color:o.color},children:e.jsx(I,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsx(ye,{className:"text-lg font-semibold text-foreground",children:o.name}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:o.description})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[w[o.id]&&e.jsx(E,{variant:"destructive",className:"text-xs",children:"New"}),e.jsx(Ve,{subscriptionType:"category",targetId:o.id,targetName:o.name})]})]})}),e.jsx(X,{className:"pt-0",children:e.jsxs("div",{className:"text-sm text-muted-foreground",children:[o.post_count||0," posts"]})})]},o.id)})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("h2",{className:"text-2xl font-semibold",children:"Nation Forums"}),e.jsxs("div",{className:"flex items-center space-x-1 text-sm text-muted-foreground",children:[e.jsx(Ee,{className:"w-4 h-4"}),e.jsx("span",{children:"Private forums for nation members"})]})]}),N.length>0&&e.jsx("div",{className:"grid gap-4",children:N.map(o=>{O(o.icon);const I=d===o.nation_name;return e.jsxs(W,{className:"group cursor-pointer hover:shadow-lg transition-all duration-300 border-blue-200 bg-gradient-to-r from-blue-50 to-indigo-50 hover:from-blue-100 hover:to-indigo-100 dark:border-blue-900 dark:from-blue-950 dark:to-indigo-950 dark:hover:from-blue-900 dark:hover:to-indigo-900",onClick:()=>c(o.id),children:[e.jsx(le,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[J(o.nation_name,ee(o.nation_name)),e.jsxs("div",{children:[e.jsxs(ye,{className:"text-lg font-semibold text-foreground",children:[S(o.nation_name)," Forum"]}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:o.description})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[p&&e.jsxs(E,{variant:"default",className:"bg-red-600 text-xs",children:[e.jsx(Ee,{className:"w-3 h-3 mr-1"}),"Admin"]}),x&&!p&&e.jsxs(E,{variant:"default",className:"bg-orange-600 text-xs",children:[e.jsx(fs,{className:"w-3 h-3 mr-1"}),"Moderator"]}),I&&!p&&!x&&e.jsx(E,{variant:"secondary",className:"bg-blue-100 text-blue-800",children:"Your Nation"}),(j==null?void 0:j.isKing)&&e.jsxs(E,{variant:"default",className:"bg-purple-600 text-xs",children:[e.jsx(Ee,{className:"w-3 h-3 mr-1"}),"King"]}),(j==null?void 0:j.isMayor)&&!(j!=null&&j.isKing)&&e.jsxs(E,{variant:"default",className:"bg-yellow-600 text-xs",children:[e.jsx(rs,{className:"w-3 h-3 mr-1"}),"Mayor"]}),w[o.id]&&e.jsx(E,{variant:"destructive",className:"text-xs",children:"New"}),e.jsx(Ve,{subscriptionType:"category",targetId:o.id,targetName:o.name})]})]})}),e.jsx(X,{className:"pt-0",children:e.jsxs("div",{className:"text-sm text-muted-foreground",children:[o.post_count||0," posts"]})})]},o.id)})}),Y.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-700",children:T?"All Town Forums":"Town Forums"}),e.jsx("div",{className:"grid gap-4",children:Y.map(o=>{var L;O(o.icon);const I=(L=r==null?void 0:r.towns.find(A=>A.name===o.town_name))==null?void 0:L.isUserMayor,R=d===o.nation_name;return e.jsxs(W,{className:"group cursor-pointer hover:shadow-lg transition-all duration-300 border-green-200 bg-gradient-to-r from-green-50 to-emerald-50 hover:from-green-100 hover:to-emerald-100 dark:border-green-900 dark:from-green-950 dark:to-emerald-950 dark:hover:from-green-900 dark:hover:to-emerald-900",onClick:()=>c(o.id),children:[e.jsx(le,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[M(o.town_name,ee(o.nation_name)),e.jsx("div",{children:e.jsx(ye,{className:"text-lg font-semibold text-foreground",children:o.name})})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[p&&e.jsxs(E,{variant:"default",className:"bg-red-600 text-xs",children:[e.jsx(Ee,{className:"w-3 h-3 mr-1"}),"Admin"]}),x&&!p&&e.jsxs(E,{variant:"default",className:"bg-orange-600 text-xs",children:[e.jsx(fs,{className:"w-3 h-3 mr-1"}),"Moderator"]}),I&&!p&&!x&&e.jsxs(E,{variant:"outline",className:"text-xs",children:[e.jsx(rs,{className:"w-3 h-3 mr-1"}),"Your Town"]}),R&&!p&&!x&&!I&&e.jsx(E,{variant:"secondary",className:"text-xs dark:bg-blue-900 dark:text-blue-100",children:"Your Nation"}),w[o.id]&&e.jsx(E,{variant:"destructive",className:"text-xs",children:"New"}),e.jsx(Ve,{subscriptionType:"category",targetId:o.id,targetName:o.name})]})]})}),e.jsx(X,{className:"pt-0",children:e.jsxs("div",{className:"text-sm text-muted-foreground",children:[o.post_count||0," posts"]})})]},o.id)})})]}),!d&&s&&!p&&!x&&e.jsx(W,{className:"border-amber-200 bg-gradient-to-r from-amber-50 to-yellow-50",children:e.jsx(X,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ps,{className:"w-5 h-5 text-amber-600"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-amber-900",children:"Join a Nation to Access Private Forums"}),e.jsx("p",{className:"text-sm text-amber-700 mt-1",children:"You need to be a member of a nation to access private nation and town forums. Contact a nation leader or mayor to join their nation."})]})]})})})]}),z.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("h2",{className:"text-2xl font-semibold text-foreground",children:"Official Updates"}),e.jsxs("div",{className:"flex items-center space-x-1 text-sm text-muted-foreground",children:[e.jsx(ps,{className:"w-4 h-4"}),e.jsx("span",{children:"Staff members only"})]})]}),e.jsx("div",{className:"grid gap-4",children:z.map(o=>{const I=O(o.icon);return e.jsxs(W,{className:"group cursor-pointer hover:shadow-lg transition-all duration-300 border-orange-200 bg-gradient-to-r from-orange-50 to-amber-50 dark:border-orange-900 dark:from-orange-950 dark:to-amber-950",onClick:()=>c(o.id),children:[e.jsx(le,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"p-2 rounded-lg",style:{backgroundColor:o.color+"20",color:o.color},children:e.jsx(I,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ye,{className:"text-lg font-semibold text-foreground",children:o.name}),e.jsx(E,{variant:"secondary",className:"bg-orange-100 text-orange-800",children:"Staff Only"})]}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:o.description})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[w[o.id]&&e.jsx(E,{variant:"destructive",className:"text-xs",children:"New"}),e.jsx(Ve,{subscriptionType:"category",targetId:o.id,targetName:o.name})]})]})}),e.jsx(X,{className:"pt-0",children:e.jsx("div",{className:"flex items-center justify-between text-sm text-gray-500",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("span",{children:[o.post_count||0," posts"]}),o.last_activity&&e.jsxs("span",{children:["Last activity: ",new Date(o.last_activity).toLocaleDateString()]})]})})})]},o.id)})})]})]})},Ne=class Ne{constructor(){Ke(this,"realtimeSubscription",null)}static getInstance(){return Ne.instance||(Ne.instance=new Ne),Ne.instance}async createReplyNotification(t,s,a,l,u){try{const{data:d}=await _.from("forum_posts").select("title, category_id").eq("id",t).single(),{data:r}=await _.from("profiles").select("full_name, email").eq("id",l).single();if(!d||!r)return;const p="New reply to your post",x=`${r.full_name||r.email} replied to your post "${d.title}"`,{error:i}=await _.from("forum_notifications").insert({user_id:a,notification_type:"reply",post_id:t,reply_id:s,author_id:l,title:p,message:x,priority:"medium"});if(i)throw i;const{error:h}=await _.from("user_notifications").insert({user_id:a,notification_type:"forum_reply",title:p,message:x,data:{postId:t,replyId:s,categoryId:d.category_id},priority:"medium",sent_at:new Date().toISOString()});h?console.error("Error creating main notification:",h):console.log("Main notification created successfully")}catch(d){console.error("Error creating reply notification:",d)}}async createMentionNotification(t,s,a,l){try{const{data:u}=await _.from("profiles").select("full_name, email").eq("id",a).single();if(!u)return;const d="You were mentioned",r=`${u.full_name||u.email} mentioned you in a post`,{error:p}=await _.from("forum_notifications").insert({user_id:s,notification_type:"mention",post_id:t,author_id:a,title:d,message:r,priority:"high"});if(p)throw p;const{error:x}=await _.from("user_notifications").insert({user_id:s,notification_type:"forum_mention",title:d,message:r,data:{postId:t},priority:"high",sent_at:new Date().toISOString()});x?console.error("Error creating main notification:",x):console.log("Main mention notification created successfully")}catch(u){console.error("Error creating mention notification:",u)}}async createReactionNotification(t,s,a,l){try{const{data:u}=await _.from("forum_posts").select("title, category_id").eq("id",t).single(),{data:d}=await _.from("profiles").select("full_name, email").eq("id",a).single();if(!u||!d||s===a)return;const r="New reaction to your post",p=`${d.full_name||d.email} reacted to your post "${u.title}" with ${l}`,{error:x}=await _.from("forum_notifications").insert({user_id:s,notification_type:"reaction",post_id:t,author_id:a,title:r,message:p,priority:"low"});if(x)throw x;const{error:i}=await _.from("user_notifications").insert({user_id:s,notification_type:"forum_reaction",title:r,message:p,data:{postId:t,emoji:l,categoryId:u.category_id},priority:"low",sent_at:new Date().toISOString()});i?console.error("Error creating main notification:",i):console.log("Main reaction notification created successfully")}catch(u){console.error("Error creating reaction notification:",u)}}extractMentions(t){const s=/@(\w+)/g,a=[];let l;for(;(l=s.exec(t))!==null;)a.push(l[1]);return a}async getUserIdByUsername(t){try{const{data:s,error:a}=await _.from("profiles").select("id").eq("minecraft_username",t).single();return a?null:(s==null?void 0:s.id)||null}catch{return null}}async processMentions(t,s,a){const l=this.extractMentions(t);for(const u of l){const d=await this.getUserIdByUsername(u);d&&d!==a&&await this.createMentionNotification(s,d,a,t)}}async markNotificationRead(t){try{const{error:s}=await _.from("forum_notifications").update({read_at:new Date().toISOString()}).eq("id",t);if(s)throw s}catch(s){console.error("Error marking notification as read:",s)}}async getUserNotifications(t,s=50){try{const{data:a,error:l}=await _.from("forum_notifications").select(`
          *,
          author:profiles(id, full_name, email, avatar_url),
          post:forum_posts(id, title, category_id)
        `).eq("user_id",t).order("created_at",{ascending:!1}).limit(s);if(l)throw l;return a||[]}catch(a){return console.error("Error fetching forum notifications:",a),[]}}async getUnreadCount(t){try{const{count:s,error:a}=await _.from("forum_notifications").select("*",{count:"exact",head:!0}).eq("user_id",t).is("read_at",null);if(a)throw a;return s||0}catch(s){return console.error("Error fetching unread count:",s),0}}setupRealtimeNotifications(t,s){return this.realtimeSubscription&&this.realtimeSubscription.unsubscribe(),this.realtimeSubscription=_.channel("forum_notifications").on("postgres_changes",{event:"INSERT",schema:"public",table:"forum_notifications",filter:`user_id=eq.${t}`},a=>{s(a.new)}).subscribe(),this.realtimeSubscription}cleanup(){this.realtimeSubscription&&(this.realtimeSubscription.unsubscribe(),this.realtimeSubscription=null)}};Ke(Ne,"instance");let ns=Ne;const Wt=ns.getInstance(),ws=new Set,Bs=c=>{const[t,s]=n.useState([]),[a,l]=n.useState(!0),[u,d]=n.useState(null);return Ss(),n.useEffect(()=>{(async()=>{try{let h=_.from("forum_posts").select(`
            *,
            author:profiles(id, full_name, email, avatar_url, minecraft_username)
          `).order("is_pinned",{ascending:!1}).order("created_at",{ascending:!1});c&&(h=h.eq("category_id",c));const{data:w,error:y}=await h;if(y)throw y;s(w||[])}catch(h){d(h instanceof Error?h.message:"An error occurred")}finally{l(!1)}})()},[c]),{posts:t,loading:a,error:u,createPost:async i=>{try{const{data:h,error:w}=await _.from("forum_posts").insert({title:i.title,content:i.content,category_id:i.category_id,author_id:i.author_id,tags:i.tags||[],post_type:i.post_type||"discussion"}).select().single();if(w)throw w;return await Wt.processMentions(i.content,h.id,i.author_id),s(y=>[h,...y]),h}catch(h){throw h}},updatePost:async(i,h)=>{try{const{data:w,error:y}=await _.from("forum_posts").update({...h,updated_at:new Date().toISOString()}).eq("id",i).select().single();if(y)throw y;return s(j=>j.map(v=>v.id===i?{...v,...w}:v)),w}catch(w){throw w}},deletePost:async i=>{try{const{error:h}=await _.from("forum_posts").delete().eq("id",i);if(h)throw h;s(w=>w.filter(y=>y.id!==i))}catch(h){throw h}}}},Yt=async c=>{if(ws.has(c))return;ws.add(c);try{const u=JSON.parse(localStorage.getItem("viewedForumPosts")||"[]");if(u.includes(c))return;u.push(c),localStorage.setItem("viewedForumPosts",JSON.stringify(u))}catch{}const{data:t,error:s}=await _.from("forum_posts").select("view_count").eq("id",c).single();if(s)throw s;const a=(t==null?void 0:t.view_count)||0,{error:l}=await _.from("forum_posts").update({view_count:a+1}).eq("id",c);if(l)throw l},$s=({onSubmit:c,onCancel:t,initialTitle:s="",initialContent:a="",initialTags:l=[],initialPostType:u="discussion",isEditing:d=!1,categoryName:r,categoryId:p,onBack:x})=>{const[i,h]=n.useState(s),[w,y]=n.useState(a),[j,v]=n.useState(l),[S,T]=n.useState(u);he(),ke();const D=n.useRef(!1);n.useEffect(()=>{D.current||(h(s),y(a),v(l),T(u),D.current=!0)},[]);const q=async C=>{C.preventDefault(),i.trim()&&w.trim()&&c(i.trim(),w.trim(),j,S)};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[x&&e.jsxs(g,{variant:"outline",onClick:x,className:"flex items-center space-x-2",children:[e.jsx(_e,{className:"w-4 h-4"}),e.jsx("span",{children:"Back"})]}),e.jsx("h1",{className:"text-2xl font-bold",children:d?"Edit Post":"Create New Post"})]})}),e.jsxs(W,{children:[e.jsx(le,{children:e.jsx(ye,{children:d?"Edit Post":"Create New Post"})}),e.jsx(X,{children:e.jsxs("form",{onSubmit:q,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Title"}),e.jsx(je,{placeholder:"Post title...",value:i,onChange:C=>h(C.target.value),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Post Type"}),e.jsxs("select",{value:S,onChange:C=>T(C.target.value),className:"w-full p-2 border border-gray-300 rounded-md",children:[e.jsx("option",{value:"discussion",children:"Discussion"}),e.jsx("option",{value:"question",children:"Question"}),e.jsx("option",{value:"announcement",children:"Announcement"}),e.jsx("option",{value:"guide",children:"Guide"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Content"}),e.jsx("textarea",{value:w,onChange:C=>y(C.target.value),placeholder:"Write your post content...",rows:8,className:"w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Tags"}),e.jsxs("div",{className:"space-y-2",children:[j.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1",children:j.map(C=>e.jsxs(E,{variant:"outline",className:"text-xs",children:["#",C,e.jsx("button",{type:"button",onClick:()=>v(j.filter(N=>N!==C)),className:"ml-1 hover:bg-muted rounded-full p-0.5",children:e.jsx(ts,{className:"w-3 h-3"})})]},C))}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(je,{placeholder:"Add a tag...",onKeyDown:C=>{if(C.key==="Enter"){C.preventDefault();const N=C.currentTarget.value.trim();N&&!j.includes(N)&&(v([...j,N]),C.currentTarget.value="")}}}),e.jsx(g,{type:"button",variant:"outline",size:"sm",onClick:()=>{const C=document.querySelector('input[placeholder="Add a tag..."]');if(C){const N=C.value.trim();N&&!j.includes(N)&&(v([...j,N]),C.value="")}},children:"Add"})]}),e.jsx("div",{className:"flex flex-wrap gap-1",children:["general","help","announcement","discussion","question","guide"].map(C=>e.jsxs(E,{variant:j.includes(C)?"default":"outline",className:"text-xs cursor-pointer",onClick:()=>{j.includes(C)?v(j.filter(N=>N!==C)):v([...j,C])},children:["#",C]},C))})]})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(g,{type:"submit",disabled:!i.trim()||!w.trim(),children:d?"Update Post":"Create Post"}),e.jsx(g,{type:"button",variant:"outline",onClick:t,children:"Cancel"})]})]})})]})]})},is=c=>["admin","moderator","helper"].includes(c),Gt=({categoryId:c,onBack:t,onPostSelect:s})=>{const{posts:a,loading:l,createPost:u}=Bs(c),{hasAccessToForum:d,loading:r}=ls(),[p,x]=n.useState(null),[i,h]=n.useState(!0),[w,y]=n.useState(!1),{user:j,profile:v}=he();React.useEffect(()=>{let N=!0;return(async()=>{h(!0);const{data:z}=await _.from("forum_categories").select("id, name, role_required, nation_name, town_name").eq("id",c).single();N&&(x(z||null),h(!1))})(),()=>{N=!1}},[c]);const S=p,T=(S==null?void 0:S.role_required)==="moderator"||!1,D=v&&is(v.role),q=j&&(!T||D),C=async(N,Y,z=[],O="discussion")=>{if(j)try{const M=await u({title:N,content:Y,category_id:c,author_id:j.id,tags:z,post_type:O});y(!1),M!=null&&M.id&&s(M.id)}catch(M){console.error("Error creating post:",M)}};return l||r||i?e.jsx("div",{className:"text-center py-8",children:"Loading posts..."}):S&&(S.nation_name||S.town_name)&&!d(S.nation_name||null,S.town_name||null)?e.jsxs("div",{className:"space-y-4",children:[e.jsxs(g,{variant:"ghost",onClick:t,children:[e.jsx(_e,{className:"w-4 h-4 mr-2"}),e.jsx("span",{className:"text-foreground",children:"Back to Categories"})]}),e.jsx(W,{className:"dark:border-muted",children:e.jsx(X,{className:"py-8 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"This forum is private. You don\\'t have access to view posts here."})})})]}):w?e.jsx($s,{onSubmit:C,onCancel:()=>y(!1)}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs(g,{variant:"ghost",onClick:t,children:[e.jsx(_e,{className:"w-4 h-4 mr-2"}),"Back to Categories"]}),e.jsx("span",{className:"text-muted-foreground",children:"‚Ä¢"}),e.jsx("span",{className:"font-medium text-foreground",children:(S==null?void 0:S.name)||"Forum"})]}),q&&e.jsx(g,{onClick:()=>y(!0),children:"New Post"})]}),e.jsx("div",{className:"space-y-4",children:a.length===0?e.jsx(W,{children:e.jsx(X,{className:"py-8 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"No posts yet. Be the first to start a discussion!"})})}):a.map(N=>{var Y,z,O,M,J,ee,o;return e.jsx(W,{className:"cursor-pointer hover:shadow-md transition-shadow dark:border-muted",onClick:()=>s(N.id),children:e.jsxs(le,{className:"pb-3",children:[e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[N.is_pinned&&e.jsx(qs,{className:"w-4 h-4 text-yellow-500"}),N.is_locked&&e.jsx(Ms,{className:"w-4 h-4 text-red-500"}),e.jsx("h3",{className:"text-lg font-semibold",children:N.title})]}),e.jsxs("p",{className:"text-sm text-muted-foreground line-clamp-2",children:[N.content.substring(0,200),"..."]})]})}),e.jsxs("div",{className:"flex items-center justify-between mt-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(Te,{className:"w-6 h-6",children:[e.jsx(Ae,{src:((Y=N.author)==null?void 0:Y.avatar_url)||""}),e.jsx(De,{children:((O=(z=N.author)==null?void 0:z.full_name)==null?void 0:O[0])||((M=N.author)==null?void 0:M.email[0])||"?"})]}),e.jsx("span",{className:"text-sm text-muted-foreground",children:((J=N.author)==null?void 0:J.full_name)||((ee=N.author)==null?void 0:ee.email)}),((o=N.author)==null?void 0:o.id)&&e.jsx(Zt,{userId:N.author.id})]}),e.jsx("span",{className:"text-sm text-muted-foreground",children:be(new Date(N.created_at),{addSuffix:!0})})]})]})},N.id)})})]})},Kt={User:e.jsx("svg",{className:"w-3 h-3"})};function Zt({userId:c}){const{data:t}=Us(c);if(!t||t.length===0)return null;const s=t.find(a=>a.is_verified)||t[0];return e.jsxs(E,{style:{backgroundColor:s.badge_color,color:"white"},className:"text-xs flex items-center gap-1",children:[Kt[s.icon]||null,e.jsx("span",{children:s.badge_type})]})}const Jt=c=>{const[t,s]=n.useState([]),[a,l]=n.useState(!0),[u,d]=n.useState(null);return n.useEffect(()=>{c&&(async()=>{try{const{data:x,error:i}=await _.from("forum_replies").select(`
            *,
            author:profiles(id, full_name, email, avatar_url, minecraft_username)
          `).eq("post_id",c).order("created_at",{ascending:!0});if(i)throw i;s(x||[])}catch(x){d(x instanceof Error?x.message:"An error occurred")}finally{l(!1)}})()},[c]),{replies:t,loading:a,error:u,createReply:async p=>{try{const{data:x,error:i}=await _.from("forum_replies").insert({content:p.content,post_id:p.post_id,author_id:p.author_id,parent_id:p.parent_id||null}).select(`
          *,
          author:profiles(id, full_name, email, avatar_url, minecraft_username)
        `).single();if(i)throw i;return s(h=>[...h,x]),x}catch(x){throw x}}}},es=[{value:"discussion",label:"Discussion",description:"General discussions and conversations",color:"#10b981",icon:Oe},{value:"question",label:"Question",description:"Questions and help requests",color:"#3b82f6",icon:zs},{value:"idea",label:"Idea",description:"Feature suggestions and ideas",color:"#f59e0b",icon:os},{value:"announcement",label:"Announcement",description:"Official announcements and news",color:"#8b5cf6",icon:Ft},{value:"guide",label:"Guide",description:"Tutorials, guides, and how-tos",color:"#06b6d4",icon:Is},{value:"showcase",label:"Showcase",description:"Player creations and showcases",color:"#ec4899",icon:Os}],Xt=()=>({getPostType:s=>es.find(a=>a.value===s),getAllPostTypes:()=>es,postTypes:es}),_s=({value:c,onChange:t,disabled:s=!1})=>{const{getAllPostTypes:a,getPostType:l}=Xt(),[u,d]=Gs.useState(!1),r=l(c),p=n.useRef(null);n.useEffect(()=>{const i=h=>{p.current&&!p.current.contains(h.target)&&d(!1)};return document.addEventListener("mousedown",i),()=>{document.removeEventListener("mousedown",i)}},[]);const x=(i,h)=>{h.preventDefault(),h.stopPropagation(),t(i),d(!1)};return e.jsxs("div",{className:"relative",ref:p,children:[e.jsxs("button",{type:"button",onClick:i=>{i.preventDefault(),i.stopPropagation(),s||d(!u)},disabled:s,className:`
          w-full flex items-center justify-between px-3 py-2 text-sm border rounded-md
          ${s?"bg-gray-100 text-gray-400 cursor-not-allowed":"bg-white text-gray-900 hover:bg-gray-50 cursor-pointer"}
          ${u?"ring-2 ring-blue-500 border-blue-500":"border-gray-300"}
        `,children:[e.jsx("div",{className:"flex items-center gap-2",children:r&&e.jsxs(e.Fragment,{children:[e.jsx(r.icon,{className:"w-4 h-4",style:{color:r.color}}),e.jsx("span",{children:r.label})]})}),e.jsx(Es,{className:`w-4 h-4 transition-transform ${u?"rotate-180":""}`})]}),u&&!s&&e.jsx("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg",children:e.jsx("div",{className:"py-1",children:a().map(i=>e.jsxs("button",{type:"button",onClick:h=>x(i.value,h),className:"w-full flex items-center gap-3 px-3 py-2 text-sm text-left hover:bg-gray-50",children:[e.jsx(i.icon,{className:"w-4 h-4",style:{color:i.color}}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:i.label}),e.jsx("div",{className:"text-xs text-gray-500",children:i.description})]})]},i.value))})})]})},ks=({value:c,onChange:t,placeholder:s="Write your post content...",rows:a=8,disabled:l=!1,onSave:u,showEmojiPicker:d=!0,showImageUpload:r=!0})=>{const p=n.useRef(null),x=n.useRef(null),[i,h]=n.useState(!1),[w,y]=n.useState(""),[j,v]=n.useState(!1),[S,T]=n.useState(!1),[D,q]=n.useState(!1),[C,N]=n.useState(c),[Y,z]=n.useState(0),[O,M]=n.useState(0),[J,ee]=n.useState(!1),[o,I]=n.useState(!1),{user:R}=he(),{toast:L}=ke();n.useEffect(()=>{if(c!==C){const k=setTimeout(()=>{localStorage.setItem("forum_draft",c),N(c),q(!0),setTimeout(()=>q(!1),2e3)},2e3);return()=>clearTimeout(k)}},[c,C]),n.useEffect(()=>{const k=localStorage.getItem("forum_draft");k&&!c&&t(k)},[]),n.useEffect(()=>{const k=c.replace(/<[^>]*>/g,""),U=k.trim().split(/\s+/).filter(H=>H.length>0);z(U.length),M(k.length)},[c]);const A=k=>{if(p.current){const U=p.current,H=U.selectionStart,V=U.selectionEnd,te=c.substring(0,H)+k+c.substring(V);t(te),setTimeout(()=>{U.focus(),U.setSelectionRange(H+k.length,H+k.length)},0)}},$=k=>{switch(k){case"bold":A("**bold text**");break;case"italic":A("*italic text*");break;case"underline":A("__underlined text__");break;case"strikethrough":A("~~strikethrough text~~");break;case"heading1":A(`# Heading 1
`);break;case"heading2":A(`## Heading 2
`);break;case"heading3":A(`### Heading 3
`);break;case"unordered-list":A(`- List item
`);break;case"ordered-list":A(`1. List item
`);break;case"code":A("`code`");break;case"code-block":A("\n```\ncode block\n```\n");break;case"quote":A(`> Quote text
`);break;case"link":A("[link text](url)");break;case"align-left":A(`<!-- Left aligned -->
`);break;case"align-center":A(`<!-- Center aligned -->
`);break;case"align-right":A(`<!-- Right aligned -->
`);break}},Me=async k=>{if(!R)throw new Error("User not authenticated");const U=k.name.split(".").pop(),V=`forum-images/${`${R.id}/${Date.now()}.${U}`}`,{error:te}=await _.storage.from("forum-images").upload(V,k);if(te)throw te;const{data:{publicUrl:ae}}=_.storage.from("forum-images").getPublicUrl(V);return ae},xe=async k=>{if(!k.type.startsWith("image/")){L({title:"Invalid file type",description:"Please select an image file.",variant:"destructive"});return}if(k.size>5*1024*1024){L({title:"File too large",description:"Image must be smaller than 5MB.",variant:"destructive"});return}ee(!0);try{const U=await Me(k);A(`![${k.name}](${U})`),L({title:"Image uploaded",description:"Image has been uploaded and inserted."})}catch(U){console.error("Error uploading image:",U),L({title:"Upload failed",description:"Failed to upload image. Please try again.",variant:"destructive"})}finally{ee(!1)}},Ue=k=>{var H;const U=(H=k.target.files)==null?void 0:H[0];U&&xe(U),x.current&&(x.current.value="")},b=k=>{k.preventDefault(),I(!0)},Ie=k=>{k.preventDefault(),I(!1)},ne=k=>{k.preventDefault(),I(!1);const H=Array.from(k.dataTransfer.files).find(V=>V.type.startsWith("image/"));H?xe(H):L({title:"Invalid file type",description:"Please drop an image file.",variant:"destructive"})};return e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-1 p-2 border border-gray-300 rounded-t-md bg-gray-50",children:[e.jsxs(Fs,{children:[e.jsxs(G,{children:[e.jsx(K,{asChild:!0,children:e.jsx(g,{type:"button",variant:"ghost",size:"sm",onClick:()=>$("bold"),className:"h-8 w-8 p-0",children:e.jsx(bt,{className:"w-4 h-4"})})}),e.jsx(Z,{children:"Bold"})]}),e.jsxs(G,{children:[e.jsx(K,{asChild:!0,children:e.jsx(g,{type:"button",variant:"ghost",size:"sm",onClick:()=>$("italic"),className:"h-8 w-8 p-0",children:e.jsx(wt,{className:"w-4 h-4"})})}),e.jsx(Z,{children:"Italic"})]}),e.jsxs(G,{children:[e.jsx(K,{asChild:!0,children:e.jsx(g,{type:"button",variant:"ghost",size:"sm",onClick:()=>$("underline"),className:"h-8 w-8 p-0",children:e.jsx(Ht,{className:"w-4 h-4"})})}),e.jsx(Z,{children:"Underline"})]}),e.jsxs(G,{children:[e.jsx(K,{asChild:!0,children:e.jsx(g,{type:"button",variant:"ghost",size:"sm",onClick:()=>$("strikethrough"),className:"h-8 w-8 p-0",children:e.jsx(Rt,{className:"w-4 h-4"})})}),e.jsx(Z,{children:"Strikethrough"})]}),e.jsx("div",{className:"w-px h-6 bg-gray-300 mx-1"}),e.jsxs(G,{children:[e.jsx(K,{asChild:!0,children:e.jsx(g,{type:"button",variant:"ghost",size:"sm",onClick:()=>$("heading1"),className:"h-8 w-8 p-0",children:e.jsx(_t,{className:"w-4 h-4"})})}),e.jsx(Z,{children:"Heading 1"})]}),e.jsxs(G,{children:[e.jsx(K,{asChild:!0,children:e.jsx(g,{type:"button",variant:"ghost",size:"sm",onClick:()=>$("heading2"),className:"h-8 w-8 p-0",children:e.jsx(kt,{className:"w-4 h-4"})})}),e.jsx(Z,{children:"Heading 2"})]}),e.jsxs(G,{children:[e.jsx(K,{asChild:!0,children:e.jsx(g,{type:"button",variant:"ghost",size:"sm",onClick:()=>$("heading3"),className:"h-8 w-8 p-0",children:e.jsx(St,{className:"w-4 h-4"})})}),e.jsx(Z,{children:"Heading 3"})]}),e.jsx("div",{className:"w-px h-6 bg-gray-300 mx-1"}),e.jsxs(G,{children:[e.jsx(K,{asChild:!0,children:e.jsx(g,{type:"button",variant:"ghost",size:"sm",onClick:()=>$("unordered-list"),className:"h-8 w-8 p-0",children:e.jsx(Pt,{className:"w-4 h-4"})})}),e.jsx(Z,{children:"Unordered List"})]}),e.jsxs(G,{children:[e.jsx(K,{asChild:!0,children:e.jsx(g,{type:"button",variant:"ghost",size:"sm",onClick:()=>$("ordered-list"),className:"h-8 w-8 p-0",children:e.jsx(It,{className:"w-4 h-4"})})}),e.jsx(Z,{children:"Ordered List"})]}),e.jsxs(G,{children:[e.jsx(K,{asChild:!0,children:e.jsx(g,{type:"button",variant:"ghost",size:"sm",onClick:()=>$("quote"),className:"h-8 w-8 p-0",children:e.jsx(Ct,{className:"w-4 h-4"})})}),e.jsx(Z,{children:"Quote"})]}),e.jsx("div",{className:"w-px h-6 bg-gray-300 mx-1"}),e.jsxs(G,{children:[e.jsx(K,{asChild:!0,children:e.jsx(g,{type:"button",variant:"ghost",size:"sm",onClick:()=>$("code"),className:"h-8 w-8 p-0",children:e.jsx(vs,{className:"w-4 h-4"})})}),e.jsx(Z,{children:"Inline Code"})]}),e.jsxs(G,{children:[e.jsx(K,{asChild:!0,children:e.jsx(g,{type:"button",variant:"ghost",size:"sm",onClick:()=>$("code-block"),className:"h-8 w-8 p-0",children:e.jsx(vs,{className:"w-4 h-4"})})}),e.jsx(Z,{children:"Code Block"})]}),e.jsxs(G,{children:[e.jsx(K,{asChild:!0,children:e.jsx(g,{type:"button",variant:"ghost",size:"sm",onClick:()=>$("link"),className:"h-8 w-8 p-0",children:e.jsx(Et,{className:"w-4 h-4"})})}),e.jsx(Z,{children:"Link"})]}),r&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-px h-6 bg-gray-300 mx-1"}),e.jsxs(G,{children:[e.jsx(K,{asChild:!0,children:e.jsx(g,{type:"button",variant:"ghost",size:"sm",onClick:()=>{var k;return(k=x.current)==null?void 0:k.click()},disabled:J,className:"h-8 w-8 p-0",children:J?e.jsx(Qe,{className:"w-4 h-4 animate-spin"}):e.jsx(Os,{className:"w-4 h-4"})})}),e.jsx(Z,{children:"Upload Image"})]})]}),d&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-px h-6 bg-gray-300 mx-1"}),e.jsxs(ce,{open:S,onOpenChange:T,children:[e.jsx(Ls,{asChild:!0,children:e.jsx(g,{type:"button",variant:"ghost",size:"sm",className:"h-8 w-8 p-0",children:e.jsx(Ks,{className:"w-4 h-4"})})}),e.jsxs(de,{children:[e.jsx(me,{children:e.jsx(ue,{children:"Insert Emoji"})}),e.jsx("div",{className:"grid grid-cols-8 gap-2 p-4",children:["üòÄ","üòÇ","üòç","ü§î","üëç","üëé","‚ù§Ô∏è","üî•","üíØ","üéâ","üöÄ","üí°","‚ö†Ô∏è","‚ùå","‚úÖ","üìù"].map(k=>e.jsx("button",{onClick:()=>{A(k),T(!1)},className:"text-2xl hover:bg-gray-100 rounded p-2",children:k},k))})]})]})]})]}),e.jsx("input",{ref:x,type:"file",accept:"image/*",onChange:Ue,className:"hidden"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Zs,{ref:p,value:c,onChange:k=>t(k.target.value),onFocus:()=>h(!0),onBlur:()=>h(!1),onDragOver:b,onDragLeave:Ie,onDrop:ne,placeholder:s,disabled:l,className:`
            min-h-[${a*1.5}rem] border-t-0 rounded-t-none
            focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent
            ${l?"bg-gray-100 cursor-not-allowed":"bg-white"}
            ${i?"ring-2 ring-blue-500 border-transparent":""}
            ${o?"ring-2 ring-blue-500 border-blue-500 bg-blue-50":""}
            transition-all duration-200
          `,style:{minHeight:`${a*1.5}rem`}}),o&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-blue-500/10 border-2 border-dashed border-blue-500 rounded-md pointer-events-none",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Tt,{className:"w-8 h-8 text-blue-500 mx-auto mb-2"}),e.jsx("p",{className:"text-blue-500 font-medium",children:"Drop image here to upload"})]})})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-2",children:[e.jsxs("p",{children:["Basic formatting: ",e.jsx("strong",{children:"**bold**"}),", ",e.jsx("em",{children:"*italic*"}),", ",e.jsx("code",{children:"`code`"}),", ",e.jsxs("code",{children:[">"," quote"]})]}),e.jsxs("p",{children:["Lists: Use the toolbar buttons or type ",e.jsx("code",{children:"-"})," for bullets, ",e.jsx("code",{children:"1."})," for numbered lists"]}),e.jsxs("p",{children:["Images: Use the image button or type ",e.jsx("code",{children:"![alt](url)"})]})]}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-500 mt-2",children:[e.jsx("div",{className:"flex items-center space-x-4",children:D&&e.jsxs("div",{className:"flex items-center space-x-1 text-green-600",children:[e.jsx(we,{className:"w-3 h-3"}),e.jsx("span",{children:"Draft saved"})]})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("span",{children:[Y," words"]}),e.jsx("span",{children:"‚Ä¢"}),e.jsxs("span",{children:[O," characters"]})]})]}),e.jsx(ce,{open:j,onOpenChange:v,children:e.jsxs(de,{children:[e.jsx(me,{children:e.jsx(ue,{children:"Insert Image"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(Js,{htmlFor:"imageUrl",children:"Image URL"}),e.jsx(je,{id:"imageUrl",value:w,onChange:k=>y(k.target.value),placeholder:"https://example.com/image.jpg"})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(g,{variant:"outline",onClick:()=>v(!1),children:"Cancel"}),e.jsx(g,{onClick:()=>{w&&(A(`![Image](${w})`),y(""),v(!1))},children:"Insert"})]})]})]})})]})},ea=[{id:"bug-report",name:"Bug Report",description:"Report a bug or issue you've encountered",category:"bug-report",tags:["bug-report","help"],content:`## Bug Report

### Description
[Describe the bug in detail]

### Steps to Reproduce
1. [First step]
2. [Second step]
3. [And so on...]

### Expected Behavior
[What you expected to happen]

### Actual Behavior
[What actually happened]

### Environment
- **Server Version:** [e.g., 1.20.1]
- **Client Version:** [e.g., 1.20.1]
- **Mods/Plugins:** [List any mods or plugins you're using]

### Additional Information
- Screenshots: [If applicable]
- Logs: [If applicable]
- Related Issues: [If applicable]`,icon:"üêõ"},{id:"feature-request",name:"Feature Request",description:"Suggest a new feature or improvement",category:"feature-request",tags:["feature-request","suggestion"],content:`## Feature Request

### Summary
[Brief description of the feature you'd like to see]

### Problem Statement
[Describe the problem this feature would solve]

### Proposed Solution
[Describe your proposed solution in detail]

### Benefits
- [Benefit 1]
- [Benefit 2]
- [Benefit 3]

### Alternative Solutions
[If you've considered other approaches, describe them here]

### Additional Context
[Any other relevant information]`,icon:"üí°"},{id:"guide",name:"Guide",description:"Create a helpful guide or tutorial",category:"guide",tags:["guide","tutorial","help"],content:`## Guide: [Title]

### Overview
[Brief overview of what this guide covers]

### Prerequisites
- [Requirement 1]
- [Requirement 2]
- [Requirement 3]

### Step-by-Step Instructions

#### Step 1: [First Step]
[Detailed instructions for the first step]

#### Step 2: [Second Step]
[Detailed instructions for the second step]

#### Step 3: [Third Step]
[Detailed instructions for the third step]

### Tips and Tricks
- [Tip 1]
- [Tip 2]
- [Tip 3]

### Troubleshooting
**Common Issues:**
- [Issue 1]: [Solution 1]
- [Issue 2]: [Solution 2]

### Additional Resources
- [Link to related documentation]
- [Link to video tutorial]
- [Link to forum thread]`,icon:"üìö"},{id:"question",name:"Question",description:"Ask a question to the community",category:"question",tags:["question","help"],content:`## Question: [Your Question]

### Context
[Provide context for your question]

### What I've Tried
[Describe what you've already attempted]

### Specific Question
[State your specific question clearly]

### Additional Information
- [Any relevant details]
- [Screenshots if applicable]
- [Error messages if applicable]

### What I'm Looking For
[Describe the type of help you're seeking]`,icon:"‚ùì"},{id:"discussion",name:"Discussion",description:"Start a general discussion topic",category:"discussion",tags:["discussion","community"],content:`## Discussion: [Topic]

### Topic Overview
[Brief overview of what you'd like to discuss]

### Key Points
- [Point 1]
- [Point 2]
- [Point 3]

### Questions for Discussion
1. [Question 1]
2. [Question 2]
3. [Question 3]

### Your Thoughts
[Share your initial thoughts on the topic]

### What I Hope to Learn
[What you hope to gain from this discussion]`,icon:"üí¨"},{id:"announcement",name:"Announcement",description:"Make an important announcement",category:"announcement",tags:["announcement","news"],content:`## Announcement: [Title]

### Summary
[Brief summary of the announcement]

### Details
[Detailed information about the announcement]

### Important Dates
- **Date:** [When this takes effect]
- **Deadline:** [If applicable]

### Action Required
[What people need to do, if anything]

### Contact Information
[How to get more information or ask questions]

### Additional Notes
[Any other relevant information]`,icon:"üì¢"}],sa=({onSelectTemplate:c,className:t})=>{const[s,a]=n.useState(null),[l,u]=n.useState(null),d=i=>{a(i)},r=()=>{s&&(c(s),a(null))},p=async i=>{try{await navigator.clipboard.writeText(i.content),u(i.id),setTimeout(()=>u(null),2e3)}catch(h){console.error("Failed to copy template:",h)}},x=i=>({"bug-report":"bg-red-100 text-red-800","feature-request":"bg-blue-100 text-blue-800",guide:"bg-green-100 text-green-800",question:"bg-yellow-100 text-yellow-800",discussion:"bg-purple-100 text-purple-800",announcement:"bg-orange-100 text-orange-800"})[i]||"bg-gray-100 text-gray-800";return e.jsxs("div",{className:gs("space-y-4",t),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Post Templates"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"Choose a template to get started quickly"})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:ea.map(i=>e.jsxs(W,{className:gs("cursor-pointer transition-all hover:shadow-md",(s==null?void 0:s.id)===i.id&&"ring-2 ring-primary"),onClick:()=>d(i),children:[e.jsx(le,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"text-2xl",children:i.icon}),e.jsx(ye,{className:"text-base",children:i.name})]}),e.jsx(E,{className:x(i.category),children:i.category})]})}),e.jsxs(X,{className:"pt-0",children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:i.description}),e.jsxs("div",{className:"flex flex-wrap gap-1 mb-3",children:[i.tags.slice(0,3).map(h=>e.jsxs(E,{variant:"outline",className:"text-xs",children:["#",h]},h)),i.tags.length>3&&e.jsxs(E,{variant:"outline",className:"text-xs",children:["+",i.tags.length-3," more"]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs(g,{variant:"outline",size:"sm",onClick:h=>{h.stopPropagation(),p(i)},children:[l===i.id?e.jsx(we,{className:"w-4 h-4 mr-1"}):e.jsx(Ns,{className:"w-4 h-4 mr-1"}),l===i.id?"Copied!":"Copy"]}),e.jsxs(g,{size:"sm",onClick:h=>{h.stopPropagation(),d(i)},children:[e.jsx(Xs,{className:"w-4 h-4 mr-1"}),"Use Template"]})]})]})]},i.id))}),e.jsx(ce,{open:!!s,onOpenChange:()=>a(null),children:e.jsxs(de,{className:"max-w-4xl max-h-[80vh]",children:[e.jsx(me,{children:e.jsxs(ue,{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"text-2xl",children:s==null?void 0:s.icon}),e.jsxs("span",{children:[s==null?void 0:s.name," Template"]})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"Description"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s==null?void 0:s.description})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"Tags"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:s==null?void 0:s.tags.map(i=>e.jsxs(E,{variant:"outline",className:"text-xs",children:["#",i]},i))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"Template Content"}),e.jsx(et,{className:"h-64 w-full border rounded-md p-4",children:e.jsx("pre",{className:"text-sm whitespace-pre-wrap font-mono",children:s==null?void 0:s.content})})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsxs(g,{variant:"outline",onClick:()=>p(s),children:[l===(s==null?void 0:s.id)?e.jsx(we,{className:"w-4 h-4 mr-2"}):e.jsx(Ns,{className:"w-4 h-4 mr-2"}),l===(s==null?void 0:s.id)?"Copied!":"Copy Content"]}),e.jsxs(g,{onClick:r,children:[e.jsx(st,{className:"w-4 h-4 mr-2"}),"Use This Template"]})]})]})]})})]})};class ta{async createPostVersion(t,s,a){var l;try{const{data:u}=await _.from("forum_post_versions").select("version_number").eq("post_id",t).order("version_number",{ascending:!1}).limit(1),d=((l=u==null?void 0:u[0])==null?void 0:l.version_number)+1||1,{data:r,error:p}=await _.from("forum_post_versions").insert({post_id:t,title:s.title,content:s.content,tags:s.tags,post_type:s.post_type,version_number:d,created_by:a,change_summary:s.change_summary}).select().single();if(p)throw p;return r}catch(u){throw console.error("Error creating post version:",u),u}}async getPostVersions(t){try{const{data:s,error:a}=await _.from("forum_post_versions").select(`
          *,
          created_by_user:profiles!forum_post_versions_created_by_fkey(username, avatar_url)
        `).eq("post_id",t).order("version_number",{ascending:!1});if(a)throw a;return s||[]}catch(s){throw console.error("Error fetching post versions:",s),s}}async restorePostVersion(t,s,a){try{const{data:l,error:u}=await _.from("forum_post_versions").select("*").eq("id",s).single();if(u)throw u;await this.createPostVersion(t,{title:l.title,content:l.content,tags:l.tags,post_type:l.post_type,change_summary:`Restored from version ${l.version_number}`},a);const{error:d}=await _.from("forum_posts").update({title:l.title,content:l.content,tags:l.tags,post_type:l.post_type,updated_at:new Date().toISOString()}).eq("id",t);if(d)throw d}catch(l){throw console.error("Error restoring post version:",l),l}}async inviteCollaborator(t,s,a,l){try{const{data:u,error:d}=await _.from("forum_post_collaborations").insert({post_id:t,user_id:s,role:a,invited_by:l,status:"pending"}).select().single();if(d)throw d;return u}catch(u){throw console.error("Error inviting collaborator:",u),u}}async getPostCollaborations(t){try{const{data:s,error:a}=await _.from("forum_post_collaborations").select(`
          *,
          user:profiles!forum_post_collaborations_user_id_fkey(username, avatar_url),
          invited_by_user:profiles!forum_post_collaborations_invited_by_fkey(username)
        `).eq("post_id",t);if(a)throw a;return s||[]}catch(s){throw console.error("Error fetching post collaborations:",s),s}}async acceptCollaborationInvite(t){try{const{error:s}=await _.from("forum_post_collaborations").update({status:"accepted",accepted_at:new Date().toISOString()}).eq("id",t);if(s)throw s}catch(s){throw console.error("Error accepting collaboration invite:",s),s}}async declineCollaborationInvite(t){try{const{error:s}=await _.from("forum_post_collaborations").update({status:"declined"}).eq("id",t);if(s)throw s}catch(s){throw console.error("Error declining collaboration invite:",s),s}}async trackPostView(t,s){try{const{error:a}=await _.from("forum_post_analytics").upsert({post_id:t,view_count:1,unique_viewers:s?1:0,last_updated:new Date().toISOString()},{onConflict:"post_id"});if(a)throw a}catch(a){console.error("Error tracking post view:",a)}}async updatePostAnalytics(t,s){try{const{error:a}=await _.from("forum_post_analytics").update({...s,last_updated:new Date().toISOString()}).eq("post_id",t);if(a)throw a}catch(a){throw console.error("Error updating post analytics:",a),a}}async getPostAnalytics(t){try{const{data:s,error:a}=await _.from("forum_post_analytics").select("*").eq("post_id",t).single();if(a)throw a;return s}catch(s){return console.error("Error fetching post analytics:",s),null}}async searchPostsWithAI(t,s={}){var a,l,u;try{let d=_.from("forum_posts").select(`
          *,
          author:profiles!forum_posts_author_id_fkey(username, avatar_url),
          category:forum_categories(name, slug)
        `);t.trim()&&(d=d.or(`title.ilike.%${t}%,content.ilike.%${t}%`)),((a=s.categories)==null?void 0:a.length)>0&&(d=d.in("category_id",s.categories)),((l=s.tags)==null?void 0:l.length)>0&&(d=d.overlaps("tags",s.tags)),((u=s.authors)==null?void 0:u.length)>0&&(d=d.in("author_id",s.authors));const{data:r,error:p}=await d.order("created_at",{ascending:!1});if(p)throw p;return r||[]}catch(d){throw console.error("Error searching posts with AI:",d),d}}async analyzePostQuality(t){try{const s=t.split(/\s+/).filter(i=>i.length>0),a=t.split(/[.!?]+/).filter(i=>i.trim().length>0),l=t.split(/\n\s*\n/).filter(i=>i.trim().length>0),u=s.length/a.length,d=a.length/l.length,r=Math.max(0,Math.min(100,206.835-1.015*u-84.6*d)),p=Math.ceil(s.length/200),x=[];return u>20&&x.push("Consider breaking down long sentences for better readability"),d>5&&x.push("Consider splitting long paragraphs"),s.length<50&&x.push("Consider adding more detail to your post"),{readability_score:Math.round(r),word_count:s.length,estimated_read_time:p,suggestions:x}}catch(s){return console.error("Error analyzing post quality:",s),{readability_score:0,word_count:0,estimated_read_time:0,suggestions:[]}}}async autoSavePost(t,s,a){try{const{data:l}=await _.from("forum_posts").select("updated_at, last_edited_by").eq("id",t).single();if(l&&l.last_edited_by!==a){const d=new Date(l.updated_at);if((new Date().getTime()-d.getTime())/(1e3*60)<5)throw new Error("Post was recently edited by another user. Please refresh and try again.")}await this.createPostVersion(t,s,a);const{error:u}=await _.from("forum_posts").update({title:s.title,content:s.content,tags:s.tags,post_type:s.post_type,updated_at:new Date().toISOString(),last_edited_by:a}).eq("id",t);if(u)throw u}catch(l){throw console.error("Error auto-saving post:",l),l}}}const oe=new ta,aa=({onSubmit:c,onCancel:t,initialTitle:s="",initialContent:a="",initialTags:l=[],initialPostType:u="discussion",isEditing:d=!1,postId:r,categoryName:p,categoryId:x,onBack:i})=>{const[h,w]=n.useState(s),[y,j]=n.useState(a),[v,S]=n.useState(l),[T,D]=n.useState(u),[q,C]=n.useState(!1),[N,Y]=n.useState(null),[z,O]=n.useState("editor"),[M,J]=n.useState(!1),[ee,o]=n.useState(!1),[I,R]=n.useState(!1),[L,A]=n.useState(!1),[$,Me]=n.useState([]),[xe,Ue]=n.useState([]),[b,Ie]=n.useState(null),[ne,k]=n.useState(!1),[U,H]=n.useState(!0),[V,te]=n.useState({userId:"",role:"viewer"}),[ae,Fe]=n.useState(""),{user:fe}=he(),{toast:pe}=ke(),ve=n.useRef();n.useEffect(()=>{w(s),j(a),S(l),D(u)},[s,a,l,u]),n.useEffect(()=>{d&&r&&(Ye(),He())},[d,r]),n.useEffect(()=>(U&&q&&fe&&(h.trim()||y.trim())&&(ve.current&&clearTimeout(ve.current),ve.current=setTimeout(async()=>{if(d&&r)try{await oe.autoSavePost(r,{title:h,content:y,tags:v,post_type:T},fe.id),Y(new Date),C(!1),pe({title:"Auto-saved",description:"Your changes have been automatically saved."})}catch(m){console.error("Auto-save error:",m),pe({title:"Auto-save failed",description:"Please save manually to avoid losing changes.",variant:"destructive"})}},3e3)),()=>{ve.current&&clearTimeout(ve.current)}),[h,y,v,T,q,U,fe,d,r]),n.useEffect(()=>{const m=h!==s||y!==a||JSON.stringify(v)!==JSON.stringify(l)||T!==u;C(m)},[h,y,v,T,s,a,l,u]);const Ye=async()=>{if(r)try{const m=await oe.getPostVersions(r);Me(m)}catch(m){console.error("Error loading version history:",m)}},He=async()=>{if(r)try{const m=await oe.getPostCollaborations(r);Ue(m)}catch(m){console.error("Error loading collaborations:",m)}},Ge=m=>{const Q=m.content.split(`
`);let ge=m.name;Q[0]&&Q[0].startsWith("##")&&(ge=Q[0].replace("##","").trim()),w(ge),j(m.content),S(m.tags),D(m.category),O("editor"),pe({title:"Template applied",description:`${m.name} template has been loaded.`})},Be=async m=>{m.preventDefault(),h.trim()&&y.trim()&&c(h.trim(),y.trim(),v,T)},Le=async()=>{if(y.trim()){k(!0);try{const m=await oe.analyzePostQuality(y);Ie(m),A(!0)}catch(m){console.error("Error analyzing content quality:",m),pe({title:"Analysis failed",description:"Could not analyze content quality.",variant:"destructive"})}finally{k(!1)}}},$e=async()=>{if(!(!r||!fe||!V.userId))try{await oe.inviteCollaborator(r,V.userId,V.role,fe.id),te({userId:"",role:"viewer"}),He(),pe({title:"Invitation sent",description:"Collaboration invitation has been sent."})}catch(m){console.error("Error inviting collaborator:",m),pe({title:"Invitation failed",description:"Could not send collaboration invitation.",variant:"destructive"})}},Se=()=>{ae.trim()&&!v.includes(ae.trim())&&(S([...v,ae.trim()]),Fe(""))},Ce=m=>{S(v.filter(Q=>Q!==m))};return e.jsxs("div",{className:"space-y-6",children:[(p||i)&&e.jsxs("div",{className:"flex items-center space-x-2 text-sm text-muted-foreground",children:[i&&e.jsxs(e.Fragment,{children:[e.jsxs(g,{variant:"ghost",size:"sm",onClick:i,className:"p-0 h-auto",children:[e.jsx(_e,{className:"h-4 w-4 mr-1"}),"Back"]}),e.jsx("span",{className:"text-muted-foreground",children:"‚Ä¢"})]}),p&&e.jsxs("span",{className:"font-medium text-foreground",children:["Posting in: ",p]})]}),e.jsxs(W,{children:[e.jsx(le,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(ye,{className:"flex items-center space-x-2",children:[e.jsx(bs,{className:"w-5 h-5"}),e.jsx("span",{children:d?"Edit Post":"Create New Post"}),q&&e.jsxs(E,{variant:"secondary",className:"text-xs",children:[e.jsx(js,{className:"w-3 h-3 mr-1"}),"Unsaved"]})]}),d&&r&&e.jsx("div",{className:"flex items-center space-x-2",children:e.jsxs(Fs,{children:[e.jsxs(G,{children:[e.jsx(K,{asChild:!0,children:e.jsxs(g,{variant:"outline",size:"sm",onClick:()=>J(!0),children:[e.jsx(We,{className:"w-4 h-4 mr-1"}),"History"]})}),e.jsx(Z,{children:"View version history"})]}),e.jsxs(G,{children:[e.jsx(K,{asChild:!0,children:e.jsxs(g,{variant:"outline",size:"sm",onClick:()=>o(!0),children:[e.jsx(qe,{className:"w-4 h-4 mr-1"}),"Collaborate"]})}),e.jsx(Z,{children:"Manage collaborators"})]}),e.jsxs(G,{children:[e.jsx(K,{asChild:!0,children:e.jsxs(g,{variant:"outline",size:"sm",onClick:()=>R(!0),children:[e.jsx(Rs,{className:"w-4 h-4 mr-1"}),"Analytics"]})}),e.jsx(Z,{children:"View post analytics"})]})]})})]})}),e.jsxs(X,{children:[!d&&e.jsxs(tt,{value:z,onValueChange:O,className:"mb-6",children:[e.jsxs(at,{className:"grid w-full grid-cols-3",children:[e.jsxs(Ze,{value:"editor",className:"flex items-center space-x-2",children:[e.jsx(bs,{className:"w-4 h-4"}),e.jsx("span",{children:"Editor"})]}),e.jsxs(Ze,{value:"templates",className:"flex items-center space-x-2",children:[e.jsx(rt,{className:"w-4 h-4"}),e.jsx("span",{children:"Templates"})]}),e.jsxs(Ze,{value:"quality",className:"flex items-center space-x-2",children:[e.jsx(Pe,{className:"w-4 h-4"}),e.jsx("span",{children:"Quality"})]})]}),e.jsx(Je,{value:"editor",className:"space-y-4",children:e.jsxs("form",{onSubmit:Be,className:"space-y-4",children:[e.jsx("div",{children:e.jsx(je,{placeholder:"Post title...",value:h,onChange:m=>w(m.target.value),required:!0})}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Post Type"}),e.jsx(_s,{value:T,onChange:D})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Content"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(g,{type:"button",variant:"outline",size:"sm",onClick:Le,disabled:ne||!y.trim(),children:[ne?e.jsx(Qe,{className:"w-4 h-4 mr-1 animate-spin"}):e.jsx(Pe,{className:"w-4 h-4 mr-1"}),"Analyze"]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"autoSave",checked:U,onChange:m=>H(m.target.checked),className:"rounded"}),e.jsx("label",{htmlFor:"autoSave",className:"text-xs text-muted-foreground",children:"Auto-save"})]})]})]}),e.jsx(ks,{value:y,onChange:j,placeholder:"Write your post content...",rows:12,showEmojiPicker:!0,showImageUpload:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Tags"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(je,{placeholder:"Add custom tag...",value:ae,onChange:m=>Fe(m.target.value),onKeyPress:m=>m.key==="Enter"&&(m.preventDefault(),Se()),className:"flex-1"}),e.jsx(g,{type:"button",variant:"outline",onClick:Se,children:"Add"})]}),e.jsx("div",{className:"flex flex-wrap gap-1",children:["general","help","announcement","discussion","question","guide","bug-report","feature-request"].map(m=>e.jsxs(E,{variant:v.includes(m)?"default":"outline",className:"text-xs cursor-pointer",onClick:()=>{v.includes(m)?Ce(m):S([...v,m])},children:["#",m]},m))}),v.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1",children:v.map(m=>e.jsxs(E,{variant:"default",className:"text-xs",children:["#",m,e.jsx("button",{onClick:()=>Ce(m),className:"ml-1 hover:text-red-200",children:e.jsx(ts,{className:"w-3 h-3"})})]},m))})]})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(g,{type:"submit",disabled:!h.trim()||!y.trim(),children:d?"Update Post":"Create Post"}),e.jsx(g,{type:"button",variant:"outline",onClick:t,children:"Cancel"})]}),q&&e.jsxs("div",{className:"text-sm text-amber-600 flex items-center",children:[e.jsx(js,{className:"w-4 h-4 mr-1"}),"You have unsaved changes"]}),N&&e.jsxs("div",{className:"text-xs text-muted-foreground flex items-center",children:[e.jsx(nt,{className:"w-4 h-4 mr-1"}),"Last saved: ",be(N,{addSuffix:!0})]})]})}),e.jsx(Je,{value:"templates",className:"space-y-4",children:e.jsx(sa,{onSelectTemplate:Ge})}),e.jsx(Je,{value:"quality",className:"space-y-4",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Pe,{className:"w-12 h-12 mx-auto text-muted-foreground mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Content Quality Analysis"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Analyze your content for readability, engagement, and improvement suggestions."}),e.jsxs(g,{onClick:Le,disabled:ne||!y.trim(),children:[ne?e.jsx(Qe,{className:"w-4 h-4 mr-2 animate-spin"}):e.jsx(Pe,{className:"w-4 h-4 mr-2"}),"Analyze Content Quality"]})]})})]}),d&&e.jsxs("form",{onSubmit:Be,className:"space-y-4",children:[e.jsx("div",{children:e.jsx(je,{placeholder:"Post title...",value:h,onChange:m=>w(m.target.value),required:!0})}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Post Type"}),e.jsx(_s,{value:T,onChange:D})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Content"}),e.jsxs(g,{type:"button",variant:"outline",size:"sm",onClick:Le,disabled:ne||!y.trim(),children:[ne?e.jsx(Qe,{className:"w-4 h-4 mr-1 animate-spin"}):e.jsx(Pe,{className:"w-4 h-4 mr-1"}),"Analyze"]})]}),e.jsx(ks,{value:y,onChange:j,placeholder:"Write your post content...",rows:12,showEmojiPicker:!0,showImageUpload:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Tags"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(je,{placeholder:"Add custom tag...",value:ae,onChange:m=>Fe(m.target.value),onKeyPress:m=>m.key==="Enter"&&(m.preventDefault(),Se()),className:"flex-1"}),e.jsx(g,{type:"button",variant:"outline",onClick:Se,children:"Add"})]}),e.jsx("div",{className:"flex flex-wrap gap-1",children:["general","help","announcement","discussion","question","guide","bug-report","feature-request"].map(m=>e.jsxs(E,{variant:v.includes(m)?"default":"outline",className:"text-xs cursor-pointer",onClick:()=>{v.includes(m)?Ce(m):S([...v,m])},children:["#",m]},m))}),v.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1",children:v.map(m=>e.jsxs(E,{variant:"default",className:"text-xs",children:["#",m,e.jsx("button",{onClick:()=>Ce(m),className:"ml-1 hover:text-red-200",children:e.jsx(ts,{className:"w-3 h-3"})})]},m))})]})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(g,{type:"submit",disabled:!h.trim()||!y.trim(),children:"Update Post"}),e.jsx(g,{type:"button",variant:"outline",onClick:t,children:"Cancel"})]})]})]})]}),e.jsx(ce,{open:M,onOpenChange:J,children:e.jsxs(de,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsx(me,{children:e.jsxs(ue,{className:"flex items-center space-x-2",children:[e.jsx(We,{className:"w-5 h-5"}),e.jsx("span",{children:"Version History"})]})}),e.jsx("div",{className:"space-y-4",children:$.map(m=>e.jsxs(W,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(E,{variant:"outline",children:["v",m.version_number]}),e.jsx("span",{className:"text-sm text-muted-foreground",children:be(new Date(m.created_at),{addSuffix:!0})})]}),e.jsx(g,{variant:"outline",size:"sm",onClick:()=>{w(m.title),j(m.content),S(m.tags),D(m.post_type),J(!1)},children:"Restore"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium",children:m.title}),m.change_summary&&e.jsx("p",{className:"text-sm text-muted-foreground",children:m.change_summary}),e.jsx("div",{className:"flex flex-wrap gap-1",children:m.tags.map(Q=>e.jsxs(E,{variant:"secondary",className:"text-xs",children:["#",Q]},Q))})]})]},m.id))})]})}),e.jsx(ce,{open:ee,onOpenChange:o,children:e.jsxs(de,{className:"max-w-2xl",children:[e.jsx(me,{children:e.jsxs(ue,{className:"flex items-center space-x-2",children:[e.jsx(qe,{className:"w-5 h-5"}),e.jsx("span",{children:"Collaboration Management"})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"Invite Collaborator"}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(je,{placeholder:"User ID or username",value:V.userId,onChange:m=>te({...V,userId:m.target.value})}),e.jsxs(it,{value:V.role,onValueChange:m=>te({...V,role:m}),children:[e.jsx(ot,{className:"w-32",children:e.jsx(lt,{})}),e.jsxs(ct,{children:[e.jsx(Xe,{value:"viewer",children:"Viewer"}),e.jsx(Xe,{value:"editor",children:"Editor"}),e.jsx(Xe,{value:"admin",children:"Admin"})]})]}),e.jsxs(g,{onClick:$e,disabled:!V.userId,children:[e.jsx(At,{className:"w-4 h-4 mr-1"}),"Invite"]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"Current Collaborators"}),e.jsxs("div",{className:"space-y-2",children:[xe.map(m=>{var Q,ge,Re,ze;return e.jsx("div",{className:"flex items-center justify-between p-2 border rounded",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(Te,{className:"w-6 h-6",children:[e.jsx(Ae,{src:(Q=m.user)==null?void 0:Q.avatar_url}),e.jsx(De,{children:(Re=(ge=m.user)==null?void 0:ge.username)==null?void 0:Re[0]})]}),e.jsx("span",{className:"text-sm",children:(ze=m.user)==null?void 0:ze.username}),e.jsx(E,{variant:"outline",className:"text-xs",children:m.role}),m.status==="pending"&&e.jsx(E,{variant:"secondary",className:"text-xs",children:"Pending"})]})},m.id)}),xe.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"No collaborators yet"})]})]})]})]})}),e.jsx(ce,{open:L,onOpenChange:A,children:e.jsxs(de,{className:"max-w-2xl",children:[e.jsx(me,{children:e.jsxs(ue,{className:"flex items-center space-x-2",children:[e.jsx(Pe,{className:"w-5 h-5"}),e.jsx("span",{children:"Content Quality Analysis"})]})}),b&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs(W,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(Is,{className:"w-4 h-4"}),e.jsx("span",{className:"font-medium",children:"Readability"})]}),e.jsxs("div",{className:"text-2xl font-bold",children:[b.readability_score,"/100"]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:b.readability_score>=80?"Excellent":b.readability_score>=60?"Good":b.readability_score>=40?"Fair":"Needs improvement"})]}),e.jsxs(W,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(As,{className:"w-4 h-4"}),e.jsx("span",{className:"font-medium",children:"Read Time"})]}),e.jsxs("div",{className:"text-2xl font-bold",children:[b.estimated_read_time," min"]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[b.word_count," words"]})]})]}),b.suggestions.length>0&&e.jsxs(W,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(os,{className:"w-4 h-4"}),e.jsx("span",{className:"font-medium",children:"Suggestions"})]}),e.jsx("ul",{className:"space-y-1",children:b.suggestions.map((m,Q)=>e.jsxs("li",{className:"text-sm flex items-start space-x-2",children:[e.jsx(dt,{className:"w-3 h-3 mt-0.5 text-amber-500"}),e.jsx("span",{children:m})]},Q))})]})]})]})})]})},ra=({postId:c,postTitle:t,onNotificationChange:s})=>{const{user:a}=he(),{toast:l}=ke(),[u,d]=n.useState(!1),[r,p]=n.useState(null),[x,i]=n.useState(!1);n.useEffect(()=>{a&&h()},[a,c]);const h=async()=>{try{const{data:D,error:q}=await _.from("forum_notification_settings").select("*").eq("user_id",a.id).eq("post_id",c).single();if(q&&q.code!=="PGRST116")throw q;p(D)}catch(D){console.error("Error fetching notification settings:",D)}},w=async D=>{if(a){i(!0);try{if(r){const{error:q}=await _.from("forum_notification_settings").update({...D,updated_at:new Date().toISOString()}).eq("id",r.id);if(q)throw q}else{const{error:q}=await _.from("forum_notification_settings").insert({user_id:a.id,post_id:c,email_notifications:!0,push_notifications:!0,reply_notifications:!0,mention_notifications:!0,...D});if(q)throw q}await h(),s==null||s(),l({title:"Settings updated",description:"Your notification preferences have been saved."})}catch(q){console.error("Error updating notification settings:",q),l({title:"Error",description:"Failed to update notification settings.",variant:"destructive"})}finally{i(!1)}}},y=()=>{w({email_notifications:!(r!=null&&r.email_notifications)})},j=()=>{w({push_notifications:!(r!=null&&r.push_notifications)})},v=()=>{w({reply_notifications:!(r!=null&&r.reply_notifications)})},S=()=>{w({mention_notifications:!(r!=null&&r.mention_notifications)})},T=r&&(r.email_notifications||r.push_notifications||r.reply_notifications||r.mention_notifications);return e.jsxs(ce,{open:u,onOpenChange:d,children:[e.jsx(Ls,{asChild:!0,children:e.jsxs(g,{variant:T?"default":"outline",size:"sm",className:"h-8 px-2",children:[T?e.jsx(ss,{className:"w-4 h-4 mr-1"}):e.jsx(Hs,{className:"w-4 h-4 mr-1"}),T?"Subscribed":"Subscribe"]})}),e.jsxs(de,{className:"max-w-md",children:[e.jsx(me,{children:e.jsxs(ue,{className:"flex items-center space-x-2",children:[e.jsx(mt,{className:"w-5 h-5"}),e.jsx("span",{children:"Notification Settings"})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:['Configure how you want to be notified about activity on "',t,'"']}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Oe,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm font-medium",children:"Email Notifications"})]}),e.jsx(g,{variant:r!=null&&r.email_notifications?"default":"outline",size:"sm",onClick:y,disabled:x,className:"h-8 px-3",children:r!=null&&r.email_notifications?e.jsx(we,{className:"w-4 h-4"}):"Off"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ss,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm font-medium",children:"Push Notifications"})]}),e.jsx(g,{variant:r!=null&&r.push_notifications?"default":"outline",size:"sm",onClick:j,disabled:x,className:"h-8 px-3",children:r!=null&&r.push_notifications?e.jsx(we,{className:"w-4 h-4"}):"Off"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Oe,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm font-medium",children:"Reply Notifications"})]}),e.jsx(g,{variant:r!=null&&r.reply_notifications?"default":"outline",size:"sm",onClick:v,disabled:x,className:"h-8 px-3",children:r!=null&&r.reply_notifications?e.jsx(we,{className:"w-4 h-4"}):"Off"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ut,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm font-medium",children:"Mention Notifications"})]}),e.jsx(g,{variant:r!=null&&r.mention_notifications?"default":"outline",size:"sm",onClick:S,disabled:x,className:"h-8 px-3",children:r!=null&&r.mention_notifications?e.jsx(we,{className:"w-4 h-4"}):"Off"})]})]}),e.jsx("div",{className:"pt-4 border-t",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Status:"}),e.jsx(E,{variant:T?"default":"secondary",children:T?"Subscribed":"Not Subscribed"})]})}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[e.jsx("p",{children:"‚Ä¢ Email notifications will be sent to your registered email address"}),e.jsx("p",{children:"‚Ä¢ Push notifications require browser permission"}),e.jsx("p",{children:"‚Ä¢ Reply notifications alert you to new replies on this post"}),e.jsx("p",{children:"‚Ä¢ Mention notifications alert you when someone mentions you"})]})]})]})]})},na=({postId:c,onBack:t})=>{var ge,Re,ze,cs,ds,ms,us;const{posts:s,updatePost:a,deletePost:l}=Bs(),{replies:u,createReply:d}=Jt(c),[r,p]=n.useState(""),{user:x,profile:i}=he(),{hasAccessToForum:h,isAdmin:w,isModerator:y,loading:j}=ls();n.useState(!1);const[v,S]=n.useState(!1),[T,D]=n.useState(!1),[q,C]=n.useState(!1),[N,Y]=n.useState(!1),[z,O]=n.useState([]),[M,J]=n.useState([]),[ee,o]=n.useState(null),[I,R]=n.useState({likes:0,dislikes:0,shares:0,bookmarks:0,comments:0}),[L,A]=n.useState({liked:!1,disliked:!1,bookmarked:!1}),[$,Me]=n.useState(0),[xe,Ue]=n.useState(0),[b,Ie]=n.useState(null),[ne,k]=n.useState(!0),{toast:U}=ke(),{data:H}=Us(((ge=b==null?void 0:b.author)==null?void 0:ge.minecraft_username)||""),V=n.useRef(null),te=n.useRef(Date.now()),ae=n.useRef(),Fe=x&&((b==null?void 0:b.author_id)===x.id||i&&is(i.role)),fe=x&&((b==null?void 0:b.author_id)===x.id||i&&is(i.role)),pe=M.some(f=>f.user_id===(x==null?void 0:x.id)&&f.status==="accepted");n.useEffect(()=>{(async()=>{if(c)try{k(!0);const{data:P,error:B}=await _.from("forum_posts").select(`
            *,
            author:profiles(id, full_name, email, avatar_url, minecraft_username),
            category:forum_categories(id, name, slug, nation_name, town_name)
          `).eq("id",c).single();if(B)throw B;Ie(P)}catch(P){console.error("Error fetching post:",P),U({title:"Error",description:"Failed to load post. Please try again.",variant:"destructive"})}finally{k(!1)}})()},[c,U]),n.useEffect(()=>(b&&(Yt(c),ve(),He(),Ge(),Be()),()=>{ae.current&&clearInterval(ae.current),Le()}),[c,b]);const ve=async()=>{if(c)try{const[f,P,B]=await Promise.all([oe.getPostVersions(c),oe.getPostCollaborations(c),oe.getPostAnalytics(c)]);O(f),J(P),o(B),Ye()}catch(f){console.error("Error loading post data:",f)}},Ye=async()=>{if(!(!c||!x))try{R({likes:0,dislikes:0,shares:0,bookmarks:0,comments:u.length}),A({liked:!1,disliked:!1,bookmarked:!1})}catch(f){console.error("Error loading engagement data:",f),R({likes:0,dislikes:0,shares:0,bookmarks:0,comments:u.length}),A({liked:!1,disliked:!1,bookmarked:!1})}},He=async()=>{if(!(!c||!x))try{await oe.trackPostView(c,x.id)}catch(f){console.error("Error tracking post view:",f)}},Ge=()=>{te.current=Date.now()},Be=()=>{ae.current=setInterval(()=>{if(V.current){const f=V.current,P=f.scrollTop,B=f.scrollHeight,F=f.clientHeight,se=Math.round(P/(B-F)*100);Ue(Math.max(xe,se))}},1e3)},Le=async()=>{if(!c||!x)return;const f=Math.floor((Date.now()-te.current)/1e3);Me(f);try{await oe.updatePostAnalytics(c,{time_spent_reading:f,scroll_depth:xe})}catch(P){console.error("Error saving time spent:",P)}},$e=async f=>{if(!(!x||!c))try{const P={...L};f==="like"?(P.liked=!P.liked,P.liked&&P.disliked&&(P.disliked=!1,R(F=>({...F,dislikes:Math.max(0,F.dislikes-1)}))),R(F=>({...F,likes:P.liked?F.likes+1:Math.max(0,F.likes-1)}))):f==="dislike"&&(P.disliked=!P.disliked,P.disliked&&P.liked&&(P.liked=!1,R(F=>({...F,likes:Math.max(0,F.likes-1)}))),R(F=>({...F,dislikes:P.disliked?F.dislikes+1:Math.max(0,F.dislikes-1)}))),A(P);const B=P[f==="like"?"liked":"disliked"]?"added":"removed";U({title:`${f.charAt(0).toUpperCase()+f.slice(1)} ${B}`,description:`You ${B} your ${f} for this post.`})}catch(P){console.error("Error updating engagement:",P),U({title:"Error",description:"Failed to update engagement. Please try again.",variant:"destructive"})}},Se=async()=>{if(!(!b||!fe)&&confirm("Are you sure you want to delete this post? This action cannot be undone."))try{await l(b.id),U({title:"Post deleted",description:"The post has been successfully deleted."}),t()}catch(f){console.error("Error deleting post:",f),U({title:"Error",description:"Failed to delete post. Please try again.",variant:"destructive"})}},Ce=async(f,P,B,F)=>{if(b)try{await a(b.id,{title:f,content:P,tags:B,post_type:F}),S(!1),U({title:"Post updated",description:"Your post has been successfully updated."})}catch(se){console.error("Error updating post:",se),U({title:"Error",description:"Failed to update post. Please try again.",variant:"destructive"})}},m=async()=>{if(!(!x||!r.trim()))try{await d({content:r.trim(),author_id:x.id,post_id:c}),p(""),U({title:"Reply posted",description:"Your reply has been posted successfully."})}catch(f){console.error("Error creating reply:",f),U({title:"Error",description:"Failed to post reply. Please try again.",variant:"destructive"})}};if(ne||j)return e.jsx("div",{className:"text-center py-8",children:"Loading post..."});if(!b)return e.jsx("div",{className:"text-center py-8",children:"Post not found"});const Q=b.category;return Q&&(Q.nation_name||Q.town_name)&&!(w||y||!!x&&h(Q.nation_name||null,Q.town_name||null))?e.jsxs("div",{className:"space-y-4",children:[e.jsxs(g,{variant:"ghost",onClick:t,children:[e.jsx(_e,{className:"w-4 h-4 mr-2"}),"Back"]}),e.jsx(W,{children:e.jsx(X,{className:"py-8 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"This post belongs to a private forum. You don't have permission to view it."})})})]}):v?e.jsx(aa,{onSubmit:Ce,onCancel:()=>S(!1),initialTitle:b.title,initialContent:b.content,initialTags:b.tags||[],initialPostType:b.post_type||"discussion",isEditing:!0,postId:b.id,onBack:()=>S(!1)}):e.jsxs("div",{className:"space-y-6",ref:V,children:[e.jsxs("div",{className:"flex items-center space-x-2 text-sm text-muted-foreground",children:[e.jsxs(g,{variant:"ghost",size:"sm",onClick:t,className:"p-0 h-auto",children:[e.jsx(_e,{className:"h-4 w-4 mr-1"}),"Back"]}),e.jsx("span",{className:"text-muted-foreground",children:"‚Ä¢"}),e.jsx("span",{className:"font-medium text-foreground",children:b.title})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-6",children:[e.jsx("div",{className:"lg:col-span-3",children:e.jsxs(W,{children:[e.jsx(le,{children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx("h1",{className:"text-2xl font-bold text-foreground",children:b.title}),b.is_pinned&&e.jsx(qs,{className:"w-4 h-4 text-amber-500"}),b.is_locked&&e.jsx(Ms,{className:"w-4 h-4 text-red-500"}),b.is_featured&&e.jsx(Ds,{className:"w-4 h-4 text-yellow-500"})]}),e.jsxs("div",{className:"flex items-center space-x-4 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(Te,{className:"w-6 h-6",children:[e.jsx(Ae,{src:((Re=b.author)==null?void 0:Re.avatar_url)||""}),e.jsx(De,{children:(ds=((ze=b.author)==null?void 0:ze.minecraft_username)||((cs=b.author)==null?void 0:cs.full_name))==null?void 0:ds[0]})]}),e.jsx("span",{className:"text-foreground",children:((ms=b.author)==null?void 0:ms.minecraft_username)||((us=b.author)==null?void 0:us.full_name)}),H&&H.length>0&&e.jsx("div",{className:"flex items-center space-x-1",children:H==null?void 0:H.slice(0,3).map(f=>e.jsx(E,{variant:"secondary",className:"text-xs",children:f.badge_type},f.id))})]}),e.jsx("span",{children:"‚Ä¢"}),e.jsx("span",{children:be(new Date(b.created_at),{addSuffix:!0})}),b.updated_at!==b.created_at&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"‚Ä¢"}),e.jsxs("span",{children:["edited ",be(new Date(b.updated_at),{addSuffix:!0})]})]})]})]}),e.jsxs(Cs,{children:[e.jsx(Ps,{asChild:!0,children:e.jsx(g,{variant:"ghost",size:"sm",children:e.jsx(Dt,{className:"w-4 h-4"})})}),e.jsxs(Ts,{align:"end",children:[(Fe||pe)&&e.jsxs(ie,{onClick:()=>S(!0),children:[e.jsx(qt,{className:"w-4 h-4 mr-2"}),"Edit Post"]}),e.jsxs(ie,{onClick:()=>D(!0),children:[e.jsx(We,{className:"w-4 h-4 mr-2"}),"Version History"]}),e.jsxs(ie,{onClick:()=>C(!0),children:[e.jsx(qe,{className:"w-4 h-4 mr-2"}),"Collaborators"]}),e.jsxs(ie,{onClick:()=>Y(!0),children:[e.jsx(Rs,{className:"w-4 h-4 mr-2"}),"Analytics"]}),fe&&e.jsxs(ie,{onClick:Se,className:"text-red-600",children:[e.jsx(ht,{className:"w-4 h-4 mr-2"}),"Delete Post"]})]})]})]})}),e.jsxs(X,{className:"space-y-6",children:[e.jsx("div",{className:"prose max-w-none dark:prose-invert",children:e.jsx("div",{dangerouslySetInnerHTML:{__html:ys(b.content)}})}),b.tags&&b.tags.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1",children:b.tags.map(f=>e.jsxs(E,{variant:"outline",className:"text-xs",children:["#",f]},f))}),e.jsx("div",{className:"flex items-center justify-between pt-4 border-t",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(g,{variant:L.liked?"default":"outline",size:"sm",onClick:()=>$e("like"),children:[e.jsx(Ot,{className:"w-4 h-4 mr-1"}),"Like"]}),e.jsxs(g,{variant:L.disliked?"default":"outline",size:"sm",onClick:()=>$e("dislike"),children:[e.jsx(zt,{className:"w-4 h-4 mr-1"}),"Dislike"]})]})}),x&&e.jsxs("div",{className:"space-y-2 border-t pt-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Add a Reply"}),e.jsx("textarea",{value:r,onChange:f=>p(f.target.value),placeholder:"Write your reply...",className:"w-full p-3 border rounded-md resize-none",rows:3}),e.jsx("div",{className:"flex justify-end",children:e.jsx(g,{onClick:m,disabled:!r.trim(),children:"Post Reply"})})]}),e.jsxs("div",{className:"space-y-4 border-t pt-4",children:[e.jsxs("h3",{className:"text-lg font-semibold",children:["Replies (",u.length,")"]}),u.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No replies yet. Be the first to reply!"}):e.jsx("div",{className:"space-y-4",children:u.map(f=>{var P,B,F,se,hs,xs;return e.jsxs("div",{className:"p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsxs(Te,{className:"w-6 h-6",children:[e.jsx(Ae,{src:(P=f.author)==null?void 0:P.avatar_url}),e.jsx(De,{children:(se=((B=f.author)==null?void 0:B.minecraft_username)||((F=f.author)==null?void 0:F.full_name))==null?void 0:se[0]})]}),e.jsx("span",{className:"font-medium",children:((hs=f.author)==null?void 0:hs.minecraft_username)||((xs=f.author)==null?void 0:xs.full_name)}),e.jsx("span",{className:"text-sm text-muted-foreground",children:be(new Date(f.created_at),{addSuffix:!0})})]}),e.jsx("div",{className:"prose max-w-none",children:e.jsx("div",{dangerouslySetInnerHTML:{__html:ys(f.content)}})})]},f.id)})})]})]})]})}),e.jsx("div",{className:"lg:col-span-1",children:e.jsxs("div",{className:"space-y-6",children:[M.length>0&&e.jsxs(W,{children:[e.jsx(le,{children:e.jsxs(ye,{className:"flex items-center space-x-2",children:[e.jsx(qe,{className:"w-5 h-5"}),e.jsx("span",{children:"Collaborators"})]})}),e.jsx(X,{children:e.jsx("div",{className:"space-y-2",children:M.slice(0,5).map(f=>{var P,B,F,se;return e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(Te,{className:"w-6 h-6",children:[e.jsx(Ae,{src:(P=f.user)==null?void 0:P.avatar_url}),e.jsx(De,{children:(F=(B=f.user)==null?void 0:B.username)==null?void 0:F[0]})]}),e.jsx("span",{className:"text-sm",children:(se=f.user)==null?void 0:se.username}),e.jsx(E,{variant:"outline",className:"text-xs",children:f.role})]},f.id)})})})]}),e.jsx(ra,{postId:c,postTitle:b.title})]})})]}),e.jsx(ce,{open:T,onOpenChange:D,children:e.jsxs(de,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsx(me,{children:e.jsxs(ue,{className:"flex items-center space-x-2",children:[e.jsx(We,{className:"w-5 h-5"}),e.jsx("span",{children:"Version History"})]})}),e.jsx("div",{className:"space-y-4",children:z.map(f=>e.jsxs(W,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(E,{variant:"outline",children:["v",f.version_number]}),e.jsx("span",{className:"text-sm text-muted-foreground",children:be(new Date(f.created_at),{addSuffix:!0})})]}),e.jsx(g,{variant:"outline",size:"sm",onClick:()=>{D(!1)},children:"Restore"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium",children:f.title}),f.change_summary&&e.jsx("p",{className:"text-sm text-muted-foreground",children:f.change_summary}),e.jsx("div",{className:"flex flex-wrap gap-1",children:f.tags.map(P=>e.jsxs(E,{variant:"secondary",className:"text-xs",children:["#",P]},P))})]})]},f.id))})]})}),e.jsx(ce,{open:q,onOpenChange:C,children:e.jsxs(de,{className:"max-w-2xl",children:[e.jsx(me,{children:e.jsxs(ue,{className:"flex items-center space-x-2",children:[e.jsx(qe,{className:"w-5 h-5"}),e.jsx("span",{children:"Collaboration Management"})]})}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"Current Collaborators"}),e.jsxs("div",{className:"space-y-2",children:[M.map(f=>{var P,B,F,se;return e.jsx("div",{className:"flex items-center justify-between p-2 border rounded",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(Te,{className:"w-6 h-6",children:[e.jsx(Ae,{src:(P=f.user)==null?void 0:P.avatar_url}),e.jsx(De,{children:(F=(B=f.user)==null?void 0:B.username)==null?void 0:F[0]})]}),e.jsx("span",{className:"text-sm",children:(se=f.user)==null?void 0:se.username}),e.jsx(E,{variant:"outline",className:"text-xs",children:f.role}),f.status==="pending"&&e.jsx(E,{variant:"secondary",className:"text-xs",children:"Pending"})]})},f.id)}),M.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"No collaborators yet"})]})]})})]})})]})},Pa=()=>{const{categoryId:c,postId:t}=xt(),s=ft(),[a,l]=n.useState("categories"),[u,d]=n.useState(null),[r,p]=n.useState(null),[x,i]=n.useState(!1),[h,w]=n.useState(!1);n.useState(""),n.useState({postType:"",author:"",dateRange:"",tags:[]}),n.useState("created_at");const[y,j]=n.useState("desc"),{user:v}=he(),{toast:S}=ke();n.useEffect(()=>{if(t)p(t),l("post");else if(c&&typeof c=="string"){let M=decodeURIComponent(c);if(M==="[object Object]"){console.log("‚ö†Ô∏è URL contains [object Object], this should not happen"),l("categories");return}if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(M)){console.log("‚ö†Ô∏è Invalid UUID format:",M),l("categories");return}d(M),l("posts")}else l("categories")},[c,t]);const T=M=>{d(M),l("posts"),s(`/forum/category/${M}`)},D=M=>{p(M),l("post"),s(`/forum/post/${M}`)},q=()=>{if(!v){S({title:"Authentication required",description:"Please sign in to create a post.",variant:"destructive"});return}l("create")},C=()=>{l("categories"),d(null),s("/forum")},N=()=>{l("posts"),p(null),s(u?`/forum/category/${u}`:"/forum")},Y=async(M,J,ee,o)=>{if(!u){S({title:"Error",description:"No category selected.",variant:"destructive"});return}try{S({title:"Post created",description:"Your post has been created successfully."}),l("posts")}catch(I){console.error("Error creating post:",I),S({title:"Error",description:"Failed to create post. Please try again.",variant:"destructive"})}},z=()=>{l(r?"post":u?"posts":"categories")},O=()=>{j(y==="asc"?"desc":"asc")};return e.jsxs("div",{className:"container mx-auto px-4 py-6 max-w-7xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[a!=="categories"&&e.jsxs(g,{variant:"outline",onClick:a==="posts"?C:N,className:"flex items-center space-x-2",children:[e.jsx(_e,{className:"w-4 h-4"}),e.jsx("span",{children:"Back"})]}),e.jsx("h1",{className:"text-3xl font-bold",children:"Forum"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(g,{variant:"outline",size:"sm",onClick:()=>i(!x),children:[e.jsx(pt,{className:"w-4 h-4 mr-2"}),"Search"]}),e.jsxs(g,{variant:"outline",size:"sm",onClick:()=>w(!h),children:[e.jsx(Mt,{className:"w-4 h-4 mr-2"}),"Filters"]}),e.jsxs(g,{variant:"outline",size:"sm",onClick:O,children:[y==="asc"?e.jsx(gt,{className:"w-4 h-4 mr-2"}):e.jsx(jt,{className:"w-4 h-4 mr-2"}),"Sort"]})]})]}),x&&e.jsx("div",{className:"mb-4",children:e.jsx("p",{children:"Search functionality is currently unavailable."})}),h&&e.jsx("div",{className:"mb-4",children:e.jsx("p",{children:"Filter functionality is currently unavailable."})}),a==="categories"&&e.jsx(Qt,{onCategorySelect:T,onCreatePost:q}),a==="posts"&&u&&e.jsx(Gt,{categoryId:u,onPostSelect:D,onBack:C}),a==="post"&&r&&e.jsx(na,{postId:r,onBack:N}),a==="create"&&u&&e.jsx($s,{onSubmit:Y,onCancel:z,categoryId:u,onBack:N})]})};export{Pa as default};
