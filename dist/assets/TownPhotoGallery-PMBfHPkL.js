import{I as ne,r as d,j as e,w as Y,x as Z,Q as he,y as ee,B as L,v as w,bn as ue,bo as ge,z as se,H as te,s as _,ay as pe,o as oe,p as le,q as ie,t as ce,bc as de,O as A,Y as G,b5 as K,X as Q,b1 as me,b8 as fe,br as xe,aH as re,bt as we,W as je,aM as ve,aJ as ye}from"./index-DUDTAd9W.js";import{E as ae}from"./external-link-BIoP0QEd.js";import{L as q}from"./loader-circle-DMK_EDKw.js";import{I as Ne}from"./imageStorageService-DFMDSFOA.js";import{U as J}from"./upload-tHEKoL-4.js";import{I as be}from"./image-CKfeGsQ7.js";import{P as Pe}from"./pen-line-MjRWahhH.js";import{D as Ee}from"./download-Dh3YjV-9.js";import{S as Ce}from"./save-uvmCJEKY.js";import{L as ke}from"./list-CaF9zg65.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const X=ne("Camera",[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=ne("Tag",[["path",{d:"M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z",key:"vktsd0"}],["circle",{cx:"7.5",cy:"7.5",r:".5",fill:"currentColor",key:"kqv944"}]]),Ge=({townName:n,coordinates:s={x:1708,z:7549},className:o=""})=>{const[a,c]=d.useState(!1),[h,p]=d.useState(!0),[v,b]=d.useState(!1),E=`https://map.nordics.world/#world:${s.x}:0:${s.z}:1000:0:0:0:0:perspective`,f=()=>{p(!1)},S=()=>{p(!1),b(!0)},y=()=>{window.open(E,"_blank")};return e.jsxs(Y,{className:`overflow-hidden ${o}`,children:[e.jsx(Z,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(he,{className:"w-5 h-5 text-primary"}),e.jsx(ee,{className:"text-lg",children:"Live Map View"}),e.jsxs(L,{variant:"outline",className:"text-xs",children:[s.x,", ",s.z]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(w,{variant:"outline",size:"sm",onClick:y,className:"text-xs",children:[e.jsx(ae,{className:"w-3 h-3 mr-1"}),"Open Full Map"]}),e.jsx(w,{variant:"outline",size:"sm",onClick:()=>c(!a),className:"text-xs",children:a?e.jsx(ue,{className:"w-3 h-3"}):e.jsx(ge,{className:"w-3 h-3"})})]})]})}),e.jsx(se,{className:"p-0",children:e.jsxs("div",{className:"relative",children:[h&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-muted/50 z-10",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{className:"text-sm",children:"Loading map..."})]})}),v&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-muted/50 z-10",children:e.jsxs("div",{className:"text-center p-4",children:[e.jsx(te,{className:"w-8 h-8 mx-auto mb-2 text-muted-foreground"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"Unable to load map view"}),e.jsxs(w,{variant:"outline",size:"sm",onClick:y,children:[e.jsx(ae,{className:"w-3 h-3 mr-1"}),"Open in New Tab"]})]})}),e.jsx("div",{className:`relative bg-muted/20 transition-all duration-300 ${a?"h-[600px]":"h-64"}`,children:e.jsx("iframe",{src:E,title:`${n} on Nordics World Map`,className:"w-full h-full border-0",onLoad:f,onError:S,sandbox:"allow-scripts allow-same-origin allow-forms",loading:"lazy"})}),e.jsx("div",{className:"absolute bottom-2 left-2 bg-background/90 backdrop-blur-sm rounded-lg px-3 py-2 border text-xs",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(te,{className:"w-3 h-3 text-primary"}),e.jsx("span",{className:"font-medium",children:n}),e.jsxs("span",{className:"text-muted-foreground",children:["(",s.x,", ",s.z,")"]})]})})]})})]})};class O{static convertToSupabaseUrl(s){if(s.includes("storage.nordics.world")){const o=s.match(/\/nation-town-images\/(.+)$/);if(o){const a=o[1],{data:c}=_.storage.from("nation-town-images").getPublicUrl(a);return c.publicUrl}}return s}static async getTownPhotos(s){try{console.log("Getting photos for town:",s);const{data:o,error:a}=await _.from("town_gallery").select("*").eq("town_name",s).eq("is_approved",!0).order("uploaded_at",{ascending:!1});if(a)return console.error("Error fetching town photos:",a),[];const c=(o==null?void 0:o.map(h=>({...h,file_url:this.convertToSupabaseUrl(h.file_url)})))||[];return console.log(`Found ${c.length} photos for ${s}`),c}catch(o){return console.error("Error in getTownPhotos:",o),[]}}static async getPhotoById(s){try{const{data:o,error:a}=await _.from("town_gallery").select("*").eq("id",s).single();return a?(console.error("Error fetching photo:",a),null):o}catch(o){return console.error("Error in getPhotoById:",o),null}}static async checkGalleryPermissions(s,o){try{const{data:a,error:c}=await _.from("profiles").select("role, minecraft_username").eq("id",o).single();if(c||!a)return{canUpload:!1,canDelete:!1,canApprove:!1,reason:"User profile not found"};if(a.role==="admin"||a.role==="moderator")return{canUpload:!0,canDelete:!0,canApprove:!0};const{data:h,error:p}=await _.from("towns").select("mayor_name, residents").eq("name",s).single();if(p||!h)return{canUpload:!1,canDelete:!1,canApprove:!1,reason:"Town not found"};const v=h.mayor_name===a.minecraft_username,b=h.residents&&Array.isArray(h.residents)&&h.residents.some(E=>E.name===a.minecraft_username&&E.is_co_mayor===!0);return v||b?{canUpload:!0,canDelete:!0,canApprove:!0}:{canUpload:!1,canDelete:!1,canApprove:!1,reason:"Only town mayors and co-mayors can manage gallery photos"}}catch(a){return console.error("Error checking gallery permissions:",a),{canUpload:!1,canDelete:!1,canApprove:!1,reason:"Error checking permissions"}}}static async uploadPhoto(s,o){try{console.log("Starting photo upload for town:",s.town_name);const a=await this.checkGalleryPermissions(s.town_name,o);if(!a.canUpload)throw new Error(a.reason||"Not authorized to upload photos");if((await this.getTownPhotos(s.town_name)).length>=10)throw new Error("This town has reached the maximum limit of 10 photos. Please delete some existing photos before uploading new ones.");const{data:h,error:p}=await _.from("profiles").select("minecraft_username").eq("id",o).single();if(p||!h)throw new Error("User profile not found");const v=Date.now(),b=s.file.name.split(".").pop()||"jpg",E=`${v}.${b}`,f=`towns/${s.town_name.toLowerCase()}/gallery/${E}`;console.log("Uploading file to storage:",f);const{data:S,error:y}=await _.storage.from("nation-town-images").upload(f,s.file,{contentType:s.file.type,upsert:!1});if(y)throw console.error("Storage upload error:",y),new Error(`Failed to upload file: ${y.message}`);const C=Ne.generateCustomUrl(f),x=await this.getImageDimensions(s.file),N={town_name:s.town_name,title:s.title,description:s.description||null,file_path:f,file_url:C,file_size:s.file.size,file_type:s.file.type,width:x.width,height:x.height,tags:s.tags||[],uploaded_by:o,uploaded_by_username:h.minecraft_username||"Unknown",is_approved:!0,view_count:0},{data:j,error:P}=await _.from("town_gallery").insert(N).select().single();if(P)throw console.error("Database insert error:",P),await _.storage.from("nation-town-images").remove([f]),new Error(`Failed to save photo data: ${P.message}`);return console.log("Photo uploaded successfully:",j),j}catch(a){throw console.error("Error in uploadPhoto:",a),a}}static async deletePhoto(s,o){try{const a=await this.getPhotoById(s);if(!a)throw new Error("Photo not found");const c=await this.checkGalleryPermissions(a.town_name,o);if(!c.canDelete)throw new Error(c.reason||"Not authorized to delete photos");const{error:h}=await _.storage.from("nation-town-images").remove([a.file_path]);h&&console.error("Storage delete error:",h);const{error:p}=await _.from("town_gallery").delete().eq("id",s);if(p)throw console.error("Database delete error:",p),new Error(`Failed to delete photo: ${p.message}`);return console.log("Photo deleted successfully"),!0}catch(a){throw console.error("Error in deletePhoto:",a),a}}static async updatePhoto(s,o,a){try{const c=await this.getPhotoById(s);if(!c)throw new Error("Photo not found");const h=await this.checkGalleryPermissions(c.town_name,a);if(!h.canUpload)throw new Error(h.reason||"Not authorized to update photos");const{data:p,error:v}=await _.from("town_gallery").update({...o,updated_at:new Date().toISOString()}).eq("id",s).select().single();if(v)throw console.error("Database update error:",v),new Error(`Failed to update photo: ${v.message}`);return console.log("Photo updated successfully:",p),p}catch(c){throw console.error("Error in updatePhoto:",c),c}}static async incrementViewCount(s){try{const{data:o,error:a}=await _.from("town_gallery").select("view_count").eq("id",s).single();if(a||!o){console.error("Error fetching photo for view count:",a);return}const c=(o.view_count||0)+1,{error:h}=await _.from("town_gallery").update({view_count:c,updated_at:new Date().toISOString()}).eq("id",s);h&&console.error("Error incrementing view count:",h)}catch(o){console.error("Error in incrementViewCount:",o)}}static async searchPhotos(s,o){try{const a=await this.getTownPhotos(s),c=o.toLowerCase();return a.filter(h=>h.title.toLowerCase().includes(c)||h.description&&h.description.toLowerCase().includes(c)||h.tags.some(p=>p.toLowerCase().includes(c)))}catch(a){return console.error("Error in searchPhotos:",a),[]}}static async getUserPhotos(s){try{const o=[],{data:a,error:c}=await _.from("town_gallery").select("*").eq("uploaded_by",s).eq("is_approved",!0).order("uploaded_at",{ascending:!1});return c?(console.error("Error fetching user photos:",c),[]):a||[]}catch(o){return console.error("Error in getUserPhotos:",o),[]}}static async getImageDimensions(s){return new Promise(o=>{const a=new Image;a.onload=()=>{o({width:a.width,height:a.height})},a.onerror=()=>{o({width:0,height:0})},a.src=URL.createObjectURL(s)})}static async testService(){try{console.log("Testing town gallery service...");const{data:s,error:o}=await _.from("profiles").select("minecraft_username").limit(1).single();return console.log("Profile check:",{profile:s,error:o}),{success:!0,message:"Service is working",profile:(s==null?void 0:s.minecraft_username)||"No profile found"}}catch(s){return console.error("Service test failed:",s),{success:!1,error:s}}}static clearAllData(){console.log("All gallery data cleared")}}const Ue=n=>{const{user:s,profile:o}=pe(),[a,c]=d.useState([]),[h,p]=d.useState(!0),[v,b]=d.useState(!1),[E,f]=d.useState(null),[S,y]=d.useState({canUpload:!1,canDelete:!1,canApprove:!1}),C=d.useCallback(async()=>{if(n)try{p(!0),f(null);const u=await O.getTownPhotos(n);c(u)}catch(u){console.error("Error loading town photos:",u),f(u instanceof Error?u.message:"Failed to load photos")}finally{p(!1)}},[n]),x=d.useCallback(async()=>{if(!(s!=null&&s.id)||!n){y({canUpload:!1,canDelete:!1,canApprove:!1,reason:"Not authenticated"});return}try{const u=await O.checkGalleryPermissions(n,s.id);y(u)}catch(u){console.error("Error checking permissions:",u),y({canUpload:!1,canDelete:!1,canApprove:!1,reason:"Error checking permissions"})}},[s==null?void 0:s.id,n]),N=d.useCallback(async u=>{if(!(s!=null&&s.id))throw new Error("Not authenticated");try{b(!0),f(null);const l=await O.uploadPhoto(u,s.id);return c(g=>[l,...g]),l}catch(l){throw console.error("Error uploading photo:",l),f(l instanceof Error?l.message:"Failed to upload photo"),l}finally{b(!1)}},[s==null?void 0:s.id]),j=d.useCallback(async u=>{if(!(s!=null&&s.id))throw new Error("Not authenticated");try{f(null),await O.deletePhoto(u,s.id),c(l=>l.filter(g=>g.id!==u))}catch(l){throw console.error("Error deleting photo:",l),f(l instanceof Error?l.message:"Failed to delete photo"),l}},[s==null?void 0:s.id]),P=d.useCallback(async(u,l)=>{if(!(s!=null&&s.id))throw new Error("Not authenticated");try{f(null);const g=await O.updatePhoto(u,l,s.id);return c(U=>U.map(D=>D.id===u?g:D)),g}catch(g){throw console.error("Error updating photo:",g),f(g instanceof Error?g.message:"Failed to update photo"),g}},[s==null?void 0:s.id]),z=d.useCallback(async u=>{if(!n)return[];try{return f(null),await O.searchPhotos(n,u)}catch(l){return console.error("Error searching photos:",l),f(l instanceof Error?l.message:"Failed to search photos"),[]}},[n]),k=d.useCallback(async u=>{try{await O.incrementViewCount(u),c(l=>l.map(g=>g.id===u?{...g,view_count:g.view_count+1}:g))}catch(l){console.error("Error incrementing view count:",l)}},[]);return d.useEffect(()=>{C(),x()},[C,x]),{photos:a,loading:h,uploading:v,error:E,permissions:S,uploadPhoto:N,deletePhoto:j,updatePhoto:P,searchPhotos:z,incrementViewCount:k,refresh:C}},Se=({open:n,onOpenChange:s,townName:o,onUpload:a,uploading:c,currentPhotoCount:h=0})=>{const[p,v]=d.useState(""),[b,E]=d.useState(""),[f,S]=d.useState([]),[y,C]=d.useState(""),[x,N]=d.useState(null),[j,P]=d.useState(null),[z,k]=d.useState(!1),[u,l]=d.useState({}),g=d.useRef(null);d.useEffect(()=>()=>{j&&URL.revokeObjectURL(j)},[j]);const U=t=>{t||D(),s(t)},D=()=>{v(""),E(""),S([]),C(""),N(null),j&&URL.revokeObjectURL(j),P(null),l({})},T=d.useCallback(t=>{try{if(console.log("File selected:",t.name,t.type,t.size),!t.type.startsWith("image/")){l({file:"Please select an image file"});return}if(t.size>5*1024*1024){l({file:"File size must be less than 5MB"});return}if(t.size>10*1024*1024){l({file:"File is too large and may cause browser issues. Please use a smaller image."});return}if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(t.type.toLowerCase())){l({file:"Please select a JPEG, PNG, GIF, or WebP image"});return}if(t.size===0){l({file:"File appears to be empty or corrupted. Please select a different file."});return}j&&(URL.revokeObjectURL(j),P(null)),N(t),l({});try{const m=URL.createObjectURL(t);console.log("Preview URL created:",m);const F=setTimeout(()=>{console.warn("Image preview creation timed out"),l({file:"Image preview took too long to load. Please try a smaller or different image."}),N(null),URL.revokeObjectURL(m)},5e3),$=new Image;$.onload=()=>{clearTimeout(F),console.log("Image preview loaded successfully"),P(m)},$.onerror=()=>{clearTimeout(F),console.error("Image preview failed to load"),l({file:"Unable to preview this image. Please try a different file."}),N(null),URL.revokeObjectURL(m)},$.src=m}catch(m){console.error("Error creating preview URL:",m),l({file:"Unable to preview this image. Please try a different file."}),N(null)}}catch(r){console.error("Error handling file selection:",r),l({file:"Error processing file. Please try again."}),N(null)}},[j]),I=d.useCallback(t=>{t.preventDefault(),t.stopPropagation(),t.type==="dragenter"||t.type==="dragover"?k(!0):t.type==="dragleave"&&k(!1)},[]),B=d.useCallback(t=>{t.preventDefault(),t.stopPropagation(),k(!1),t.dataTransfer.files&&t.dataTransfer.files[0]&&T(t.dataTransfer.files[0])},[T]),M=()=>{y.trim()&&!f.includes(y.trim().toLowerCase())&&(S(t=>[...t,y.trim().toLowerCase()]),C(""))},V=t=>{S(r=>r.filter(m=>m!==t))},R=t=>{t.key==="Enter"&&(t.preventDefault(),M())},H=()=>{const t={};return p.trim()||(t.title="Title is required"),x||(t.file="Please select an image file"),l(t),Object.keys(t).length===0},i=async t=>{if(t.preventDefault(),!(!H()||!x))try{const r={town_name:o,title:p.trim(),description:b.trim()||void 0,tags:f.length>0?f:void 0,file:x};await a(r),U(!1)}catch(r){console.error("Upload failed:",r),l({submit:r instanceof Error?r.message:"Upload failed"})}};return e.jsx(oe,{open:n,onOpenChange:U,children:e.jsxs(le,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(ie,{children:[e.jsxs(ce,{className:"flex items-center gap-2",children:[e.jsx(J,{className:"w-5 h-5"}),"Upload Photo to ",o]}),e.jsxs(de,{children:["Share a photo of ",o," with the community. Only mayors, co-mayors, and admins can upload photos.",h>0&&e.jsxs("div",{className:"mt-2 text-sm text-muted-foreground",children:["Current photos: ",h,"/10"]})]})]}),e.jsxs("form",{onSubmit:i,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{htmlFor:"photo",children:"Photo File *"}),e.jsxs("div",{className:`border-2 border-dashed rounded-lg p-6 text-center transition-colors ${z?"border-primary bg-primary/5":"border-muted-foreground/25 hover:border-muted-foreground/50"}`,onDragEnter:I,onDragLeave:I,onDragOver:I,onDrop:B,children:[j?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative inline-block",children:[e.jsx("img",{src:j,alt:"Preview",className:"max-h-48 max-w-full rounded-lg object-contain",onError:t=>{console.error("Image preview error:",t),l({file:"Unable to display image preview. Please try a different file."}),N(null),P(null)},onLoad:()=>{console.log("Image preview loaded successfully")}}),e.jsx(w,{type:"button",size:"icon",variant:"destructive",className:"absolute -top-2 -right-2 w-6 h-6",onClick:()=>{N(null),P(null),j&&URL.revokeObjectURL(j)},children:e.jsx(G,{className:"w-3 h-3"})})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[x==null?void 0:x.name," (",((x==null?void 0:x.size)/1024/1024).toFixed(2)," MB)"]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx(J,{className:"w-12 h-12 mx-auto text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium mb-2",children:"Click to upload or drag and drop"}),e.jsx("p",{className:"text-xs text-muted-foreground mb-4",children:"PNG, JPG, GIF up to 5MB"}),e.jsx(w,{type:"button",variant:"outline",onClick:()=>{try{g.current?g.current.click():(console.error("File input ref is null"),l({file:"File input not available. Please refresh the page and try again."}))}catch(t){console.error("Error clicking file input:",t),l({file:"Unable to open file selector. Please try again."})}},children:"Choose File"})]})]}),e.jsx("input",{ref:g,type:"file",accept:"image/jpeg,image/jpg,image/png,image/gif,image/webp",className:"hidden",onChange:t=>{var r;try{const m=(r=t.target.files)==null?void 0:r[0];m&&(console.log("File input change:",m.name,m.size,m.type),T(m)),t.target&&(t.target.value="")}catch(m){console.error("Error in file input change:",m),l({file:"Error reading file. Please try again."}),t.target&&(t.target.value="")}},onClick:t=>{u.file&&l(r=>{const m={...r};return delete m.file,m})}})]}),u.file&&e.jsxs("p",{className:"text-sm text-destructive flex items-center gap-1",children:[e.jsx(K,{className:"w-3 h-3"}),u.file]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{htmlFor:"title",children:"Photo Title *"}),e.jsx(Q,{id:"title",value:p,onChange:t=>v(t.target.value),placeholder:"Enter a descriptive title for your photo",maxLength:100}),u.title&&e.jsxs("p",{className:"text-sm text-destructive flex items-center gap-1",children:[e.jsx(K,{className:"w-3 h-3"}),u.title]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{htmlFor:"description",children:"Description"}),e.jsx(me,{id:"description",value:b,onChange:t=>E(t.target.value),placeholder:"Describe what's shown in the photo (optional)",rows:3,maxLength:500}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[b.length,"/500 characters"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{htmlFor:"tags",children:"Tags"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Q,{id:"tags",value:y,onChange:t=>C(t.target.value),onKeyPress:R,placeholder:"Add tags (press Enter)",maxLength:20}),e.jsx(w,{type:"button",variant:"outline",onClick:M,disabled:!y.trim(),children:"Add"})]}),f.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",children:f.map(t=>e.jsxs(L,{variant:"secondary",className:"flex items-center gap-1",children:[t,e.jsx(w,{type:"button",size:"icon",variant:"ghost",className:"w-3 h-3 p-0 hover:bg-transparent",onClick:()=>V(t),children:e.jsx(G,{className:"w-2 h-2"})})]},t))})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Tags help others find your photo. Examples: building, landmark, event, nature"})]}),u.submit&&e.jsx("div",{className:"p-3 bg-destructive/10 border border-destructive/20 rounded-lg",children:e.jsxs("p",{className:"text-sm text-destructive flex items-center gap-1",children:[e.jsx(K,{className:"w-4 h-4"}),u.submit]})}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(w,{type:"button",variant:"outline",onClick:()=>U(!1),disabled:c,children:"Cancel"}),e.jsx(w,{type:"submit",disabled:c||!x||!p.trim(),className:"min-w-[100px]",children:c?e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"w-4 h-4 mr-2 animate-spin"}),"Uploading..."]}):e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),"Upload Photo"]})})]})]})]})})},De=({photo:n,open:s,onOpenChange:o,onDelete:a,onUpdate:c,canEdit:h=!1,canDelete:p=!1})=>{const[v,b]=d.useState(!1),[E,f]=d.useState(""),[S,y]=d.useState(""),[C,x]=d.useState([]),[N,j]=d.useState(""),[P,z]=d.useState(!1),[k,u]=d.useState(!1),[l,g]=d.useState(null);d.useEffect(()=>{n&&(f(n.title),y(n.description||""),x(n.tags||[]),g(null))},[n]);const U=i=>{i||(b(!1),g(null)),o(i)},D=()=>{N.trim()&&!C.includes(N.trim().toLowerCase())&&(x(i=>[...i,N.trim().toLowerCase()]),j(""))},T=i=>{x(t=>t.filter(r=>r!==i))},I=i=>{i.key==="Enter"&&(i.preventDefault(),D())},B=async()=>{if(!(!n||!c))try{z(!0),g(null);const i={title:E.trim(),description:S.trim()||void 0,tags:C.length>0?C:void 0};await c(n.id,i),b(!1)}catch(i){console.error("Error updating photo:",i),g(i instanceof Error?i.message:"Failed to update photo")}finally{z(!1)}},M=async()=>{if(!(!n||!a)&&confirm("Are you sure you want to delete this photo? This action cannot be undone."))try{u(!0),g(null),await a(n.id),U(!1)}catch(i){console.error("Error deleting photo:",i),g(i instanceof Error?i.message:"Failed to delete photo")}finally{u(!1)}},V=()=>{if(!n)return;const i=document.createElement("a");i.href=n.file_url,i.download=`${n.title.replace(/[^a-z0-9]/gi,"_").toLowerCase()}.jpg`,i.click()};if(!n)return null;const R=i=>new Date(i).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),H=i=>i?`${(i/1024/1024).toFixed(1)} MB`:"Unknown";return e.jsx(oe,{open:s,onOpenChange:U,children:e.jsxs(le,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ie,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(ce,{className:"flex items-center gap-2",children:[e.jsx(be,{className:"w-5 h-5"}),v?"Edit Photo":n.title]}),e.jsx(de,{children:v?"Update photo information":`Uploaded by ${n.uploaded_by_username} on ${R(n.uploaded_at)}`})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[h&&!v&&e.jsxs(w,{size:"sm",variant:"outline",onClick:()=>b(!0),children:[e.jsx(Pe,{className:"w-4 h-4 mr-2"}),"Edit"]}),p&&e.jsxs(w,{size:"sm",variant:"destructive",onClick:M,disabled:k,children:[k?e.jsx(q,{className:"w-4 h-4 mr-2 animate-spin"}):e.jsx(fe,{className:"w-4 h-4 mr-2"}),"Delete"]})]})]})}),e.jsxs("div",{className:"space-y-6",children:[l&&e.jsx("div",{className:"p-3 bg-destructive/10 border border-destructive/20 rounded-lg",children:e.jsxs("p",{className:"text-sm text-destructive flex items-center gap-1",children:[e.jsx(xe,{className:"w-4 h-4"}),l]})}),e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:n.file_url,alt:n.title,className:"w-full h-auto rounded-lg shadow-lg"}),e.jsxs("div",{className:"absolute top-4 right-4 flex items-center gap-2 bg-black/50 text-white px-3 py-1 rounded-full text-sm",children:[e.jsx(re,{className:"w-4 h-4"}),n.view_count," views"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx("div",{className:"space-y-4",children:v?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{htmlFor:"edit-title",children:"Title *"}),e.jsx(Q,{id:"edit-title",value:E,onChange:i=>f(i.target.value),maxLength:100})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{htmlFor:"edit-description",children:"Description"}),e.jsx(me,{id:"edit-description",value:S,onChange:i=>y(i.target.value),rows:3,maxLength:500}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[S.length,"/500 characters"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{children:"Tags"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Q,{value:N,onChange:i=>j(i.target.value),onKeyPress:I,placeholder:"Add tags (press Enter)",maxLength:20}),e.jsx(w,{type:"button",variant:"outline",onClick:D,disabled:!N.trim(),children:"Add"})]}),C.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",children:C.map(i=>e.jsxs(L,{variant:"secondary",className:"flex items-center gap-1",children:[i,e.jsx(w,{type:"button",size:"icon",variant:"ghost",className:"w-3 h-3 p-0 hover:bg-transparent",onClick:()=>T(i),children:e.jsx(G,{className:"w-2 h-2"})})]},i))})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-lg mb-2",children:n.title}),n.description&&e.jsx("p",{className:"text-muted-foreground mb-4",children:n.description})]}),n.tags&&n.tags.length>0&&e.jsxs("div",{children:[e.jsxs(A,{className:"flex items-center gap-2 mb-2",children:[e.jsx(_e,{className:"w-4 h-4"}),"Tags"]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:n.tags.map((i,t)=>e.jsx(L,{variant:"outline",children:i},t))})]})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-muted/50 rounded-lg p-4 space-y-3",children:[e.jsx("h4",{className:"font-semibold",children:"Photo Details"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Uploaded by:"}),e.jsx("span",{className:"font-medium",children:n.uploaded_by_username})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Upload date:"}),e.jsx("span",{className:"font-medium",children:R(n.uploaded_at)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"File size:"}),e.jsx("span",{className:"font-medium",children:H(n.file_size)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Dimensions:"}),e.jsxs("span",{className:"font-medium",children:[n.width," Ã— ",n.height]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Views:"}),e.jsx("span",{className:"font-medium",children:n.view_count})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(w,{variant:"outline",className:"w-full",onClick:()=>window.open(n.file_url,"_blank"),children:[e.jsx(re,{className:"w-4 h-4 mr-2"}),"View Full Size"]}),e.jsxs(w,{variant:"outline",className:"w-full",onClick:V,children:[e.jsx(Ee,{className:"w-4 h-4 mr-2"}),"Download"]})]}),v&&e.jsxs("div",{className:"space-y-2 pt-4 border-t",children:[e.jsx(w,{className:"w-full",onClick:B,disabled:P||!E.trim(),children:P?e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"w-4 h-4 mr-2 animate-spin"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ce,{className:"w-4 h-4 mr-2"}),"Save Changes"]})}),e.jsx(w,{variant:"outline",className:"w-full",onClick:()=>{b(!1),f(n.title),y(n.description||""),x(n.tags||[]),g(null)},disabled:P,children:"Cancel"})]})]})]})]})]})})},qe=({townName:n,className:s=""})=>{const{photos:o,loading:a,uploading:c,error:h,permissions:p,uploadPhoto:v,deletePhoto:b,updatePhoto:E,searchPhotos:f,incrementViewCount:S,refresh:y}=Ue(n),[C,x]=d.useState(null),[N,j]=d.useState(!1),[P,z]=d.useState(!1),[k,u]=d.useState(""),[l,g]=d.useState([]),[U,D]=d.useState("grid"),T=r=>{if(r.includes("storage.nordics.world")){const m=r.match(/\/nation-town-images\/(.+)$/);if(m)return`https://erdconvorgecupvavlwv.supabase.co/storage/v1/object/public/nation-town-images/${m[1]}`}return r},I=(r,m)=>{const F=r.currentTarget,$=m.file_url;console.error("Failed to load image:",$);const W=T($);if(W!==$){console.log("Trying converted URL:",W),F.src=W;return}U==="grid"?F.src="https://via.placeholder.com/400x400/6B7280/FFFFFF?text=Image+Error":F.src="https://via.placeholder.com/96x96/6B7280/FFFFFF?text=Error"},B=async r=>{if(u(r),r.trim()){const m=await f(r);g(m)}else g([])},M=async r=>{x(r),await S(r.id)},V=async r=>{await v(r)},R=async r=>{await b(r)},H=async(r,m)=>{await E(r,m)},i=k.trim()?l:o,t=r=>new Date(r).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"});return a?e.jsxs(Y,{className:s,children:[e.jsx(Z,{children:e.jsxs(ee,{className:"flex items-center gap-2",children:[e.jsx(X,{className:"w-5 h-5"}),"Photo Gallery"]})}),e.jsx(se,{children:e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(q,{className:"w-8 h-8 animate-spin text-muted-foreground"})})})]}):e.jsxs(e.Fragment,{children:[e.jsxs(Y,{className:s,children:[e.jsxs(Z,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(ee,{className:"flex items-center gap-2",children:[e.jsx(X,{className:"w-5 h-5"}),"Photo Gallery",e.jsxs(L,{variant:"secondary",children:[o.length,"/10"]}),o.length>=10&&e.jsx(L,{variant:"destructive",className:"text-xs",children:"Limit Reached"})]}),h&&e.jsxs(L,{variant:"destructive",className:"flex items-center gap-1",children:[e.jsx(K,{className:"w-3 h-3"}),"Error"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(w,{size:"sm",variant:"outline",onClick:()=>z(!P),children:P?e.jsx(we,{className:"w-4 h-4"}):e.jsx(je,{className:"w-4 h-4"})}),e.jsx(w,{size:"sm",variant:"outline",onClick:()=>D(U==="grid"?"list":"grid"),children:U==="grid"?e.jsx(ke,{className:"w-4 h-4"}):e.jsx(ve,{className:"w-4 h-4"})}),p.canUpload&&e.jsxs(w,{size:"sm",onClick:()=>j(!0),disabled:c||o.length>=10,title:o.length>=10?"Maximum 10 photos allowed per town":"Add a new photo",children:[c?e.jsx(q,{className:"w-4 h-4 mr-2 animate-spin"}):e.jsx(ye,{className:"w-4 h-4 mr-2"}),"Add Photo",o.length>=10&&e.jsx("span",{className:"ml-1 text-xs",children:"(Limit Reached)"})]})]})]}),P&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Q,{placeholder:"Search photos by title, description, or tags...",value:k,onChange:r=>B(r.target.value),className:"flex-1"}),k&&e.jsx(w,{size:"sm",variant:"outline",onClick:()=>{u(""),g([])},children:e.jsx(G,{className:"w-4 h-4"})})]})]}),e.jsxs(se,{children:[h&&e.jsx("div",{className:"mb-4 p-3 bg-destructive/10 border border-destructive/20 rounded-lg",children:e.jsxs("p",{className:"text-sm text-destructive flex items-center gap-1",children:[e.jsx(K,{className:"w-4 h-4"}),h]})}),i.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(X,{className:"w-12 h-12 mx-auto mb-3 opacity-30"}),e.jsx("p",{className:"text-lg font-medium mb-2",children:k?"No photos found":"No photos uploaded yet"}),e.jsx("p",{className:"text-sm",children:k?`No photos match "${k}"`:p.canUpload?"Be the first to share a photo of this town!":"Check back later for town photos."}),k&&e.jsx(w,{variant:"outline",size:"sm",className:"mt-4",onClick:()=>{u(""),g([])},children:"Clear Search"})]}):e.jsx("div",{className:U==="grid"?"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4":"space-y-4",children:i.map(r=>e.jsx("div",{className:`group relative overflow-hidden rounded-lg border hover:shadow-lg transition-all cursor-pointer ${U==="list"?"flex gap-4 p-4":"aspect-square"}`,onClick:()=>M(r),children:U==="grid"?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:T(r.file_url),alt:r.title,className:"w-full h-full object-cover group-hover:scale-105 transition-transform duration-200",onError:m=>I(m,r)}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsxs("div",{className:"absolute bottom-2 left-2 right-2 text-white",children:[e.jsx("p",{className:"font-medium text-sm truncate",children:r.title}),e.jsxs("p",{className:"text-xs opacity-80",children:["by ",r.uploaded_by_username]})]})}),p.canDelete&&e.jsx(w,{size:"icon",variant:"destructive",className:"absolute top-2 right-2 w-6 h-6 opacity-0 group-hover:opacity-100 transition-opacity",onClick:m=>{m.stopPropagation(),R(r.id)},children:e.jsx(G,{className:"w-3 h-3"})})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-24 h-24 flex-shrink-0",children:e.jsx("img",{src:T(r.file_url),alt:r.title,className:"w-full h-full object-cover rounded",onError:m=>I(m,r)})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"font-medium truncate",children:r.title}),r.description&&e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2 mt-1",children:r.description}),e.jsxs("div",{className:"flex items-center gap-4 mt-2 text-xs text-muted-foreground",children:[e.jsxs("span",{children:["by ",r.uploaded_by_username]}),e.jsx("span",{children:t(r.uploaded_at)}),e.jsxs("span",{children:[r.view_count," views"]})]}),r.tags&&r.tags.length>0&&e.jsxs("div",{className:"flex flex-wrap gap-1 mt-2",children:[r.tags.slice(0,3).map((m,F)=>e.jsx(L,{variant:"outline",className:"text-xs",children:m},F)),r.tags.length>3&&e.jsxs(L,{variant:"outline",className:"text-xs",children:["+",r.tags.length-3]})]})]}),p.canDelete&&e.jsx(w,{size:"icon",variant:"destructive",className:"flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity",onClick:m=>{m.stopPropagation(),R(r.id)},children:e.jsx(G,{className:"w-4 h-4"})})]})},r.id))})]})]}),e.jsx(Se,{open:N,onOpenChange:j,townName:n,onUpload:V,uploading:c,currentPhotoCount:o.length}),e.jsx(De,{photo:C,open:!!C,onOpenChange:r=>!r&&x(null),onDelete:R,onUpdate:H,canEdit:p.canUpload,canDelete:p.canDelete})]})};export{X as C,Ge as D,qe as T};
