import{ay as y,bK as E,r as m,S as N,i as A,s as h,j as e,b3 as $,l as S,m as C,n as q,aV as L,X as O,v as K,ap as Q}from"./index-DUDTAd9W.js";import{S as j}from"./skeleton-Bf6OmHVo.js";import{u as T,S as B}from"./send-n6VBXVLq.js";async function F(s){const{data:a,error:n}=await h.from("messages").select("*").or(`sender_id.eq.${s},receiver_id.eq.${s}`).order("created_at",{ascending:!1});if(n)throw new Error(n.message);return a||[]}async function P(s){const{data:a,error:n}=await h.from("profiles").select("id, full_name, avatar_url").in("id",s);if(n)throw new Error(n.message);return a||[]}const H=()=>{const{user:s}=y(),a=E();s==null||s.id;const n=m.useRef(null),{data:d,isLoading:c}=N({queryKey:["messages",s==null?void 0:s.id],queryFn:()=>s?F(s.id):[],enabled:!!s}),r=A.useMemo(()=>{if(!d||!s)return{partnerIds:[],conversationsMap:new Map};const o=new Map;for(const l of d){const f=l.sender_id===s.id?l.receiver_id:l.sender_id;o.has(f)||o.set(f,l)}return{partnerIds:Array.from(o.keys()),conversationsMap:o}},[d,s]),{data:i,isLoading:x}=N({queryKey:["profiles",r.partnerIds],queryFn:()=>P(r.partnerIds),enabled:r.partnerIds.length>0}),p=A.useMemo(()=>{if(!i||!s)return[];const o=new Map(i.map(l=>[l.id,l]));return Array.from(r.conversationsMap.entries()).map(([l,f])=>({partner:o.get(l)||{id:l},lastMessage:f})).sort((l,f)=>new Date(f.lastMessage.created_at).getTime()-new Date(l.lastMessage.created_at).getTime())},[i,r.conversationsMap,s]);return m.useEffect(()=>{if(!s)return;n.current&&(console.log("Removing existing conversations channel"),h.removeChannel(n.current),n.current=null);const o=`conversations_for_${s.id}_${Date.now()}`;console.log("Creating new conversations channel:",o);const l=h.channel(o);return n.current=l,l.on("postgres_changes",{event:"*",schema:"public",table:"messages"},()=>{console.log("Messages table changed, invalidating conversations"),a.invalidateQueries({queryKey:["messages",s.id]}),a.invalidateQueries({queryKey:["unreadMessages"]})}).subscribe(f=>{console.log("Conversations subscription status:",f)}),()=>{console.log("Cleaning up conversations channel"),n.current&&(h.removeChannel(n.current),n.current=null)}},[s,a]),{conversations:p,isLoading:c||x}},V=({onSelectConversation:s,selectedPartnerId:a})=>{const{conversations:n,isLoading:d}=H(),{user:c}=y();return d?e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsx("div",{className:"p-4 border-b",children:e.jsx("h2",{className:"text-xl font-bold",children:"Messages"})}),[...Array(5)].map((r,i)=>e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(j,{className:"h-12 w-12 rounded-full"}),e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsx(j,{className:"h-4 w-3/4"}),e.jsx(j,{className:"h-4 w-1/2"})]})]},i))]}):n.length===0?e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx("div",{className:"p-4 border-b",children:e.jsx("h2",{className:"text-xl font-bold",children:"Messages"})}),e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsx("p",{className:"text-muted-foreground",children:"No conversations yet."})})]}):e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx("div",{className:"p-4 border-b",children:e.jsx("h2",{className:"text-xl font-bold",children:"Messages"})}),e.jsx($,{className:"flex-1",children:e.jsx("div",{children:n.map(r=>{const i=!r.lastMessage.is_read&&r.lastMessage.receiver_id===(c==null?void 0:c.id);return e.jsxs("div",{className:`flex items-start gap-3 p-3 cursor-pointer hover:bg-muted/50 ${a===r.partner.id?"bg-muted":""}`,onClick:()=>s(r.partner.id),children:[e.jsxs(S,{children:[e.jsx(C,{src:r.partner.avatar_url||void 0}),e.jsx(q,{children:(r.partner.full_name||"??").substring(0,2).toUpperCase()})]}),e.jsxs("div",{className:"flex-1 overflow-hidden",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("p",{className:`font-semibold truncate ${i?"text-primary":""}`,children:r.partner.full_name||"Unknown User"}),e.jsx("p",{className:"text-xs text-muted-foreground flex-shrink-0 ml-2",children:L(new Date(r.lastMessage.created_at),{addSuffix:!0})})]}),e.jsxs("p",{className:`text-sm text-muted-foreground truncate ${i?"font-bold text-foreground":""}`,children:[r.lastMessage.sender_id===(c==null?void 0:c.id)&&"You: ",r.lastMessage.content]})]}),i&&e.jsx("div",{className:"w-2.5 h-2.5 bg-primary rounded-full self-center ml-2 flex-shrink-0"})]},r.partner.id)})})})]})},z=async(s,a)=>{const{data:n,error:d}=await h.from("messages").select("*").or(`and(sender_id.eq.${s},receiver_id.eq.${a}),and(sender_id.eq.${a},receiver_id.eq.${s})`).order("created_at",{ascending:!0});if(d)throw new Error(d.message);return n||[]},W=async(s,a)=>{await h.from("messages").update({is_read:!0}).eq("sender_id",a).eq("receiver_id",s).eq("is_read",!1)},X=s=>{const{user:a}=y(),n=E(),d=["chatConditional",s],c=m.useRef(null),[r,i]=m.useState(!1),[x,p]=m.useState(Date.now());m.useEffect(()=>{if(!a||!s)return;const g=()=>{p(Date.now()),r||(i(!0),console.log("Chat became active - enabling data fetching"))};i(!0),p(Date.now());const v=["mousedown","mousemove","keypress","scroll","touchstart"];v.forEach(b=>{document.addEventListener(b,g,{passive:!0})});const t=setInterval(()=>{const w=Date.now()-x,_=5*60*1e3;w>_&&r&&(i(!1),console.log("Chat became inactive - disabling data fetching"))},5*60*1e3);return()=>{v.forEach(b=>{document.removeEventListener(b,g)}),clearInterval(t)}},[a,s,r,x]);const{data:o,...l}=N({queryKey:d,queryFn:async()=>!a||!s?[]:z(a.id,s),enabled:!!a&&!!s&&r,staleTime:0}),f=T({mutationFn:async g=>{if(!a||!s)throw new Error("User or partner not defined");const{data:v,error:t}=await h.from("messages").insert({sender_id:a.id,receiver_id:s,content:g}).select().single();if(t)throw new Error(t.message);return v},onSuccess:()=>{n.invalidateQueries({queryKey:d})}});return m.useEffect(()=>{a&&s&&r&&(async()=>{const{count:v}=await h.from("messages").select("*",{count:"exact",head:!0}).eq("sender_id",s).eq("receiver_id",a.id).eq("is_read",!1);v&&v>0&&(await W(a.id,s),await n.invalidateQueries({queryKey:["unreadMessages"]}),await n.invalidateQueries({queryKey:["conversations"]}))})()},[a,s,n,r]),m.useEffect(()=>{if(!a||!s||!r){c.current&&(console.log("Removing chat channel - chat inactive"),h.removeChannel(c.current),c.current=null);return}c.current&&(console.log("Removing existing chat channel"),h.removeChannel(c.current),c.current=null);const g=`chat_${a.id}_${s}_${Date.now()}`;console.log("Creating new chat channel:",g);const v=h.channel(g);return c.current=v,v.on("postgres_changes",{event:"*",schema:"public",table:"messages",filter:`or(and(sender_id.eq.${a.id},receiver_id.eq.${s}),and(sender_id.eq.${s},receiver_id.eq.${a.id}))`},t=>{console.log("Real-time message update for chat:",t),n.invalidateQueries({queryKey:d}),n.invalidateQueries({queryKey:["conversations"]}),n.invalidateQueries({queryKey:["messages",a.id]}),n.invalidateQueries({queryKey:["unreadMessages"]})}).subscribe(t=>{t==="SUBSCRIBED"?console.log(`Successfully subscribed to chat channel: ${g}`):(t==="CHANNEL_ERROR"||t==="TIMED_OUT")&&(console.error(`Chat subscription error for ${g}:`,t),setTimeout(()=>{console.log("Attempting to resubscribe..."),n.invalidateQueries({queryKey:d})},1e3))}),()=>{console.log(`Cleaning up chat channel: ${g}`),c.current&&(h.removeChannel(c.current),c.current=null)}},[a,s,n,d,r]),{messages:o||[],sendMessage:f.mutateAsync,isSending:f.isPending,isChatActive:r,...l}},Y=()=>{const{user:s}=y(),[a,n]=m.useState(new Set);return m.useEffect(()=>{if(!s)return;(async()=>{const i=h.channel("online_users");return await i.subscribe(async x=>{x==="SUBSCRIBED"&&await i.track({user_id:s.id,online_at:new Date().toISOString()})}),i.on("presence",{event:"sync"},()=>{const x=i.presenceState(),p=new Set;Object.values(x).forEach(o=>{o.forEach(l=>{l.user_id&&p.add(l.user_id)})}),n(p),console.log("Online users updated:",Array.from(p))}),()=>{h.removeChannel(i)}})()},[s]),{onlineUsers:m.useMemo(()=>Array.from(a),[a]),isUserOnline:r=>a.has(r)}},G=async s=>{const{data:a,error:n}=await h.from("profiles").select("*").eq("id",s).single();if(n)throw new Error(n.message);return a},I=({partnerId:s,currentUser:a})=>{const{messages:n,sendMessage:d,isLoading:c,isSending:r,isChatActive:i}=X(s),[x,p]=m.useState(""),o=m.useRef(null),[l,f]=m.useState(!0),g=m.useRef(n.length),{isUserOnline:v}=Y(),{data:t,isLoading:b}=N({queryKey:["profile",s],queryFn:()=>G(s),enabled:!!s}),w=s?v(s):!1,_=()=>{if(o.current){const u=o.current.querySelector("[data-radix-scroll-area-viewport]");if(u){const{scrollTop:M,scrollHeight:R,clientHeight:U}=u,D=R-M-U<100;f(D)}}};m.useEffect(()=>{if(n.length>g.current&&l&&o.current){const u=o.current.querySelector("[data-radix-scroll-area-viewport]");u&&u.scrollTo({top:u.scrollHeight,behavior:"smooth"})}g.current=n.length},[n,l]),m.useEffect(()=>{if(o.current&&n.length>0){const u=o.current.querySelector("[data-radix-scroll-area-viewport]");u&&u.scrollTo({top:u.scrollHeight})}},[n.length>0]);const k=async u=>{if(u.preventDefault(),!(!x.trim()||!s))try{await d(x),p(""),f(!0)}catch(M){console.error("Failed to send message:",M)}};return s?c||b?e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("header",{className:"p-4 border-b flex items-center gap-3",children:[e.jsx(j,{className:"h-10 w-10 rounded-full"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(j,{className:"h-4 w-24"}),e.jsx(j,{className:"h-3 w-16"})]})]}),e.jsxs("div",{className:"flex-1 p-4 space-y-4",children:[e.jsx(j,{className:"h-10 w-3/4 rounded-lg"}),e.jsx(j,{className:"h-10 w-3/4 rounded-lg ml-auto"}),e.jsx(j,{className:"h-12 w-2/4 rounded-lg"})]}),e.jsx("footer",{className:"p-4 border-t bg-background",children:e.jsx(j,{className:"h-10 w-full rounded-lg"})})]}):e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("header",{className:"p-4 border-b flex items-center gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsxs(S,{children:[e.jsx(C,{src:(t==null?void 0:t.avatar_url)||void 0}),e.jsx(q,{children:((t==null?void 0:t.full_name)||"??").substring(0,2).toUpperCase()})]}),w&&e.jsx("div",{className:"absolute -bottom-0.5 -right-0.5 h-3 w-3 bg-green-500 border-2 border-background rounded-full"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-bold",children:(t==null?void 0:t.full_name)||"Unknown User"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:w?"Online":"Offline"})]})]}),e.jsx($,{className:"flex-1 bg-primary/5",ref:o,children:e.jsx("div",{className:"p-4 space-y-4",onScroll:_,children:n.map(u=>e.jsxs("div",{className:`flex items-end gap-2 ${u.sender_id===a.id?"justify-end":"justify-start"}`,children:[u.sender_id!==a.id&&e.jsxs("div",{className:"relative",children:[e.jsxs(S,{className:"h-8 w-8",children:[e.jsx(C,{src:(t==null?void 0:t.avatar_url)||void 0}),e.jsx(q,{children:((t==null?void 0:t.full_name)||"??").substring(0,2).toUpperCase()})]}),w&&e.jsx("div",{className:"absolute -bottom-0.5 -right-0.5 h-2 w-2 bg-green-500 border border-background rounded-full"})]}),e.jsx("div",{className:`p-3 rounded-lg max-w-xs lg:max-w-md ${u.sender_id===a.id?"bg-primary text-primary-foreground":"bg-card border"}`,children:e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:u.content})})]},u.id))})}),e.jsx("footer",{className:"p-4 border-t bg-background",children:e.jsx("form",{onSubmit:k,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{placeholder:"Type a message...",autoComplete:"off",value:x,onChange:u=>p(u.target.value)}),e.jsxs(K,{size:"icon",type:"submit",disabled:r,children:[e.jsx(B,{className:"w-4 h-4"}),e.jsx("span",{className:"sr-only",children:"Send message"})]})]})})})]}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Welcome to your Inbox!"}),e.jsx("p",{className:"text-muted-foreground",children:"Select a conversation to start chatting."})]})})},ne=()=>{const[s,a]=Q(),{user:n}=y(),[d,c]=m.useState(null);m.useEffect(()=>{const i=s.get("with");i&&c(i)},[s]);const r=i=>{c(i),a({with:i})};return e.jsx("div",{className:"flex flex-col h-[calc(100vh-4rem)] bg-background",children:e.jsxs("main",{className:"flex flex-1 overflow-hidden",children:[e.jsx("div",{className:"hidden md:flex flex-col w-1/3 max-w-sm border-r",children:e.jsx(V,{onSelectConversation:r,selectedPartnerId:d})}),e.jsx("div",{className:"flex-1",children:n&&e.jsx(I,{partnerId:d,currentUser:n})})]})})};export{ne as default};
