import{I as De,c as Ps,r as a,e as _s,g as Es,j as e,P as We,b as Ue,d as Ds,bp as Ms,bq as Is,h as Ve,b2 as zs,Z as V,$ as Z,a0 as X,a1 as Y,a2 as H,aU as $,aH as te,s as I,o as Je,p as Ke,q as Qe,t as es,X as de,b1 as ne,v as D,H as re,a4 as me,br as ue,aT as he,am as xe,az as fe,G as pe,ab as ge,ae as je,a8 as be,bs as ve,aF as E,ay as ie,u as ss,w as U,z as Q,B as J,Y as Me,aO as Ie,aP as ze,aQ as Re,aR as ae,x as Te,y as Le,E as Ze,b3 as Rs,aJ as Ts,aq as Ls,b7 as Fs,bg as as,aD as ts,W as ls,aM as $s,b8 as Os,ba as Hs,F as As}from"./index-BDwxLbfg.js";import{B as le}from"./building-nraDPmQ5.js";import{F as we}from"./flag-B2VYutx4.js";import{C as Ne}from"./coins-C6lwFDE4.js";import{A as ye}from"./anchor-BJGCImXu.js";import{M as Ce,C as Se}from"./mountain-ClUbuGuF.js";import{T as ke}from"./trees-B8pIUZhJ.js";import{T as Pe}from"./target-CRQiVHpG.js";import{H as _e}from"./house-Bzdnho9l.js";import{T as qs}from"./TownProfileModal-wTTCjwjS.js";import{S as ce}from"./square-pen-BbMsOEvb.js";import{S as Bs}from"./save-CBFCkKxY.js";import{R as Us,a as Vs}from"./rotate-ccw-e-uLNNmv.js";import{C as Zs}from"./chevron-left-DazXsnHj.js";import{D as Xs}from"./download-Den2hQ9Q.js";import"./TownPhotoGallery-B9IvuerC.js";import"./external-link-DMGOVlse.js";import"./loader-circle-BQXbm3ye.js";import"./imageStorageService-Bbnc4G-y.js";import"./upload-B5TiAeXb.js";import"./image-CdpHxvLf.js";import"./pen-line-DhrBiHG4.js";import"./list-DgrYmvyF.js";import"./TownProfilePicture-CY--EK_H.js";import"./user-plus-v6PF39qN.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ns=De("EllipsisVertical",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ys=De("ZoomIn",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"11",x2:"11",y1:"8",y2:"14",key:"1vmskp"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Gs=De("ZoomOut",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]]);var Fe="Checkbox",[Ws,Ha]=Ps(Fe),[Js,Ks]=Ws(Fe),rs=a.forwardRef((t,m)=>{const{__scopeCheckbox:c,name:d,checked:p,defaultChecked:i,required:w,disabled:o,value:C="on",onCheckedChange:u,form:g,...N}=t,[h,P]=a.useState(null),x=_s(m,f=>P(f)),S=a.useRef(!1),_=h?g||!!h.closest("form"):!0,[j=!1,n]=Es({prop:p,defaultProp:i,onChange:u}),r=a.useRef(j);return a.useEffect(()=>{const f=h==null?void 0:h.form;if(f){const R=()=>n(r.current);return f.addEventListener("reset",R),()=>f.removeEventListener("reset",R)}},[h,n]),e.jsxs(Js,{scope:c,state:j,disabled:o,children:[e.jsx(We.button,{type:"button",role:"checkbox","aria-checked":ee(j)?"mixed":j,"aria-required":w,"data-state":cs(j),"data-disabled":o?"":void 0,disabled:o,value:C,...N,ref:x,onKeyDown:Ue(t.onKeyDown,f=>{f.key==="Enter"&&f.preventDefault()}),onClick:Ue(t.onClick,f=>{n(R=>ee(R)?!0:!R),_&&(S.current=f.isPropagationStopped(),S.current||f.stopPropagation())})}),_&&e.jsx(Qs,{control:h,bubbles:!S.current,name:d,value:C,checked:j,required:w,disabled:o,form:g,style:{transform:"translateX(-100%)"},defaultChecked:ee(i)?!1:i})]})});rs.displayName=Fe;var is="CheckboxIndicator",os=a.forwardRef((t,m)=>{const{__scopeCheckbox:c,forceMount:d,...p}=t,i=Ks(is,c);return e.jsx(Ds,{present:d||ee(i.state)||i.state===!0,children:e.jsx(We.span,{"data-state":cs(i.state),"data-disabled":i.disabled?"":void 0,...p,ref:m,style:{pointerEvents:"none",...t.style}})})});os.displayName=is;var Qs=t=>{const{control:m,checked:c,bubbles:d=!0,defaultChecked:p,...i}=t,w=a.useRef(null),o=Ms(c),C=Is(m);a.useEffect(()=>{const g=w.current,N=window.HTMLInputElement.prototype,P=Object.getOwnPropertyDescriptor(N,"checked").set;if(o!==c&&P){const x=new Event("click",{bubbles:d});g.indeterminate=ee(c),P.call(g,ee(c)?!1:c),g.dispatchEvent(x)}},[o,c,d]);const u=a.useRef(ee(c)?!1:c);return e.jsx("input",{type:"checkbox","aria-hidden":!0,defaultChecked:p??u.current,...i,tabIndex:-1,ref:w,style:{...t.style,...C,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})};function ee(t){return t==="indeterminate"}function cs(t){return ee(t)?"indeterminate":t?"checked":"unchecked"}var ds=rs,ea=os;const $e=a.forwardRef(({className:t,...m},c)=>e.jsx(ds,{ref:c,className:Ve("peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",t),...m,children:e.jsx(ea,{className:Ve("flex items-center justify-center text-current"),children:e.jsx(zs,{className:"h-4 w-4"})})}));$e.displayName=ds.displayName;const sa=[{value:"regular",label:"Regular Pin",icon:$,description:"Standard map marker"},{value:"town",label:"Town Pin",icon:le,description:"Links to town information"},{value:"lore",label:"Lore Pin",icon:te,description:"Hidden lore and story content"}],ms=({value:t,onValueChange:m})=>e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Pin Category"}),e.jsxs(V,{value:t,onValueChange:m,children:[e.jsx(Z,{children:e.jsx(X,{placeholder:"Select pin category"})}),e.jsx(Y,{children:sa.map(c=>{const d=c.icon;return e.jsx(H,{value:c.value,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(d,{className:"w-4 h-4"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:c.label}),e.jsx("div",{className:"text-xs text-muted-foreground",children:c.description})]})]})},c.value)})})]})]}),us=()=>{const[t,m]=a.useState([]),[c,d]=a.useState([]),[p,i]=a.useState(!0),[w,o]=a.useState(null),C=async()=>{try{i(!0);const{data:u,error:g}=await I.from("nations").select("*").order("name");if(g)throw g;const{data:N,error:h}=await I.from("towns").select("*").order("name");if(h)throw h;const P=await Promise.all((N||[]).map(async x=>{let S=null,_=x.mayor,j=null,n=null;if(x.nation_id)try{const{data:r,error:f}=await I.from("nations").select("name, color, type").eq("id",x.nation_id).single();r&&!f?S=r:console.warn("Could not fetch nation data for town:",x.name)}catch(r){console.warn("Error fetching nation data for town:",x.name,r)}if(x.mayor&&x.mayor.length>20)try{const{data:r,error:f}=await I.from("players").select("name").eq("uuid",x.mayor).single();r&&!f?_=r.name:console.warn("Could not fetch mayor data for town:",x.name)}catch(r){console.warn("Error fetching mayor data for town:",x.name,r)}try{const{data:r,error:f}=await I.from("map_pins").select("x_position, y_position").eq("town_id",x.id).eq("category","town").single();r&&!f&&(j=r.x_position,n=r.y_position)}catch(r){console.warn("Could not fetch coordinates for town:",x.name,r)}return{...x,nation:S,mayor_name:_,location_x:j,location_z:n}}));m(u||[]),d(P||[]),o(null)}catch(u){console.error("Error fetching nations and towns:",u),o(u instanceof Error?u.message:"Failed to fetch data")}finally{i(!1)}};return a.useEffect(()=>{C()},[]),{nations:t,towns:c,loading:p,error:w,refetch:C}},hs=({value:t,onValueChange:m,disabled:c=!1})=>{const{towns:d,loading:p}=us();return p?e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Select Town"}),e.jsx("div",{className:"h-10 bg-muted animate-pulse rounded-md"})]}):e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Select Town"}),e.jsxs(V,{value:t,onValueChange:m,disabled:c,children:[e.jsx(Z,{children:e.jsx(X,{placeholder:"Choose a town..."})}),e.jsx(Y,{children:d.map(i=>{var w;return e.jsx(H,{value:i.name,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{className:"w-4 h-4"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:i.name}),e.jsx("div",{className:"text-xs text-muted-foreground",children:i.is_independent?"Independent":(w=i.nation)==null?void 0:w.name})]})]})},i.id)})})]})]})},Xe=[{value:"pin",label:"Pin",icon:$},{value:"flag",label:"Flag",icon:we},{value:"map",label:"Map Pin",icon:re},{value:"star",label:"Star",icon:me},{value:"alert",label:"Alert",icon:ue},{value:"info",label:"Info",icon:he},{value:"building",label:"Building",icon:le},{value:"eye",label:"Eye",icon:te},{value:"sword",label:"Sword",icon:xe},{value:"shield",label:"Shield",icon:fe},{value:"crown",label:"Crown",icon:pe},{value:"coins",label:"Coins",icon:Ne},{value:"anchor",label:"Anchor",icon:ye},{value:"mountain",label:"Mountain",icon:Ce},{value:"trees",label:"Trees",icon:ke},{value:"flame",label:"Flame",icon:ge},{value:"zap",label:"Lightning",icon:je},{value:"heart",label:"Heart",icon:be},{value:"target",label:"Target",icon:Pe},{value:"compass",label:"Compass",icon:Se},{value:"home",label:"Home",icon:_e},{value:"circle",label:"Circle (Pulsing)",icon:ve}],aa=[{value:"#ef4444",label:"Red"},{value:"#f97316",label:"Orange"},{value:"#eab308",label:"Yellow"},{value:"#22c55e",label:"Green"},{value:"#3b82f6",label:"Blue"},{value:"#8b5cf6",label:"Purple"},{value:"#ec4899",label:"Pink"},{value:"#6b7280",label:"Gray"}],ta=[{value:"small",label:"Small"},{value:"medium",label:"Medium"},{value:"big",label:"Big"}],xs=({pin:t,onClose:m,onUpdate:c})=>{var T;const[d,p]=a.useState(t.title||""),[i,w]=a.useState(t.description||""),[o,C]=a.useState(t.icon),[u,g]=a.useState(t.color),[N,h]=a.useState(t.size||"big"),[P,x]=a.useState(t.category),[S,_]=a.useState(t.town_id||""),[j,n]=a.useState(t.is_hidden),[r,f]=a.useState(!1),R=async v=>{v.preventDefault(),f(!0);try{const z={title:d.trim()||null,description:i.trim()||null,icon:o,color:u,size:N,category:P,is_hidden:j};P==="town"?z.town_id=S||null:z.town_id=null;const{error:y}=await I.from("map_pins").update(z).eq("id",t.id);if(y)throw y;E.success("Pin updated successfully"),c(),m()}catch(z){console.error("Error updating pin:",z),E.error("Failed to update pin")}finally{f(!1)}},A=((T=Xe.find(v=>v.value===o))==null?void 0:T.icon)||$;return e.jsx(Je,{open:!0,onOpenChange:m,children:e.jsxs(Ke,{className:"sm:max-w-md",children:[e.jsx(Qe,{children:e.jsx(es,{children:"Edit Pin"})}),e.jsxs("form",{onSubmit:R,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Title (optional)"}),e.jsx(de,{placeholder:"Pin title...",value:d,onChange:v=>p(v.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Description (optional)"}),e.jsx(ne,{placeholder:"Pin description...",value:i,onChange:v=>w(v.target.value),className:"min-h-[80px]"})]}),e.jsx(ms,{value:P,onValueChange:x}),P==="town"&&e.jsx(hs,{value:S,onValueChange:_}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Icon"}),e.jsxs(V,{value:o,onValueChange:C,children:[e.jsx(Z,{children:e.jsx(X,{})}),e.jsx(Y,{className:"max-h-60",children:Xe.map(v=>{const z=v.icon;return e.jsx(H,{value:v.value,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{className:"w-4 h-4"}),v.label]})},v.value)})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Color"}),e.jsxs(V,{value:u,onValueChange:g,children:[e.jsx(Z,{children:e.jsx(X,{})}),e.jsx(Y,{children:aa.map(v=>e.jsx(H,{value:v.value,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 rounded",style:{backgroundColor:v.value}}),v.label]})},v.value))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Size"}),e.jsxs(V,{value:N,onValueChange:h,children:[e.jsx(Z,{children:e.jsx(X,{})}),e.jsx(Y,{children:ta.map(v=>e.jsx(H,{value:v.value,children:v.label},v.value))})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx($e,{id:"hidden",checked:j,onCheckedChange:v=>n(v===!0)}),e.jsx("label",{htmlFor:"hidden",className:"text-sm font-medium",children:"Hidden Pin (subtle appearance)"})]}),e.jsx("div",{className:"flex items-center gap-4 p-3 bg-muted/50 rounded-lg",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Preview:"}),e.jsxs("div",{className:"relative",children:[e.jsx(A,{className:`${N==="small"?"w-4 h-4":N==="medium"?"w-5 h-5":"w-6 h-6"} ${o==="circle"?"animate-pulse":""}`,style:{color:u}}),o==="circle"&&e.jsx("div",{className:`absolute inset-0 ${N==="small"?"w-4 h-4":N==="medium"?"w-5 h-5":"w-6 h-6"} rounded-full animate-ping opacity-30`,style:{backgroundColor:u}})]})]})}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(D,{type:"button",variant:"outline",onClick:m,disabled:r,className:"flex-1",children:"Cancel"}),e.jsx(D,{type:"submit",disabled:r,className:"flex-1",children:r?"Updating...":"Update Pin"})]})]})]})})},la={pin:$,flag:we,map:re,star:me,alert:ue,info:he,building:le,eye:te,sword:xe,shield:fe,crown:pe,coins:Ne,anchor:ye,mountain:Ce,trees:ke,flame:ge,zap:je,heart:be,target:Pe,compass:Se,home:_e,circle:ve},na=({mapDate:t,zoom:m,viewportPosition:c,imageRef:d,containerRef:p,searchTerm:i,categoryFilter:w,showHiddenPins:o})=>{const[C,u]=a.useState([]),[g,N]=a.useState(null),[h,P]=a.useState(null),[x,S]=a.useState(null),[_,j]=a.useState(!0),{user:n,profile:r}=ie(),{towns:f}=us(),R=ss(),A=(r==null?void 0:r.role)==="admin"||(r==null?void 0:r.role)==="moderator",T=async()=>{try{const{data:s,error:l}=await I.from("map_pins").select(`
          *,
          author:profiles(full_name, role)
        `).eq("map_date",t).order("created_at",{ascending:!0});if(l)throw l;u(s||[])}catch(s){console.error("Error fetching pins:",s),E.error("Failed to load pins")}finally{j(!1)}};a.useEffect(()=>{T();const s=I.channel("map-pins").on("postgres_changes",{event:"*",schema:"public",table:"map_pins",filter:`map_date=eq.${t}`},()=>{T()}).subscribe(l=>{l!=="SUBSCRIBED"&&console.error("Failed to subscribe to pin updates:",l)});return()=>{I.removeChannel(s)}},[t]);const v=s=>{var k;const l=(k=p.current)==null?void 0:k.getBoundingClientRect();if(!l)return{x:0,y:0};const M=s.x_position/100*l.width*m+c.x,L=s.y_position/100*l.height*m+c.y;return{x:M,y:L}},z=async s=>{try{const{error:l}=await I.from("map_pins").delete().eq("id",s);if(l)throw l;E.success("Pin deleted"),N(null)}catch(l){console.error("Error deleting pin:",l),E.error("Failed to delete pin")}},y=s=>{if(s.category==="town"&&s.town_id){const l=f.find(M=>M.id===s.town_id);l?R(`/town/${encodeURIComponent(l.name)}`):E.error("Town details not found")}else N(g===s.id?null:s.id)},q=C.filter(s=>{var l,M,L;if(w!=="all"&&s.category!==w||s.is_hidden&&!o)return!1;if(i){const k=i.toLowerCase(),F=(l=s.title)==null?void 0:l.toLowerCase().includes(k),G=(M=s.description)==null?void 0:M.toLowerCase().includes(k),O=(L=s.author)==null?void 0:L.full_name.toLowerCase().includes(k);if(!F&&!G&&!O)return!1}return!0}),se=s=>{switch(s){case"small":return"w-4 h-4";case"medium":return"w-5 h-5";case"big":return"w-6 h-6";default:return"w-6 h-6"}};return _?null:e.jsxs(e.Fragment,{children:[q.map(s=>{var G,O;const l=v(s),M=g===s.id,L=la[s.icon]||$,k=s.is_hidden?.6:1,F=se(s.size);return e.jsxs("div",{children:[e.jsx("div",{className:"absolute z-10 cursor-pointer transform -translate-x-1/2 -translate-y-1/2",style:{left:l.x,top:l.y,opacity:k},onClick:()=>y(s),children:e.jsxs("div",{className:`relative ${M?"z-20":"z-10"}`,children:[e.jsxs("div",{className:"relative",children:[e.jsx(L,{className:`${F} drop-shadow-lg ${s.icon==="circle"?"animate-pulse":""}`,style:{color:s.color}}),s.icon==="circle"&&e.jsx("div",{className:`absolute inset-0 ${F} rounded-full animate-ping opacity-30`,style:{backgroundColor:s.color}})]}),s.category==="lore"&&e.jsx(te,{className:"w-2 h-2 absolute -top-1 -right-1 text-purple-500"})]})}),M&&s.category!=="town"&&e.jsx("div",{className:"absolute z-30 w-80 max-w-sm",style:{left:Math.min(l.x+20,window.innerWidth-350),top:Math.max(l.y-100,20)},children:e.jsx(U,{className:"shadow-lg border-2",children:e.jsxs(Q,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium text-sm",children:((G=s.author)==null?void 0:G.full_name)||"Staff"}),e.jsx(J,{variant:"secondary",className:"text-xs",children:(O=s.author)==null?void 0:O.role}),e.jsx(J,{variant:"outline",className:`text-xs ${s.category==="town"?"border-blue-500 text-blue-600":s.category==="lore"?"border-purple-500 text-purple-600":"border-gray-500 text-gray-600"}`,children:s.category})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(D,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 hover:bg-gray-100 dark:hover:bg-gray-800",onClick:()=>N(null),children:e.jsx(Me,{className:"w-4 h-4"})}),A&&e.jsxs(Ie,{children:[e.jsx(ze,{asChild:!0,children:e.jsx(D,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",children:e.jsx(ns,{className:"w-4 h-4"})})}),e.jsxs(Re,{align:"end",children:[e.jsxs(ae,{onClick:()=>P(s),children:[e.jsx(ce,{className:"w-4 h-4 mr-2"}),"Edit Pin"]}),e.jsxs(ae,{onClick:()=>z(s.id),className:"text-red-600",children:[e.jsx($,{className:"w-4 h-4 mr-2"}),"Delete Pin"]})]})]})]})]}),s.title&&e.jsx("h4",{className:"font-medium text-sm mb-1",children:s.title}),s.description&&e.jsx("p",{className:"text-sm mb-2",children:s.description}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground",children:[e.jsx("span",{children:new Date(s.created_at).toLocaleDateString()}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(L,{className:"w-3 h-3",style:{color:s.color}}),e.jsx("span",{className:"capitalize",children:s.icon}),s.is_hidden&&e.jsx(J,{variant:"secondary",className:"text-xs ml-1",children:"Hidden"}),e.jsx(J,{variant:"outline",className:"text-xs ml-1",children:s.size==="big"?"Large":s.size==="medium"?"Medium":"Small"})]})]})]})})})]},s.id)}),h&&e.jsx(xs,{pin:h,onClose:()=>P(null),onUpdate:T}),x&&e.jsx(qs,{town:x,isOpen:!!x,onClose:()=>S(null)})]})},Ye=[{value:"pin",label:"Pin",icon:$},{value:"flag",label:"Flag",icon:we},{value:"map",label:"Map Pin",icon:re},{value:"star",label:"Star",icon:me},{value:"alert",label:"Alert",icon:ue},{value:"info",label:"Info",icon:he},{value:"building",label:"Building",icon:le},{value:"eye",label:"Eye",icon:te},{value:"sword",label:"Sword",icon:xe},{value:"shield",label:"Shield",icon:fe},{value:"crown",label:"Crown",icon:pe},{value:"coins",label:"Coins",icon:Ne},{value:"anchor",label:"Anchor",icon:ye},{value:"mountain",label:"Mountain",icon:Ce},{value:"trees",label:"Trees",icon:ke},{value:"flame",label:"Flame",icon:ge},{value:"zap",label:"Lightning",icon:je},{value:"heart",label:"Heart",icon:be},{value:"target",label:"Target",icon:Pe},{value:"compass",label:"Compass",icon:Se},{value:"home",label:"Home",icon:_e},{value:"circle",label:"Circle (Pulsing)",icon:ve}],ra=[{value:"#ef4444",label:"Red"},{value:"#f97316",label:"Orange"},{value:"#eab308",label:"Yellow"},{value:"#22c55e",label:"Green"},{value:"#3b82f6",label:"Blue"},{value:"#8b5cf6",label:"Purple"},{value:"#ec4899",label:"Pink"},{value:"#6b7280",label:"Gray"}],ia=[{value:"small",label:"Small"},{value:"medium",label:"Medium"},{value:"big",label:"Big"}],oa=({mapDate:t,x:m,y:c,onClose:d})=>{var z;const[p,i]=a.useState(""),[w,o]=a.useState(""),[C,u]=a.useState("pin"),[g,N]=a.useState("#ef4444"),[h,P]=a.useState("big"),[x,S]=a.useState("regular"),[_,j]=a.useState(""),[n,r]=a.useState(!1),[f,R]=a.useState(!1),{user:A}=ie(),T=async y=>{if(y.preventDefault(),!A){E.error("You must be logged in to add pins");return}R(!0);try{const q={map_date:t,x_position:m,y_position:c,icon:C,color:g,size:h,title:p.trim()||null,description:w.trim()||null,author_id:A.id,category:x,is_hidden:n};x==="town"&&_&&(q.town_id=_);const{error:se}=await I.from("map_pins").insert(q);if(se)throw se;E.success("Pin added successfully"),d()}catch(q){console.error("Error adding pin:",q),E.error("Failed to add pin")}finally{R(!1)}},v=((z=Ye.find(y=>y.value===C))==null?void 0:z.icon)||$;return e.jsx(Je,{open:!0,onOpenChange:d,children:e.jsxs(Ke,{className:"sm:max-w-md",children:[e.jsx(Qe,{children:e.jsx(es,{children:"Add Pin"})}),e.jsxs("form",{onSubmit:T,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Title (optional)"}),e.jsx(de,{placeholder:"Pin title...",value:p,onChange:y=>i(y.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Description (optional)"}),e.jsx(ne,{placeholder:"Pin description...",value:w,onChange:y=>o(y.target.value),className:"min-h-[80px]"})]}),e.jsx(ms,{value:x,onValueChange:S}),x==="town"&&e.jsx(hs,{value:_,onValueChange:j}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Icon"}),e.jsxs(V,{value:C,onValueChange:u,children:[e.jsx(Z,{children:e.jsx(X,{})}),e.jsx(Y,{className:"max-h-60",children:Ye.map(y=>{const q=y.icon;return e.jsx(H,{value:y.value,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{className:"w-4 h-4"}),y.label]})},y.value)})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Color"}),e.jsxs(V,{value:g,onValueChange:N,children:[e.jsx(Z,{children:e.jsx(X,{})}),e.jsx(Y,{children:ra.map(y=>e.jsx(H,{value:y.value,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 rounded",style:{backgroundColor:y.value}}),y.label]})},y.value))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Size"}),e.jsxs(V,{value:h,onValueChange:P,children:[e.jsx(Z,{children:e.jsx(X,{})}),e.jsx(Y,{children:ia.map(y=>e.jsx(H,{value:y.value,children:y.label},y.value))})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx($e,{id:"hidden",checked:n,onCheckedChange:y=>r(y===!0)}),e.jsx("label",{htmlFor:"hidden",className:"text-sm font-medium",children:"Hidden Pin (subtle appearance)"})]}),e.jsxs("div",{className:"flex items-center gap-4 p-3 bg-muted/50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Preview:"}),e.jsxs("div",{className:"relative",children:[e.jsx(v,{className:`${h==="small"?"w-4 h-4":h==="medium"?"w-5 h-5":"w-6 h-6"} ${C==="circle"?"animate-pulse":""}`,style:{color:g}}),C==="circle"&&e.jsx("div",{className:`absolute inset-0 ${h==="small"?"w-4 h-4":h==="medium"?"w-5 h-5":"w-6 h-6"} rounded-full animate-ping opacity-30`,style:{backgroundColor:g}})]})]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Position: ",m.toFixed(1),"%, ",c.toFixed(1),"%"]})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(D,{type:"button",variant:"outline",onClick:d,disabled:f,className:"flex-1",children:"Cancel"}),e.jsx(D,{type:"submit",disabled:f,className:"flex-1",children:f?"Adding...":"Add Pin"})]})]})]})})},Ge=t=>{switch(t){case"admin":return"bg-red-500 text-white";case"moderator":return"bg-orange-500 text-white";case"editor":return"bg-blue-500 text-white";default:return"bg-gray-500 text-white"}},ca=({mapDate:t})=>{const[m,c]=a.useState([]),[d,p]=a.useState(""),[i,w]=a.useState(null),[o,C]=a.useState(""),[u,g]=a.useState(null),[N,h]=a.useState(""),[P,x]=a.useState(!0),[S,_]=a.useState(!1),{user:j,profile:n}=ie(),r=(n==null?void 0:n.role)==="admin"||(n==null?void 0:n.role)==="moderator",f=async()=>{try{const{data:s,error:l}=await I.from("map_discussions").select(`
          *,
          author:profiles(full_name, role)
        `).eq("map_date",t).is("parent_id",null).order("is_pinned",{ascending:!1}).order("created_at",{ascending:!0});if(l)throw l;const M=await Promise.all((s||[]).map(async L=>{const{data:k,error:F}=await I.from("map_discussions").select(`
              *,
              author:profiles(full_name, role)
            `).eq("parent_id",L.id).order("created_at",{ascending:!0});if(F)throw F;return{...L,replies:k||[]}}));c(M)}catch(s){console.error("Error fetching discussions:",s),E.error("Failed to load discussions")}finally{x(!1)}};a.useEffect(()=>{f();const s=I.channel("map-discussions").on("postgres_changes",{event:"*",schema:"public",table:"map_discussions",filter:`map_date=eq.${t}`},()=>{f()}).subscribe(l=>{l!=="SUBSCRIBED"&&console.error("Failed to subscribe to discussion updates:",l)});return()=>{I.removeChannel(s)}},[t]);const R=async s=>{if(s.preventDefault(),!d.trim()||!j){E.error("Please enter a comment");return}_(!0);try{const{error:l}=await I.from("map_discussions").insert({map_date:t,content:d.trim(),author_id:j.id});if(l)throw l;E.success("Comment added"),p("")}catch(l){console.error("Error adding comment:",l),E.error("Failed to add comment")}finally{_(!1)}},A=async s=>{if(!o.trim()||!j){E.error("Please enter a reply");return}_(!0);try{const{error:l}=await I.from("map_discussions").insert({map_date:t,content:o.trim(),author_id:j.id,parent_id:s});if(l)throw l;E.success("Reply added"),C(""),w(null)}catch(l){console.error("Error adding reply:",l),E.error("Failed to add reply")}finally{_(!1)}},T=async s=>{if(!N.trim()){E.error("Please enter content");return}_(!0);try{const{error:l}=await I.from("map_discussions").update({content:N.trim(),edited_at:new Date().toISOString()}).eq("id",s);if(l)throw l;E.success("Comment updated"),g(null),h("")}catch(l){console.error("Error updating comment:",l),E.error("Failed to update comment")}finally{_(!1)}},v=async s=>{try{const{error:l}=await I.from("map_discussions").delete().eq("id",s);if(l)throw l;E.success("Comment deleted")}catch(l){console.error("Error deleting comment:",l),E.error("Failed to delete comment")}},z=async(s,l)=>{try{const{error:M}=await I.from("map_discussions").update({is_pinned:!l}).eq("id",s);if(M)throw M;E.success(l?"Comment unpinned":"Comment pinned")}catch(M){console.error("Error updating comment:",M),E.error("Failed to update comment")}},y=s=>{g(s.id),h(s.content)},q=()=>{g(null),h("")},se=s=>{if(!j||j.id!==s.author_id)return!1;const l=new Date(s.created_at),M=new Date(Date.now()-60*60*1e3);return l>M};return e.jsxs("div",{className:"w-96 border-l bg-background flex flex-col",children:[e.jsx(U,{className:"m-4 mb-2 flex-shrink-0",children:e.jsx(Te,{className:"pb-3",children:e.jsxs(Le,{className:"flex items-center text-lg",children:[e.jsx(Ze,{className:"w-5 h-5 mr-2"}),"Discussion"]})})}),e.jsx(Rs,{className:"flex-1 px-4",children:P?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-primary"})}):e.jsx("div",{className:"space-y-4 pb-4",children:m.map(s=>{var l,M,L;return e.jsx(U,{className:s.is_pinned?"border-yellow-500":"",children:e.jsxs(Q,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium text-sm",children:((l=s.author)==null?void 0:l.full_name)||"Anonymous"}),e.jsx(J,{className:`text-xs ${Ge(((M=s.author)==null?void 0:M.role)||"member")}`,children:(L=s.author)==null?void 0:L.role}),s.is_pinned&&e.jsx($,{className:"w-3 h-3 text-yellow-500"})]}),e.jsxs(Ie,{children:[e.jsx(ze,{asChild:!0,children:e.jsx(D,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",children:e.jsx(ns,{className:"w-4 h-4"})})}),e.jsxs(Re,{align:"end",children:[se(s)&&e.jsxs(ae,{onClick:()=>y(s),children:[e.jsx(ce,{className:"w-4 h-4 mr-2"}),"Edit"]}),r&&e.jsxs(ae,{onClick:()=>z(s.id,s.is_pinned),children:[e.jsx($,{className:"w-4 h-4 mr-2"}),s.is_pinned?"Unpin":"Pin"," Comment"]}),((j==null?void 0:j.id)===s.author_id||r)&&e.jsxs(ae,{onClick:()=>v(s.id),className:"text-red-600",children:[e.jsx(Ze,{className:"w-4 h-4 mr-2"}),"Delete"]})]})]})]}),u===s.id?e.jsxs("div",{className:"space-y-2",children:[e.jsx(ne,{value:N,onChange:k=>h(k.target.value),className:"min-h-[60px] text-sm"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(D,{size:"sm",onClick:()=>T(s.id),disabled:S,children:[e.jsx(Bs,{className:"w-3 h-3 mr-1"}),"Save"]}),e.jsxs(D,{variant:"outline",size:"sm",onClick:q,children:[e.jsx(Me,{className:"w-3 h-3 mr-1"}),"Cancel"]})]})]}):e.jsx("p",{className:"text-sm mb-3",children:s.content}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground",children:[e.jsxs("div",{children:[e.jsx("span",{children:new Date(s.created_at).toLocaleDateString()}),s.edited_at&&e.jsx("span",{className:"ml-2 text-muted-foreground",children:"(edited)"})]}),e.jsxs(D,{variant:"ghost",size:"sm",className:"h-6 text-xs",onClick:()=>w(i===s.id?null:s.id),children:[e.jsx(Us,{className:"w-3 h-3 mr-1"}),"Reply"]})]}),i===s.id&&j&&e.jsxs("div",{className:"mt-3 pt-3 border-t",children:[e.jsx(ne,{placeholder:"Write a reply...",value:o,onChange:k=>C(k.target.value),className:"min-h-[60px] text-sm"}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsx(D,{size:"sm",onClick:()=>A(s.id),disabled:S||!o.trim(),children:"Reply"}),e.jsx(D,{variant:"outline",size:"sm",onClick:()=>{w(null),C("")},children:"Cancel"})]})]}),s.replies&&s.replies.length>0&&e.jsx("div",{className:"mt-3 space-y-3 border-t pt-3",children:s.replies.map(k=>{var F,G,O;return e.jsxs("div",{className:"pl-3 border-l-2 border-muted",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-medium text-xs",children:((F=k.author)==null?void 0:F.full_name)||"Anonymous"}),e.jsx(J,{className:`text-xs ${Ge(((G=k.author)==null?void 0:G.role)||"member")}`,children:(O=k.author)==null?void 0:O.role}),e.jsx("span",{className:"text-xs text-muted-foreground",children:new Date(k.created_at).toLocaleDateString()}),k.edited_at&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"(edited)"})]}),e.jsx("p",{className:"text-xs",children:k.content})]},k.id)})})]})},s.id)})})}),j&&e.jsx(U,{className:"m-4 mt-2 flex-shrink-0",children:e.jsx(Q,{className:"p-4",children:e.jsxs("form",{onSubmit:R,className:"space-y-3",children:[e.jsx(ne,{placeholder:"Share your thoughts about this map...",value:d,onChange:s=>p(s.target.value),className:"min-h-[80px]"}),e.jsxs(D,{type:"submit",className:"w-full",disabled:S||!d.trim(),children:[e.jsx(Ts,{className:"w-4 h-4 mr-2"}),S?"Adding...":"Add Comment"]})]})})}),!j&&e.jsx(U,{className:"m-4 mt-2 flex-shrink-0",children:e.jsx(Q,{className:"p-4 text-center",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Please log in to participate in discussions"})})})]})},da=({availableDates:t,currentDate:m,onDateChange:c})=>{var w;const d=t.findIndex(o=>o.value===m),p=()=>{d<t.length-1&&c(t[d+1].value)},i=()=>{d>0&&c(t[d-1].value)};return e.jsxs("div",{className:"bg-background/95 backdrop-blur-sm border rounded-lg p-3 mx-4 mb-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(D,{variant:"outline",size:"sm",onClick:p,disabled:d>=t.length-1,children:[e.jsx(Zs,{className:"w-4 h-4 mr-1"}),"Earlier"]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-sm font-medium",children:(w=t[d])==null?void 0:w.label}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[d+1," of ",t.length]})]}),e.jsxs(D,{variant:"outline",size:"sm",onClick:i,disabled:d<=0,children:["Later",e.jsx(Ls,{className:"w-4 h-4 ml-1"})]})]}),e.jsx("div",{className:"mt-3 w-full bg-muted rounded-full h-2",children:e.jsx("div",{className:"bg-primary h-2 rounded-full transition-all duration-300",style:{width:`${(t.length-d-1)/(t.length-1)*100}%`}})})]})},ma=({zoom:t,onZoomIn:m,onZoomOut:c,onReset:d,onExport:p,searchTerm:i,onSearchChange:w,categoryFilter:o,onCategoryFilterChange:C,showGrid:u,onToggleGrid:g,showPins:N,onTogglePins:h})=>{const[P,x]=a.useState(!1);return e.jsxs("div",{className:"absolute top-4 right-4 z-20 space-y-2",children:[e.jsx(U,{className:"shadow-lg",children:e.jsx(Q,{className:"p-2",children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx(D,{variant:"outline",size:"sm",onClick:m,children:e.jsx(Ys,{className:"w-4 h-4"})}),e.jsx(D,{variant:"outline",size:"sm",onClick:c,children:e.jsx(Gs,{className:"w-4 h-4"})}),e.jsx(D,{variant:"outline",size:"sm",onClick:d,children:e.jsx(Vs,{className:"w-4 h-4"})})]})})}),e.jsx(U,{className:"shadow-lg",children:e.jsxs(Q,{className:"p-2",children:[e.jsxs(D,{variant:"outline",size:"sm",onClick:()=>x(!P),className:"w-full mb-2",children:[e.jsx(Fs,{className:"w-4 h-4 mr-2"}),"Controls",P?e.jsx(as,{className:"w-4 h-4 ml-2"}):e.jsx(ts,{className:"w-4 h-4 ml-2"})]}),P&&e.jsxs("div",{className:"space-y-3 w-64",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Search Pins"}),e.jsxs("div",{className:"relative mt-1",children:[e.jsx(ls,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 w-3 h-3 text-muted-foreground"}),e.jsx(de,{placeholder:"Search...",value:i,onChange:S=>w(S.target.value),className:"pl-7 h-8 text-sm"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Category"}),e.jsxs(V,{value:o,onValueChange:C,children:[e.jsx(Z,{className:"h-8 text-sm mt-1",children:e.jsx(X,{})}),e.jsxs(Y,{children:[e.jsx(H,{value:"all",children:"All Categories"}),e.jsx(H,{value:"regular",children:"Regular"}),e.jsx(H,{value:"town",children:"Towns"}),e.jsx(H,{value:"lore",children:"Lore"})]})]})]}),e.jsx("div",{className:"flex gap-1 mb-2",children:e.jsxs(D,{variant:u?"default":"outline",size:"sm",onClick:g,className:"w-full",children:[e.jsx($s,{className:"w-3 h-3 mr-1"}),"Grid"]})}),e.jsxs(D,{variant:N?"default":"outline",size:"sm",onClick:h,className:"w-full",children:[e.jsx(re,{className:"w-3 h-3 mr-1"}),N?"Hide Pins":"Show Pins"]}),e.jsxs(D,{variant:"outline",size:"sm",onClick:p,className:"w-full",children:[e.jsx(Xs,{className:"w-4 h-4 mr-2"}),"Export Map"]}),e.jsxs("div",{className:"text-xs text-center text-muted-foreground",children:["Zoom: ",Math.round(t*100),"%"]})]})]})})]})},ua={pin:$,flag:we,map:re,star:me,alert:ue,info:he,building:le,eye:te,sword:xe,shield:fe,crown:pe,coins:Ne,anchor:ye,mountain:Ce,trees:ke,flame:ge,zap:je,heart:be,target:Pe,compass:Se,home:_e,circle:ve},ha=({mapDate:t,onPinUpdate:m})=>{const[c,d]=a.useState([]),[p,i]=a.useState(""),[w,o]=a.useState(null),[C,u]=a.useState(!0),[g,N]=a.useState(!1),{profile:h}=ie(),P=(h==null?void 0:h.role)==="admin"||(h==null?void 0:h.role)==="moderator",x=async()=>{try{const{data:n,error:r}=await I.from("map_pins").select(`
          *,
          author:profiles(full_name, role)
        `).eq("map_date",t).order("created_at",{ascending:!1});if(r)throw r;d(n||[])}catch(n){console.error("Error fetching pins:",n),E.error("Failed to load pins")}finally{u(!1)}};a.useEffect(()=>{x()},[t]);const S=async n=>{try{const{error:r}=await I.from("map_pins").delete().eq("id",n);if(r)throw r;E.success("Pin deleted"),x(),m()}catch(r){console.error("Error deleting pin:",r),E.error("Failed to delete pin")}},_=c.filter(n=>{var T,v,z;if(!p)return!0;const r=p.toLowerCase(),f=(T=n.title)==null?void 0:T.toLowerCase().includes(r),R=(v=n.description)==null?void 0:v.toLowerCase().includes(r),A=(z=n.author)==null?void 0:z.full_name.toLowerCase().includes(r);return f||R||A}),j=n=>{switch(n){case"small":return"S";case"medium":return"M";case"big":return"L";default:return"L"}};return C?e.jsx(U,{children:e.jsx(Q,{className:"p-4",children:e.jsx("div",{className:"animate-pulse space-y-3",children:[1,2,3].map(n=>e.jsx("div",{className:"h-16 bg-muted rounded"},n))})})}):e.jsxs(e.Fragment,{children:[e.jsxs(U,{children:[e.jsxs(Te,{className:"pb-2",children:[e.jsx(Le,{className:"flex items-center justify-between",children:e.jsxs(D,{variant:"ghost",onClick:()=>N(!g),className:"flex items-center gap-2 p-0 h-auto hover:bg-transparent",children:[e.jsxs("span",{children:["Map Pins (",_.length,")"]}),g?e.jsx(as,{className:"w-4 h-4"}):e.jsx(ts,{className:"w-4 h-4"})]})}),g&&e.jsxs("div",{className:"relative",children:[e.jsx(ls,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx(de,{placeholder:"Search pins...",value:p,onChange:n=>i(n.target.value),className:"pl-9"})]})]}),g&&e.jsx(Q,{className:"p-0",children:e.jsx("div",{className:"max-h-96 overflow-y-auto",children:_.length===0?e.jsx("div",{className:"p-4 text-center text-muted-foreground",children:p?"No pins match your search":"No pins on this map"}):e.jsx("div",{className:"space-y-1",children:_.map(n=>{var f;const r=ua[n.icon]||$;return e.jsxs("div",{className:"flex items-center justify-between p-3 hover:bg-muted/50 border-b last:border-b-0",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[e.jsxs("div",{className:"relative",children:[e.jsx(r,{className:`w-5 h-5 ${n.icon==="circle"?"animate-pulse":""}`,style:{color:n.color}}),n.icon==="circle"&&e.jsx("div",{className:"absolute inset-0 w-5 h-5 rounded-full animate-ping opacity-30",style:{backgroundColor:n.color}}),e.jsx(J,{variant:"secondary",className:"absolute -top-1 -right-1 text-xs h-4 w-4 p-0 flex items-center justify-center",children:j(n.size)})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium text-sm truncate",children:n.title||"Untitled Pin"}),e.jsx(J,{variant:"outline",className:`text-xs ${n.category==="town"?"border-blue-500 text-blue-600":n.category==="lore"?"border-purple-500 text-purple-600":"border-gray-500 text-gray-600"}`,children:n.category}),n.is_hidden&&e.jsx(J,{variant:"secondary",className:"text-xs",children:"Hidden"})]}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:n.description||"No description"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["by ",(f=n.author)==null?void 0:f.full_name," • ",new Date(n.created_at).toLocaleDateString()]})]})]}),P&&e.jsxs(Ie,{children:[e.jsx(ze,{asChild:!0,children:e.jsx(D,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0",children:e.jsx(ce,{className:"w-4 h-4"})})}),e.jsxs(Re,{align:"end",children:[e.jsxs(ae,{onClick:()=>o(n),children:[e.jsx(ce,{className:"w-4 h-4 mr-2"}),"Edit Pin"]}),e.jsxs(ae,{onClick:()=>S(n.id),className:"text-red-600",children:[e.jsx(Os,{className:"w-4 h-4 mr-2"}),"Delete Pin"]})]})]})]},n.id)})})})})]}),w&&e.jsx(xs,{pin:w,onClose:()=>o(null),onUpdate:()=>{x(),m()}})]})},xa=()=>{const t=[{value:"2025-04-20",label:"April 20, 2025",file:"2025-04-20.jpg"},{value:"2024-02-24",label:"February 24, 2024",file:"2024-02-24.png"},{value:"2024-01-06",label:"January 6, 2024",file:"2024-01-06.png"},{value:"2023-12-21",label:"December 21, 2023",file:"2023-12-21.jpg"},{value:"2023-11-12",label:"November 12, 2023",file:"2023-11-12.png"},{value:"2023-10-29",label:"October 29, 2023",file:"2023-10-29.png"},{value:"2023-10-10",label:"October 10, 2023",file:"2023-10-10.png"},{value:"2023-10-08",label:"October 8, 2023",file:"2023-10-08.png"},{value:"2023-10-02",label:"October 2, 2023",file:"2023-10-02.png"},{value:"2023-10-01",label:"October 1, 2023",file:"2023-10-01.png"}],{mapDate:m}=Hs(),c=ss(),{user:d,profile:p}=ie(),[i,w]=a.useState(m||t[0].value),[o,C]=a.useState(1),[u,g]=a.useState({x:0,y:0}),[N,h]=a.useState(!1),[P,x]=a.useState({x:0,y:0}),[S,_]=a.useState(!1),[j,n]=a.useState(null),[r,f]=a.useState(!1),[R,A]=a.useState(""),[T,v]=a.useState("all"),[z,y]=a.useState(!1),[q,se]=a.useState(!0),[s,l]=a.useState(!0),[M,L]=a.useState(0),k=a.useRef(null),F=a.useRef(null),G=a.useRef(null),O=t.find(b=>b.value===i),Ee=(p==null?void 0:p.role)==="admin"||(p==null?void 0:p.role)==="moderator";a.useEffect(()=>{m!==i&&c(`/map/${i}`,{replace:!0})},[i,m,c]),a.useEffect(()=>{m&&t.find(b=>b.value===m)&&w(m)},[m]);const fs=a.useCallback(()=>{C(b=>Math.min(b*1.5,5))},[]),ps=a.useCallback(()=>{C(b=>Math.max(b/1.5,.5))},[]),gs=a.useCallback(()=>{C(1),g({x:0,y:0})},[]),js=a.useCallback(b=>{S||(h(!0),x({x:b.clientX-u.x,y:b.clientY-u.y}))},[u,S]),bs=a.useCallback(b=>{N&&g({x:b.clientX-P.x,y:b.clientY-P.y})},[N,P]),Oe=a.useCallback(()=>{h(!1)},[]),vs=a.useCallback(b=>{var Be;b.preventDefault(),b.stopPropagation();const B=(Be=k.current)==null?void 0:Be.getBoundingClientRect();if(!B)return;const W=b.clientX-B.left,K=b.clientY-B.top,oe=b.deltaY>0?.9:1.1,Ae=Math.min(Math.max(o*oe,.5),5),qe=Ae/o,Ss=W-(W-u.x)*qe,ks=K-(K-u.y)*qe;C(Ae),g({x:Ss,y:ks})},[o,u]),ws=a.useCallback(b=>{var oe;if(!S||!d||!Ee)return;const B=(oe=k.current)==null?void 0:oe.getBoundingClientRect();if(!B)return;const W=(b.clientX-B.left-u.x)/o/B.width*100,K=(b.clientY-B.top-u.y)/o/B.height*100;n({x:W,y:K}),_(!1)},[S,d,Ee,u,o]),Ns=a.useCallback(()=>{f(!0)},[]),He=b=>{w(b),g({x:0,y:0}),C(1),f(!1)},ys=a.useCallback(()=>{if(!k.current||!F.current)return;const b=document.createElement("canvas"),B=b.getContext("2d");if(!B)return;const W=k.current.getBoundingClientRect();b.width=W.width,b.height=W.height,B.drawImage(F.current,u.x,u.y,W.width*o,W.height*o);const K=document.createElement("a");K.download=`political-map-${i}.png`,K.href=b.toDataURL(),K.click()},[i,u,o]),Cs=()=>{L(b=>b+1)};return e.jsxs("div",{className:"h-full flex",children:[e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsx(U,{className:"m-4 mb-2",children:e.jsx(Te,{className:"pb-3",children:e.jsxs(Le,{className:"flex items-center justify-between text-lg",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(As,{className:"w-5 h-5 mr-2"}),"Political Map Timeline"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(V,{value:i,onValueChange:He,children:[e.jsx(Z,{className:"w-64",children:e.jsx(X,{placeholder:"Select a date"})}),e.jsx(Y,{children:t.map(b=>e.jsx(H,{value:b.value,children:b.label},b.value))})]}),Ee&&e.jsxs(D,{variant:S?"default":"outline",size:"sm",onClick:()=>_(!S),children:[e.jsx($,{className:"w-4 h-4 mr-1"}),"Add Pin"]})]})]})})}),e.jsx(da,{availableDates:t,currentDate:i,onDateChange:He}),e.jsxs("div",{className:"flex-1 m-4 mt-2 relative",children:[e.jsxs("div",{ref:k,className:"w-full h-full relative bg-muted/20 rounded-lg overflow-hidden",onMouseDown:js,onMouseMove:bs,onMouseUp:Oe,onMouseLeave:Oe,onWheel:vs,onClick:ws,style:{cursor:S?"crosshair":N?"grabbing":"grab"},children:[S&&e.jsx("div",{className:"absolute top-4 left-4 z-20 bg-background/90 backdrop-blur-sm rounded-lg px-3 py-2 border",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx($,{className:"w-4 h-4"}),e.jsx("span",{children:"Click on the map to add a pin"}),e.jsx(D,{variant:"ghost",size:"sm",onClick:()=>_(!1),className:"h-6 w-6 p-0",children:e.jsx(Me,{className:"w-3 h-3"})})]})}),e.jsx("div",{ref:G,className:"absolute inset-0",style:{transform:`translate(${u.x}px, ${u.y}px) scale(${o})`,transformOrigin:"0 0",transition:N?"none":"transform 0.2s ease-out"},children:O&&e.jsxs(e.Fragment,{children:[!r&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-muted/50",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}),e.jsx("img",{ref:F,src:`/lovable-uploads/political-map/${O.file}`,alt:`Political map from ${O.label}`,className:"w-full h-full object-contain",onLoad:Ns,draggable:!1}),z&&r&&e.jsx("div",{className:"absolute inset-0 pointer-events-none",children:e.jsxs("svg",{className:"w-full h-full",style:{opacity:.3},children:[e.jsx("defs",{children:e.jsx("pattern",{id:"grid",width:"50",height:"50",patternUnits:"userSpaceOnUse",children:e.jsx("path",{d:"M 50 0 L 0 0 0 50",fill:"none",stroke:"currentColor",strokeWidth:"1"})})}),e.jsx("rect",{width:"100%",height:"100%",fill:"url(#grid)"})]})})]})}),r&&s&&e.jsx(na,{mapDate:i,zoom:o,viewportPosition:u,imageRef:F,containerRef:k,searchTerm:R,categoryFilter:T,showHiddenPins:q}),O&&e.jsx("div",{className:"absolute bottom-4 left-4 bg-background/90 backdrop-blur-sm rounded-lg px-3 py-2 border",children:e.jsx("p",{className:"text-sm font-medium",children:O.label})})]}),e.jsx(ma,{zoom:o,onZoomIn:fs,onZoomOut:ps,onReset:gs,onExport:ys,searchTerm:R,onSearchChange:A,categoryFilter:T,onCategoryFilterChange:v,showGrid:z,onToggleGrid:()=>y(!z),showPins:s,onTogglePins:()=>l(!s)})]})]}),e.jsx("div",{className:"w-80 border-l bg-background",children:e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsx("div",{className:"flex-1 overflow-hidden",children:e.jsx(ca,{mapDate:i})}),e.jsx("div",{className:"border-t",children:e.jsx(ha,{mapDate:i,onPinUpdate:Cs})})]})}),j&&e.jsx(oa,{mapDate:i,x:j.x,y:j.y,onClose:()=>n(null)})]})},Aa=()=>e.jsx("div",{className:"h-[calc(100vh-4rem)]",children:e.jsx(xa,{})});export{Aa as default};
